# Configuration Guide

This document describes all configurable values in the static-site infrastructure project and how to customize them for your deployment.

## Table of Contents

- [Overview](#overview)
- [Configuration Hierarchy](#configuration-hierarchy)
- [GitHub Repository Variables](#github-repository-variables)
- [Local Configuration](#local-configuration)
- [Forking Instructions](#forking-instructions)
- [Policy Templates](#policy-templates)

## Overview

The project uses a **single source of truth** configuration system with the following principles:

1. **GitHub Repository Variables** (highest priority) - Used by CI/CD workflows
2. **Hardcoded Defaults** in `scripts/config.sh` - Used for local execution
3. **Environment Variable Overrides** - Optional for custom local setups

This design ensures:
- ✅ No environment variables required for local scripts to work
- ✅ Easy forking - just update GitHub repository variables
- ✅ Backward compatibility with existing deployments
- ✅ Clear separation between CI/CD and local configuration

## Configuration Hierarchy

```
┌─────────────────────────────────────┐
│   GitHub Repository Variables       │  ← Highest Priority (CI/CD)
│   Set via GitHub UI or gh CLI       │
└─────────────────────────────────────┘
             ↓ (overrides)
┌─────────────────────────────────────┐
│   Environment Variables (optional)  │  ← Optional Local Override
│   export VAR_NAME=value              │
└─────────────────────────────────────┘
             ↓ (overrides)
┌─────────────────────────────────────┐
│   Hardcoded Defaults                │  ← Fallback (scripts/config.sh)
│   readonly VAR="${VAR:-default}"    │
└─────────────────────────────────────┘
```

## GitHub Repository Variables

These variables should be configured in your GitHub repository for CI/CD workflows to function properly.

### Setting Repository Variables

**Via GitHub UI:**
```
https://github.com/OWNER/REPO/settings/variables/actions
```

**Via GitHub CLI:**
```bash
gh variable set VARIABLE_NAME --body "value"
```

**Via Bootstrap Script:**
```bash
cd scripts/bootstrap
./configure-github.sh
```

### Required Variables

#### Project Identity

| Variable | Description | Example | Notes |
|----------|-------------|---------|-------|
| `PROJECT_NAME` | Full project name for globally unique resources | `celtikill-static-site` | Set as repository variable |
| `PROJECT_SHORT_NAME` | Short name for resource naming | `static-site` | Set as repository variable |
| `EXTERNAL_ID` | External ID for cross-account IAM roles | `github-actions-static-site` | Set as repository variable |

**Note:** Repository name and owner are automatically provided by GitHub Actions via built-in context variables `github.repository` and `github.repository_owner`. No need to set `GITHUB_REPO` or `GITHUB_OWNER` variables (GitHub doesn't allow variables starting with `GITHUB_`).

#### AWS Configuration

| Variable | Description | Example |
|----------|-------------|---------|
| `MANAGEMENT_ACCOUNT_ID` | AWS Management account ID (12 digits) | `223938610551` |
| `AWS_ACCOUNT_ID_DEV` | Development environment account ID | `822529998967` |
| `AWS_ACCOUNT_ID_STAGING` | Staging environment account ID | `927588814642` |
| `AWS_ACCOUNT_ID_PROD` | Production environment account ID | `546274483801` |
| `AWS_DEFAULT_REGION` | Primary AWS region | `us-east-1` |

#### Infrastructure Tools (Optional)

| Variable | Description | Default |
|----------|-------------|---------|
| `OPENTOFU_VERSION` | OpenTofu/Terraform version | `1.8.4` |
| `DEFAULT_ENVIRONMENT` | Default deployment environment | `dev` |
| `MONTHLY_BUDGET_LIMIT` | Cost alert threshold (USD) | `40` |
| `ALERT_EMAIL_ADDRESSES` | JSON array of alert emails | `["your-email@example.com"]` |

## Local Configuration

For local script execution (outside of GitHub Actions), configuration is read from `scripts/config.sh`.

### Configuration File Location

```bash
scripts/config.sh              # Main configuration file
scripts/bootstrap/accounts.json # Generated by bootstrap (not committed)
```

### Customizing Local Configuration

**Option 1: Edit Hardcoded Defaults** (for permanent changes)
```bash
# Edit scripts/config.sh
readonly GITHUB_REPO="${GITHUB_REPO:-YourOrg/your-repo}"
readonly PROJECT_NAME="${PROJECT_NAME:-yourorg-your-repo}"
readonly AWS_DEFAULT_REGION="${AWS_DEFAULT_REGION:-us-west-2}"
```

**Option 2: Use Environment Variables** (for temporary overrides)
```bash
# One-time override
export GITHUB_REPO="MyOrg/my-repo"
export PROJECT_NAME="myorg-my-repo"
./scripts/bootstrap/bootstrap-foundation.sh

# Or inline
GITHUB_REPO="MyOrg/my-repo" ./scripts/bootstrap/bootstrap-foundation.sh
```

### macOS Compatibility

All scripts are tested for macOS compatibility (Bash 3.x):
- ✅ No Bash 4.x features (like `${var^^}` uppercase expansion)
- ✅ Uses `tr` for case conversion instead of Bash 4.x syntax
- ✅ POSIX-compliant sed commands
- ✅ No GNU-specific command flags

## Forking Instructions

### Quick Fork Setup (Recommended)

1. **Fork the repository** on GitHub

2. **Set Repository Variables:**
   ```bash
   # Clone your fork
   git clone https://github.com/YOUR_ORG/static-site.git
   cd static-site

   # Authenticate with GitHub CLI
   gh auth login

   # Set your project identity
   gh variable set GITHUB_REPO --body "YOUR_ORG/static-site"
   gh variable set GITHUB_OWNER --body "YOUR_ORG"
   gh variable set PROJECT_NAME --body "yourorg-static-site"
   gh variable set PROJECT_SHORT_NAME --body "static-site"
   gh variable set EXTERNAL_ID --body "github-actions-static-site"

   # Set your AWS configuration (replace with your account IDs)
   gh variable set MANAGEMENT_ACCOUNT_ID --body "123456789012"
   gh variable set AWS_ACCOUNT_ID_DEV --body "234567890123"
   gh variable set AWS_ACCOUNT_ID_STAGING --body "345678901234"
   gh variable set AWS_ACCOUNT_ID_PROD --body "456789012345"
   gh variable set AWS_DEFAULT_REGION --body "us-east-1"
   ```

3. **Update local configuration** (optional, for local script execution):
   ```bash
   # Edit scripts/config.sh and update the hardcoded defaults
   vim scripts/config.sh
   ```

4. **Update CODEOWNERS metadata:**
   ```bash
   # Edit .github/CODEOWNERS and update project metadata
   vim .github/CODEOWNERS
   # Change @metadata:project:repository to YOUR_ORG/static-site
   # Change @metadata:tag:Repository to YOUR_ORG/static-site
   ```

5. **Run bootstrap scripts:**
   ```bash
   cd scripts/bootstrap
   ./bootstrap-organization.sh      # Create AWS Organization structure
   ./bootstrap-foundation.sh         # Create OIDC, IAM, and Terraform backends
   ./configure-github.sh             # Verify GitHub configuration
   ```

### Alternative: Manual Configuration

If you prefer to edit files directly instead of using repository variables:

1. **Update `scripts/config.sh`** with your values
2. **Update `.github/CODEOWNERS`** metadata
3. **Update `terraform/foundations/github-oidc/variables.tf`** defaults
4. **Generate policies** from templates:
   ```bash
   ./scripts/generate-policies.sh
   ```

## Policy Templates

Policy files are now template-based for easy customization.

### Template System

- **Template Files:** `policies/*.json.tpl`
- **Generated Examples:** `policies/examples/*.json`
- **Placeholders:** `{GITHUB_REPO}`, `{ACCOUNT_ID}`, `{PROJECT_NAME}`, etc.

### Generating Policies

```bash
# Generate all policies from templates
./scripts/generate-policies.sh

# Generated files will be in: policies/examples/
```

### Template Placeholders

| Placeholder | Description | Source |
|-------------|-------------|--------|
| `{GITHUB_REPO}` | Full repository path | `scripts/config.sh` |
| `{GITHUB_OWNER}` | GitHub organization | `scripts/config.sh` |
| `{PROJECT_NAME}` | Full project name | `scripts/config.sh` |
| `{PROJECT_SHORT_NAME}` | Short project name | `scripts/config.sh` |
| `{EXTERNAL_ID}` | IAM external ID | `scripts/config.sh` |
| `{ACCOUNT_ID}` | AWS account ID | Passed as argument |
| `{AWS_DEFAULT_REGION}` | AWS region | `scripts/config.sh` |
| `{MANAGEMENT_ACCOUNT_ID}` | Management account | `scripts/config.sh` |

### Custom Policy Templates

To create a new policy template:

1. Create `policies/your-policy.json.tpl`
2. Use placeholders like `{GITHUB_REPO}`, `{ACCOUNT_ID}`
3. Run `./scripts/generate-policies.sh`
4. Generated policy appears in `policies/examples/your-policy.json`

## Troubleshooting

### GitHub Actions Not Using Variables

**Problem:** Workflows still use hardcoded values

**Solution:** Ensure repository variables are set and workflows have been updated:
```bash
gh variable list  # Verify variables are set
git pull origin main  # Get latest workflow updates
```

### Local Scripts Failing

**Problem:** Scripts fail with "variable not found"

**Solution:** Verify `scripts/config.sh` is sourced correctly:
```bash
# Check if config.sh exists
ls -la scripts/config.sh

# Verify syntax
bash -n scripts/config.sh

# Check for sourcing issues
grep "source.*config.sh" scripts/**/*.sh
```

### Policy Template Issues

**Problem:** Generated policies have unreplaced placeholders

**Solution:** Run policy generation script:
```bash
./scripts/generate-policies.sh
cat policies/examples/iam-github-actions-oidc-trust.json
```

## Migration from Hardcoded Values

If you're migrating from an older version with hardcoded values:

1. **Set GitHub repository variables** using `scripts/bootstrap/configure-github.sh`
2. **Test workflows** in a feature branch first
3. **Update local config** in `scripts/config.sh` if needed
4. **Regenerate policies** from templates
5. **Update documentation** references to your repository

## Best Practices

1. **Always use repository variables** for CI/CD - don't commit secrets or account IDs
2. **Keep config.sh in sync** - If you update GitHub variables, update config.sh too
3. **Document custom values** - Add comments explaining non-standard configurations
4. **Test in dev first** - Always test configuration changes in dev environment
5. **Use policy templates** - Never edit generated policy files directly

## Support

For issues or questions:
- Check [troubleshooting guide](./troubleshooting.md)
- Review [bootstrap README](../scripts/bootstrap/README.md)
- Open an issue on GitHub

---

**Related Documentation:**
- [Quick Start Guide](../QUICK-START.md)
- [Bootstrap Scripts](../scripts/bootstrap/README.md)
- [Terraform Configuration](../terraform/README.md)
- [CI/CD Workflows](./ci-cd.md)
