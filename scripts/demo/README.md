# Demo Scripts

This directory contains scripts for preparing and executing live demonstrations of the AWS multi-account static site infrastructure.

## Overview

These scripts help presenters prepare for and execute professional technical demos by:
- Validating that bootstrap infrastructure is ready
- Generating presenter reference materials
- Configuring GitHub secrets live during demos
- Providing consistent, repeatable demo workflows

## Scripts

### `capture-bootstrap-outputs.sh`

**Purpose**: Pre-demo validation and reference generation

**When to run**: After bootstrap is complete, before starting the demo

**What it does**:
- Validates that all bootstrap steps completed successfully
- Checks for accounts.json and backend configurations
- Generates `demo-reference.txt` with infrastructure summary
- Creates talking points and key metrics for presenter

**Usage**:
```bash
./scripts/demo/capture-bootstrap-outputs.sh
```

**Output**: Creates `scripts/demo/demo-reference.txt` (local file, never committed)

**Example output validation**:
```
✓ accounts.json found
✓ All account IDs present (4 accounts)
✓ Output directory found
✓ backend-config-dev.hcl exists
✓ backend-config-staging.hcl exists
✓ backend-config-prod.hcl exists
✓ Demo reference file created
```

---

### `configure-github-secrets.sh`

**Purpose**: Live configuration of GitHub secrets and variables

**When to run**: During the demo (typically at minute 30-32)

**What it does**:
- Reads account IDs from local `accounts.json`
- Displays current GitHub configuration
- Sets AWS_ASSUME_ROLE_CENTRAL secret
- Sets all required GitHub variables (account IDs, regions, etc.)
- Verifies configuration completed successfully

**Usage**:
```bash
./scripts/demo/configure-github-secrets.sh
```

**Interactive flow**:
1. Validates prerequisites (gh CLI, jq, accounts.json)
2. Shows current secrets/variables state
3. Prompts for confirmation
4. Configures all secrets and variables
5. Verifies configuration

**What it configures**:

**Secrets:**
- `AWS_ASSUME_ROLE_CENTRAL` - Central OIDC role ARN for cross-account access

**Variables:**
- `AWS_ACCOUNT_ID_MANAGEMENT` - Management account ID
- `AWS_ACCOUNT_ID_DEV` - Development account ID
- `AWS_ACCOUNT_ID_STAGING` - Staging account ID
- `AWS_ACCOUNT_ID_PROD` - Production account ID
- `AWS_DEFAULT_REGION` - Primary AWS region (us-east-1)
- `REPLICA_REGION` - Backup region (us-west-2)
- `OPENTOFU_VERSION` - OpenTofu version (1.6.1)
- `DEFAULT_ENVIRONMENT` - Default deployment target (dev)
- `MONTHLY_BUDGET_LIMIT` - Budget alert threshold ($40)
- `ALERT_EMAIL_ADDRESSES` - Alert email addresses

---

## Local-Only Files

These files are generated by the scripts but **never committed to git**:

```
scripts/demo/
└── demo-reference.txt          # Infrastructure summary for presenter
scripts/bootstrap/
├── accounts.json               # AWS account IDs
└── output/
    ├── backend-config-*.hcl    # Terraform backend configurations
    └── *.log                   # Bootstrap execution logs
```

All these paths are in `.gitignore` to prevent accidental commits of sensitive data.

---

## Demo Workflow

### Pre-Demo Setup (Complete beforehand)

1. **Bootstrap infrastructure**:
   ```bash
   # Create AWS Organization and accounts (~8 minutes)
   ./scripts/bootstrap/bootstrap-organization.sh

   # Create OIDC, roles, and backends (~12 minutes)
   ./scripts/bootstrap/bootstrap-foundation.sh
   ```

2. **Capture outputs for reference**:
   ```bash
   # Generate demo reference materials
   ./scripts/demo/capture-bootstrap-outputs.sh

   # Review the reference file
   cat scripts/demo/demo-reference.txt
   ```

3. **Review demo agenda**:
   ```bash
   # Read the full demo agenda
   cat DEMO_AGENDA.md
   ```

### During Demo (Live execution)

1. **Configure GitHub (minute 30-32)**:
   ```bash
   # Run interactively during demo
   ./scripts/demo/configure-github-secrets.sh
   ```

2. **Create feature branch (minute 32-34)**:
   ```bash
   # Create timestamped feature branch
   git checkout -b feature/demo-$(date +%Y%m%d-%H%M)

   # Make visible change
   echo "<!-- Demo: $(date '+%Y-%m-%d %H:%M:%S') -->" >> src/index.html
   ```

3. **Trigger deployment (minute 34-38)**:
   ```bash
   # Commit and push
   git add src/index.html
   git commit -m "demo: add timestamp $(date +%H:%M)"
   git push origin feature/demo-*

   # Watch deployment in real-time
   gh run watch
   ```

4. **Verify deployment (minute 38-40)**:
   ```bash
   # Get deployment URL from workflow logs or README
   gh run view --log | grep "Website URL"

   # Test the website
   curl -I <website-url>
   ```

---

## Prerequisites

All scripts require:
- **Bash 4.0+**
- **jq** - JSON processor (`brew install jq`)
- **GitHub CLI** - Authenticated (`gh auth login`)
- **AWS CLI** - For infrastructure queries (optional)

---

## Security Considerations

### Account ID Protection

Account IDs are AWS-sensitive information. These scripts:
- ✅ Read from local `accounts.json` (never committed)
- ✅ Display masked account IDs in logs (e.g., `1234****5678`)
- ✅ Generate reference files that are local-only
- ✅ Never expose full account IDs in public repositories

### GitHub Secrets Management

The secrets configuration script:
- ✅ Uses OIDC (no long-lived AWS credentials)
- ✅ Sets secrets via GitHub CLI (encrypted at rest)
- ✅ Verifies configuration without exposing values
- ✅ Provides audit trail via gh CLI authentication

### Best Practices

1. **Never commit**:
   - `accounts.json`
   - `demo-reference.txt`
   - Any `scripts/bootstrap/output/*` files

2. **Always verify**:
   - `.gitignore` includes local files before committing
   - Scripts run with your own credentials (not shared)
   - Account IDs are masked in screen recordings

3. **Clean up after demo**:
   - Consider running destroy scripts after demo
   - Rotate credentials if accidentally exposed
   - Review CloudTrail logs for unexpected activity

---

## Troubleshooting

### "accounts.json not found"

**Cause**: Bootstrap scripts haven't been run yet

**Solution**:
```bash
./scripts/bootstrap/bootstrap-organization.sh
./scripts/bootstrap/bootstrap-foundation.sh
```

---

### "GitHub CLI not authenticated"

**Cause**: Not logged in to GitHub CLI

**Solution**:
```bash
gh auth login
# Follow prompts to authenticate
```

---

### "Backend configs missing"

**Cause**: Foundation bootstrap didn't complete successfully

**Solution**:
```bash
# Check bootstrap logs
ls -la scripts/bootstrap/output/

# Re-run foundation bootstrap
./scripts/bootstrap/bootstrap-foundation.sh
```

---

### "Secret already exists" warning

**Cause**: Secrets were previously configured

**Solution**: This is normal. The script will update existing secrets with new values. No action needed.

---

## Related Documentation

- **[DEMO_AGENDA.md](../../DEMO_AGENDA.md)** - Complete 60-minute demo agenda
- **[DEPLOYMENT.md](../../DEPLOYMENT.md)** - Full deployment guide
- **[docs/secrets-and-variables.md](../../docs/secrets-and-variables.md)** - Detailed secrets documentation
- **[scripts/bootstrap/README.md](../bootstrap/README.md)** - Bootstrap scripts documentation

---

## Contributing

When adding new demo scripts:
1. Follow existing naming conventions (`verb-noun.sh`)
2. Include comprehensive help text
3. Add validation and error handling
4. Update this README with usage documentation
5. Add generated files to `.gitignore` if they contain sensitive data

---

**Note**: These scripts are designed for demonstration purposes. For production deployments, follow the full deployment guide in [DEPLOYMENT.md](../../DEPLOYMENT.md).
