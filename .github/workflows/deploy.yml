name: DEPLOY - Static Website Deployment

on:
  workflow_dispatch:
    inputs:
      test_id:
        description: 'Test ID from TEST workflow (optional - will create new if not provided)'
        required: false
        type: string
      build_id:
        description: 'Build ID to reference (optional - will inherit from TEST)'
        required: false
        type: string
      environment:
        description: 'Target environment for deployment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: dev
      skip_test_check:
        description: 'Skip TEST workflow dependency check'
        required: false
        default: false
        type: boolean
      deploy_infrastructure:
        description: 'Deploy infrastructure changes'
        required: false
        default: true
        type: boolean
      deploy_website:
        description: 'Deploy website content'
        required: false
        default: true
        type: boolean
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
  workflow_run:
    workflows: ["TEST - Policy and Validation"]
    types: [completed]
    branches:
      - main
      - 'feature/*'
      - 'bugfix/*'
      - 'hotfix/*'

# OIDC Authentication Permissions for Production Deployment
# id-token: write - ESSENTIAL: Enables secure OIDC token generation for AWS authentication
# contents: read - Repository access for deployment workflows
# pull-requests: write - Deployment status updates and notifications
permissions:
  id-token: write
  contents: read
  pull-requests: write

concurrency:
  group: static-site-deployment-${{ github.event.inputs.environment || (github.event_name == 'pull_request' && 'staging') || (github.event_name == 'workflow_run' && 'dev') || 'dev' }}
  cancel-in-progress: false

# Only run DEPLOY if TEST workflow completed successfully
# This prevents deployment of untested code and ensures proper BUILD â†’ TEST â†’ DEPLOY flow  
run-name: |
  ${{ 
    github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'success' && 
    format('DEPLOY - Skipped (TEST {0})', github.event.workflow_run.conclusion) || 
    'DEPLOY - Static Website Deployment' 
  }}

jobs:
  # Gate job to validate TEST workflow success before running any deployment
  deploy-gate:
    name: Validate TEST Success
    runs-on: ubuntu-latest
    timeout-minutes: 2
    if: |
      github.event_name != 'workflow_run' || 
      github.event.workflow_run.conclusion == 'success'
    outputs:
      should_run_deployment: ${{ steps.validate.outputs.should_run_deployment }}
      test_status: ${{ steps.validate.outputs.test_status }}
    steps:
      - name: Validate TEST Workflow Success
        id: validate
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            TEST_CONCLUSION="${{ github.event.workflow_run.conclusion }}"
            if [ "$TEST_CONCLUSION" = "success" ]; then
              echo "âœ… TEST workflow completed successfully - proceeding with DEPLOY"
              echo "should_run_deployment=true" >> $GITHUB_OUTPUT
              echo "test_status=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ TEST workflow failed with conclusion: $TEST_CONCLUSION"
              echo "ðŸ›‘ Stopping DEPLOY workflow execution"
              echo "should_run_deployment=false" >> $GITHUB_OUTPUT
              echo "test_status=$TEST_CONCLUSION" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "âœ… Manual trigger or PR - proceeding with DEPLOY"
            echo "should_run_deployment=true" >> $GITHUB_OUTPUT
            echo "test_status=manual" >> $GITHUB_OUTPUT
          fi
  production-authorization:
    name: Production Authorization Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.inputs.environment == 'prod' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    outputs:
      authorized: ${{ steps.check-auth.outputs.authorized }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      
      - name: Check Code Owner Authorization
        id: check-auth
        run: |
          echo "ðŸ” Validating Production Deployment Authorization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get the actor (person triggering the deployment)
          ACTOR="${{ github.actor }}"
          echo "**Requesting User**: $ACTOR" >> $GITHUB_STEP_SUMMARY
          
          # Read CODEOWNERS file to check authorization
          if [ -f ".github/CODEOWNERS" ]; then
            # Extract code owners from CODEOWNERS file (handles different formats)
            CODE_OWNERS=$(grep -E '^(\*|/.github/workflows/)' .github/CODEOWNERS | grep -oE '@[a-zA-Z0-9_-]+' | sort -u || echo "")
            
            echo "**Code Owners**: $CODE_OWNERS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Check if actor is in the code owners list
            if echo "$CODE_OWNERS" | grep -q "@$ACTOR"; then
              echo "âœ… **AUTHORIZED**: $ACTOR is a code owner" >> $GITHUB_STEP_SUMMARY
              echo "Production deployment can proceed" >> $GITHUB_STEP_SUMMARY
              echo "authorized=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ **UNAUTHORIZED**: $ACTOR is not a code owner" >> $GITHUB_STEP_SUMMARY
              echo "Production deployments are restricted to code owners only" >> $GITHUB_STEP_SUMMARY
              echo "** Authorized users**: $CODE_OWNERS" >> $GITHUB_STEP_SUMMARY
              echo "authorized=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "âš ï¸ **WARNING**: No CODEOWNERS file found" >> $GITHUB_STEP_SUMMARY
            echo "Production deployment proceeding without authorization check" >> $GITHUB_STEP_SUMMARY
            echo "authorized=true" >> $GITHUB_OUTPUT
          fi

  deploy-info:
    name: Deployment Information
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [production-authorization]
    if: needs.production-authorization.result == 'success' || needs.production-authorization.result == 'skipped'
    outputs:
      deploy_id: ${{ steps.generate-id.outputs.deploy_id }}
      test_id: ${{ steps.generate-id.outputs.test_id }}
      build_id: ${{ steps.generate-id.outputs.build_id }}
      target_environment: ${{ steps.generate-id.outputs.target_environment }}
      deploy_infrastructure: ${{ steps.generate-id.outputs.deploy_infrastructure }}
      deploy_website: ${{ steps.generate-id.outputs.deploy_website }}
      test_success: ${{ steps.check-test.outputs.test_success }}
      has_tf_changes: ${{ steps.detect-changes.outputs.has_tf_changes }}
      has_content_changes: ${{ steps.detect-changes.outputs.has_content_changes }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0
      - name: Check TEST Status
        id: check-test
        if: github.event_name == 'workflow_run' && github.event.inputs.skip_test_check != 'true'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "TEST workflow failed - cannot proceed with DEPLOY"
            echo "test_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "TEST workflow passed - proceeding with DEPLOY"
          echo "test_success=true" >> $GITHUB_OUTPUT

      - name: Download TEST Artifacts
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          run-id: ${{ github.event.workflow_run.id }}
          merge-multiple: true
        continue-on-error: true

      - name: Generate Deployment ID
        id: generate-id
        run: |
          echo "## ðŸ” DEPLOY Workflow Debug Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Trigger Context" >> $GITHUB_STEP_SUMMARY
          echo "- **Event Name**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY  
          echo "- **Ref Name**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŽ›ï¸ Workflow Inputs" >> $GITHUB_STEP_SUMMARY
          echo "- **test_id**: '${{ github.event.inputs.test_id }}'" >> $GITHUB_STEP_SUMMARY
          echo "- **build_id**: '${{ github.event.inputs.build_id }}'" >> $GITHUB_STEP_SUMMARY
          echo "- **environment**: '${{ github.event.inputs.environment }}'" >> $GITHUB_STEP_SUMMARY
          echo "- **skip_test_check**: '${{ github.event.inputs.skip_test_check }}'" >> $GITHUB_STEP_SUMMARY
          echo "- **deploy_infrastructure**: '${{ github.event.inputs.deploy_infrastructure }}'" >> $GITHUB_STEP_SUMMARY
          echo "- **deploy_website**: '${{ github.event.inputs.deploy_website }}'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "### ðŸ”— Workflow Run Context" >> $GITHUB_STEP_SUMMARY
            echo "- **Triggering Workflow**: ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Triggering Run ID**: ${{ github.event.workflow_run.id }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Conclusion**: ${{ github.event.workflow_run.conclusion }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Head Branch**: ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Head SHA**: ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "### ðŸ”€ Pull Request Context" >> $GITHUB_STEP_SUMMARY  
            echo "- **PR Number**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **PR Title**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Base Branch**: ${{ github.event.pull_request.base.ref }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Head Branch**: ${{ github.event.pull_request.head.ref }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Draft**: ${{ github.event.pull_request.draft }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Secure input handling with validation
          TEST_ID_INPUT='${{ github.event.inputs.test_id }}'
          BUILD_ID_INPUT='${{ github.event.inputs.build_id }}'
          ENV_INPUT='${{ github.event.inputs.environment }}'
          
          # Input validation
          if [ -n "$TEST_ID_INPUT" ]; then
            if [ ${#TEST_ID_INPUT} -gt 100 ]; then
              echo "âŒ ERROR: Test ID too long (max 100 chars)"
              exit 1
            fi
            if [[ ! "$TEST_ID_INPUT" =~ ^[a-zA-Z0-9_-]+$ ]]; then
              echo "âŒ ERROR: Invalid characters in test ID"
              exit 1
            fi
          fi
          
          if [ -n "$BUILD_ID_INPUT" ]; then
            if [ ${#BUILD_ID_INPUT} -gt 100 ]; then
              echo "âŒ ERROR: Build ID too long (max 100 chars)"
              exit 1
            fi
            if [[ ! "$BUILD_ID_INPUT" =~ ^[a-zA-Z0-9_-]+$ ]]; then
              echo "âŒ ERROR: Invalid characters in build ID"
              exit 1
            fi
          fi
          
          # Set validated values
          if [ -n "$TEST_ID_INPUT" ]; then
            TEST_ID="$TEST_ID_INPUT"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            TEST_ID="test-${{ github.event.workflow_run.id }}"
          else
            TEST_ID="test-${{ github.run_id }}-auto"
          fi
          
          if [ -n "$BUILD_ID_INPUT" ]; then
            BUILD_ID="$BUILD_ID_INPUT"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            BUILD_ID=$(find . -name "*test*report*.json" -exec jq -r '.build_id // empty' {} \; | head -1 || echo "build-auto")
            if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "null" ]; then
              BUILD_ID="build-auto"
            fi
          else
            BUILD_ID="build-${{ github.run_id }}-auto"
          fi
          
          echo "### ðŸŽ¯ Environment Resolution Logic" >> $GITHUB_STEP_SUMMARY
          echo "**Available Context:**" >> $GITHUB_STEP_SUMMARY
          echo "- Input environment: '$ENV_INPUT'" >> $GITHUB_STEP_SUMMARY
          echo "- Event name: '${{ github.event_name }}'" >> $GITHUB_STEP_SUMMARY  
          echo "- Default environment var: '${{ vars.DEFAULT_ENVIRONMENT }}'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$ENV_INPUT" ]; then
            TARGET_ENV="$ENV_INPUT"
            echo "âœ… **Environment resolved from workflow input**: $TARGET_ENV" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # PRs always deploy to staging for validation  
            TARGET_ENV="staging"
            echo "âœ… **Environment resolved from PR event**: $TARGET_ENV (PRs always use staging)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event_name }}" = "workflow_run" ] && [[ "${{ github.event.workflow_run.head_branch }}" =~ ^(feature|bugfix|hotfix)/ ]]; then
            # Feature/bugfix/hotfix branches auto-deploy to development after TEST completion
            TARGET_ENV="dev"
            echo "âœ… **Environment resolved from feature branch workflow_run**: $TARGET_ENV (feature branches auto-deploy to development)" >> $GITHUB_STEP_SUMMARY
          elif [ -n "${{ vars.DEFAULT_ENVIRONMENT }}" ]; then
            TARGET_ENV="${{ vars.DEFAULT_ENVIRONMENT }}"
            echo "âœ… **Environment resolved from repository variable**: $TARGET_ENV" >> $GITHUB_STEP_SUMMARY
          else
            TARGET_ENV="dev"
            echo "âœ… **Environment resolved to default**: $TARGET_ENV (no other sources available)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "ðŸŽ¯ **Final target environment**: $TARGET_ENV" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          DEPLOY_INFRASTRUCTURE="${{ github.event.inputs.deploy_infrastructure || 'true' }}"
          DEPLOY_WEBSITE="${{ github.event.inputs.deploy_website || 'true' }}"
          
          echo "### âš™ï¸ Deployment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Infrastructure**: $DEPLOY_INFRASTRUCTURE" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Website**: $DEPLOY_WEBSITE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          DEPLOY_ID="deploy-${{ github.run_id }}-${{ github.run_attempt }}"
          
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          echo "test_id=$TEST_ID" >> $GITHUB_OUTPUT
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "target_environment=$TARGET_ENV" >> $GITHUB_OUTPUT
          echo "deploy_infrastructure=$DEPLOY_INFRASTRUCTURE" >> $GITHUB_OUTPUT
          echo "deploy_website=$DEPLOY_WEBSITE" >> $GITHUB_OUTPUT
          
          echo "### ðŸš€ DEPLOY Phase Configuration Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy ID**: $DEPLOY_ID" >> $GITHUB_STEP_SUMMARY
          echo "**Test ID**: $TEST_ID" >> $GITHUB_STEP_SUMMARY
          echo "**Build ID**: $BUILD_ID" >> $GITHUB_STEP_SUMMARY
          echo "**Target Environment**: $TARGET_ENV" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy Infrastructure**: $DEPLOY_INFRASTRUCTURE" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy Website**: $DEPLOY_WEBSITE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ Expected Workflow Jobs" >> $GITHUB_STEP_SUMMARY
          if [ "$TARGET_ENV" = "prod" ] || [ "$TARGET_ENV" = "production" ]; then
            echo "- âœ… Production Authorization (REQUIRED for prod)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Staging Health Check (validates staging before prod)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$TARGET_ENV" = "staging" ] && [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "- âœ… Development Health Check (validates dev before staging)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$DEPLOY_INFRASTRUCTURE" = "true" ]; then
            echo "- âœ… Deploy Infrastructure (infrastructure changes will be deployed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ Deploy Infrastructure (skipped)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$DEPLOY_WEBSITE" = "true" ]; then
            echo "- âœ… Deploy Website (website content will be deployed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ Deploy Website (skipped)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$TARGET_ENV" = "staging" ]; then
            echo "- âœ… Staging Usability Tests (will run after deployment)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$TARGET_ENV" = "prod" ] || [ "$TARGET_ENV" = "production" ]; then
            echo "- âœ… Production Validation (comprehensive validation for production)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- âœ… Deployment Summary (always runs to provide final status)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Detect Changes
        id: detect-changes
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Analyzing Changes for Deployment Optimization**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get changed files based on trigger type
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # For workflow_run events, get files from the triggering commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
            echo "ðŸ“‹ **Trigger**: workflow_run (analyzing single commit changes)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PR events, compare PR branch with the base branch (main)
            git fetch origin main:main 2>/dev/null || true
            CHANGED_FILES=$(git diff --name-only main...HEAD 2>/dev/null || echo "")
            echo "ðŸ“‹ **Trigger**: pull_request (analyzing PR changes vs main)" >> $GITHUB_STEP_SUMMARY
          else
            # For manual workflow_dispatch or other events, compare with main branch
            git fetch origin main:main 2>/dev/null || true
            CHANGED_FILES=$(git diff --name-only main...HEAD 2>/dev/null || echo "")
            echo "ðŸ“‹ **Trigger**: ${{ github.event_name }} (analyzing branch changes vs main)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "Changed files: $CHANGED_FILES"
          echo "**Changed Files Debug**: \`$CHANGED_FILES\`" >> $GITHUB_STEP_SUMMARY
          
          # Categorize changes
          HAS_TF_CHANGES=0
          HAS_CONTENT_CHANGES=0
          
          if [ -n "$CHANGED_FILES" ]; then
            # Check for infrastructure changes
            if echo "$CHANGED_FILES" | grep -qE '^terraform/.*\.(tf|tfvars)$'; then
              HAS_TF_CHANGES=1
            fi
            
            # Check for content changes
            if echo "$CHANGED_FILES" | grep -qE '^src/'; then
              HAS_CONTENT_CHANGES=1
            fi
          else
            # No changes detected, deploy everything if forced
            if [ "${{ github.event.inputs.deploy_infrastructure }}" = "true" ]; then
              HAS_TF_CHANGES=1
            fi
            if [ "${{ github.event.inputs.deploy_website }}" = "true" ]; then
              HAS_CONTENT_CHANGES=1
            fi
          fi
          
          echo "has_tf_changes=$HAS_TF_CHANGES" >> $GITHUB_OUTPUT
          echo "has_content_changes=$HAS_CONTENT_CHANGES" >> $GITHUB_OUTPUT
          
          echo "**Infrastructure Changes**: $HAS_TF_CHANGES" >> $GITHUB_STEP_SUMMARY
          echo "**Content Changes**: $HAS_CONTENT_CHANGES" >> $GITHUB_STEP_SUMMARY

  staging-health-check:
    name: Validate Staging Health
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: deploy-info
    if: needs.deploy-info.outputs.target_environment == 'prod' || needs.deploy-info.outputs.target_environment == 'production'
    outputs:
      staging_health: ${{ steps.check-staging.outputs.staging_health }}
      staging_deployment_id: ${{ steps.check-staging.outputs.staging_deployment_id }}
    steps:
      - name: Check Staging Environment Health
        id: check-staging
        run: |
          echo "ðŸ­ Checking Staging Environment Health for Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get latest staging deployment status using GitHub API with retries
          echo "ðŸ”„ Attempting to fetch staging deployment status..." >> $GITHUB_STEP_SUMMARY
          
          LATEST_STAGING_DEPLOYMENT=""
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3 to fetch staging deployments..."
            
            LATEST_STAGING_DEPLOYMENT=$(gh api repos/${{ github.repository }}/deployments \
              --paginate 2>/dev/null | jq -r '.[] | select(.environment=="staging") | \
              select(.created_at) | {id: .id, created_at: .created_at, status_url: .statuses_url}' 2>/dev/null | \
              jq -s 'sort_by(.created_at) | reverse | .[0]' 2>/dev/null || echo '{}')
            
            if [ "$LATEST_STAGING_DEPLOYMENT" != "{}" ] && [ "$LATEST_STAGING_DEPLOYMENT" != "null" ]; then
              echo "âœ… Successfully retrieved staging deployment data" >> $GITHUB_STEP_SUMMARY
              break
            fi
            
            if [ $attempt -lt 3 ]; then
              echo "âš ï¸ Attempt $attempt failed, retrying in 5 seconds..." >> $GITHUB_STEP_SUMMARY
              sleep 5
            else
              echo "âŒ All attempts failed to fetch staging deployment data" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "$LATEST_STAGING_DEPLOYMENT" = "{}" ] || [ "$LATEST_STAGING_DEPLOYMENT" = "null" ]; then
            echo "âš ï¸ No staging deployments found - this appears to be a first-time setup" >> $GITHUB_STEP_SUMMARY
            echo "âœ… First-time production deployment allowed (no prior staging validation required)" >> $GITHUB_STEP_SUMMARY
            echo "staging_health=first_time" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          DEPLOYMENT_ID=$(echo "$LATEST_STAGING_DEPLOYMENT" | jq -r '.id')
          STATUS_URL=$(echo "$LATEST_STAGING_DEPLOYMENT" | jq -r '.status_url')
          
          echo "**Staging Deployment ID**: $DEPLOYMENT_ID" >> $GITHUB_STEP_SUMMARY
          
          # Check deployment status with retry logic
          echo "ðŸ”„ Fetching deployment status..." >> $GITHUB_STEP_SUMMARY
          
          DEPLOYMENT_STATUSES=""
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3 to fetch deployment status..."
            
            DEPLOYMENT_STATUSES=$(gh api "$STATUS_URL" 2>/dev/null | jq -r '.[] | select(.state) | \
              {state: .state, created_at: .created_at, description: .description}' 2>/dev/null | \
              jq -s 'sort_by(.created_at) | reverse | .[0]' 2>/dev/null || echo '{}')
            
            if [ "$DEPLOYMENT_STATUSES" != "{}" ] && [ "$DEPLOYMENT_STATUSES" != "null" ]; then
              echo "âœ… Successfully retrieved deployment status" >> $GITHUB_STEP_SUMMARY
              break
            fi
            
            if [ $attempt -lt 3 ]; then
              echo "âš ï¸ Status fetch attempt $attempt failed, retrying..." >> $GITHUB_STEP_SUMMARY
              sleep 3
            else
              echo "âš ï¸ All attempts to fetch status failed - treating as inconclusive" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "$DEPLOYMENT_STATUSES" = "{}" ] || [ "$DEPLOYMENT_STATUSES" = "null" ]; then
            echo "âš ï¸ No deployment status found for staging environment - deployment may be in progress" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Production deployment allowed (staging validation inconclusive but not blocking)" >> $GITHUB_STEP_SUMMARY
            echo "staging_health=inconclusive" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LATEST_STATUS=$(echo "$DEPLOYMENT_STATUSES" | jq -r '.state')
          STATUS_DESC=$(echo "$DEPLOYMENT_STATUSES" | jq -r '.description // "No description"')
          
          echo "**Staging Status**: $LATEST_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "**Status Description**: $STATUS_DESC" >> $GITHUB_STEP_SUMMARY
          
          if [ "$LATEST_STATUS" = "success" ]; then
            echo "âœ… Staging environment is healthy and validated" >> $GITHUB_STEP_SUMMARY
            echo "Production deployment can proceed" >> $GITHUB_STEP_SUMMARY
            echo "staging_health=success" >> $GITHUB_OUTPUT
            echo "staging_deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          else
            echo "âŒ Staging environment is unhealthy (status: $LATEST_STATUS)" >> $GITHUB_STEP_SUMMARY
            echo "Production deployment blocked - staging must pass usability tests first" >> $GITHUB_STEP_SUMMARY
            echo "staging_health=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  development-health-check:
    name: Validate Development Health
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: deploy-info
    if: needs.deploy-info.outputs.target_environment == 'staging' && github.event_name == 'pull_request'
    outputs:
      dev_health: ${{ steps.check-dev.outputs.dev_health }}
      dev_deployment_id: ${{ steps.check-dev.outputs.dev_deployment_id }}
    steps:
      - name: Check Development Environment Health
        id: check-dev
        run: |
          echo "ðŸ¥ Checking Development Environment Health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get latest development deployment status using GitHub API with retries
          echo "ðŸ”„ Attempting to fetch development deployment status..." >> $GITHUB_STEP_SUMMARY
          
          LATEST_DEV_DEPLOYMENT=""
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3 to fetch development deployments..."
            
            LATEST_DEV_DEPLOYMENT=$(gh api repos/${{ github.repository }}/deployments \
              --paginate 2>/dev/null | jq -r '.[] | select(.environment=="development") | \
              select(.created_at) | {id: .id, created_at: .created_at, status_url: .statuses_url}' 2>/dev/null | \
              jq -s 'sort_by(.created_at) | reverse | .[0]' 2>/dev/null || echo '{}')
            
            if [ "$LATEST_DEV_DEPLOYMENT" != "{}" ] && [ "$LATEST_DEV_DEPLOYMENT" != "null" ]; then
              echo "âœ… Successfully retrieved development deployment data" >> $GITHUB_STEP_SUMMARY
              break
            fi
            
            if [ $attempt -lt 3 ]; then
              echo "âš ï¸ Attempt $attempt failed, retrying in 5 seconds..." >> $GITHUB_STEP_SUMMARY
              sleep 5
            else
              echo "âŒ All attempts failed to fetch development deployment data" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "$LATEST_DEV_DEPLOYMENT" = "{}" ] || [ "$LATEST_DEV_DEPLOYMENT" = "null" ]; then
            echo "âš ï¸ No development deployments found - this appears to be a first-time setup" >> $GITHUB_STEP_SUMMARY
            echo "âœ… First-time staging deployment allowed (no prior development validation required)" >> $GITHUB_STEP_SUMMARY
            echo "dev_health=first_time" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          DEPLOYMENT_ID=$(echo "$LATEST_DEV_DEPLOYMENT" | jq -r '.id')
          STATUS_URL=$(echo "$LATEST_DEV_DEPLOYMENT" | jq -r '.status_url')
          
          echo "**Development Deployment ID**: $DEPLOYMENT_ID" >> $GITHUB_STEP_SUMMARY
          
          # Check deployment status with retry logic
          echo "ðŸ”„ Fetching development deployment status..." >> $GITHUB_STEP_SUMMARY
          
          DEPLOYMENT_STATUSES=""
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3 to fetch development deployment status..."
            
            DEPLOYMENT_STATUSES=$(gh api "$STATUS_URL" 2>/dev/null | jq -r '.[] | select(.state) | \
              {state: .state, created_at: .created_at}' 2>/dev/null | \
              jq -s 'sort_by(.created_at) | reverse | .[0]' 2>/dev/null || echo '{}')
            
            if [ "$DEPLOYMENT_STATUSES" != "{}" ] && [ "$DEPLOYMENT_STATUSES" != "null" ]; then
              echo "âœ… Successfully retrieved development deployment status" >> $GITHUB_STEP_SUMMARY
              break
            fi
            
            if [ $attempt -lt 3 ]; then
              echo "âš ï¸ Status fetch attempt $attempt failed, retrying..." >> $GITHUB_STEP_SUMMARY
              sleep 3
            else
              echo "âš ï¸ All attempts to fetch dev status failed - treating as inconclusive" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "$DEPLOYMENT_STATUSES" = "{}" ] || [ "$DEPLOYMENT_STATUSES" = "null" ]; then
            echo "âš ï¸ No deployment status found for development environment - deployment may be in progress" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Staging deployment allowed (development validation inconclusive but not blocking)" >> $GITHUB_STEP_SUMMARY
            echo "dev_health=inconclusive" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LATEST_STATUS=$(echo "$DEPLOYMENT_STATUSES" | jq -r '.state')
          echo "**Development Status**: $LATEST_STATUS" >> $GITHUB_STEP_SUMMARY
          
          if [ "$LATEST_STATUS" = "success" ]; then
            echo "âœ… Development environment is healthy" >> $GITHUB_STEP_SUMMARY
            echo "Staging deployment can proceed" >> $GITHUB_STEP_SUMMARY
            echo "dev_health=success" >> $GITHUB_OUTPUT
            echo "dev_deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          else
            echo "âŒ Development environment is unhealthy (status: $LATEST_STATUS)" >> $GITHUB_STEP_SUMMARY
            echo "Staging deployment blocked" >> $GITHUB_STEP_SUMMARY
            echo "dev_health=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  development-auto-deploy-check:
    name: Development Auto-Deploy Prerequisites
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [deploy-info]
    if: |
      needs.deploy-info.outputs.target_environment == 'dev' && 
      github.event_name == 'workflow_run' && 
      (startsWith(github.event.workflow_run.head_branch, 'feature/') || startsWith(github.event.workflow_run.head_branch, 'bugfix/') || startsWith(github.event.workflow_run.head_branch, 'hotfix/'))
    outputs:
      test_success: ${{ steps.check-test-status.outputs.test_success }}
      auto_deploy_enabled: ${{ steps.check-test-status.outputs.auto_deploy_enabled }}
    steps:
      - name: Check TEST Workflow Success
        id: check-test-status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "## ðŸ§ª Development Auto-Deploy Prerequisites" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "ðŸ” Checking if TEST workflow completed successfully for this commit..." >> $GITHUB_STEP_SUMMARY
          
          # Check for completed TEST workflow runs on this commit
          TEST_RUNS=$(gh api repos/${{ github.repository }}/actions/runs \
            --field event=push \
            --field status=completed \
            --field head_sha="${{ github.sha }}" \
            --jq '.workflow_runs[] | select(.name == "TEST - Policy and Validation") | select(.conclusion == "success") | .id' \
            2>/dev/null || echo "")
          
          if [ -n "$TEST_RUNS" ]; then
            TEST_RUN_ID=$(echo "$TEST_RUNS" | head -n1)
            echo "âœ… **TEST workflow found**: Run #$TEST_RUN_ID completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Auto-deploy enabled**: All prerequisites met for development deployment" >> $GITHUB_STEP_SUMMARY
            echo "test_success=true" >> $GITHUB_OUTPUT
            echo "auto_deploy_enabled=true" >> $GITHUB_OUTPUT
          else
            echo "â¸ï¸ **TEST workflow not found or not successful**: Waiting for tests to complete" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Auto-deploy disabled**: Development deployment requires successful TEST workflow" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps**: The TEST workflow must complete successfully before auto-deployment can proceed." >> $GITHUB_STEP_SUMMARY
            echo "test_success=false" >> $GITHUB_OUTPUT
            echo "auto_deploy_enabled=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [deploy-info, development-auto-deploy-check]
    if: |
      always() &&
      needs.deploy-info.outputs.deploy_infrastructure == 'true' && 
      (
        (needs.deploy-info.outputs.has_tf_changes == '1' || github.event.inputs.deploy_infrastructure == 'true') ||
        (needs.deploy-info.outputs.target_environment == 'dev' && needs.development-auto-deploy-check.result == 'success')
      ) &&
      (needs.development-auto-deploy-check.result == 'success' || needs.development-auto-deploy-check.result == 'skipped')
    environment: ${{ needs.deploy-info.outputs.target_environment }}
    outputs:
      deployment_outputs: ${{ steps.deploy.outputs.deployment_outputs }}
      deployment_status: ${{ steps.deploy.outputs.deployment_status }}
      s3_bucket_id: ${{ steps.deploy.outputs.s3_bucket_id }}
      cloudfront_distribution_id: ${{ steps.deploy.outputs.cloudfront_distribution_id }}
      cloudfront_domain_name: ${{ steps.deploy.outputs.cloudfront_domain_name }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Cache Infrastructure Dependencies
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: |
            ~/.cache/terraform
            terraform/.terraform
            terraform/.terraform.lock.hcl
          key: deploy-infra-${{ runner.os }}-${{ needs.deploy-info.outputs.target_environment }}-${{ hashFiles('terraform/*.tf', 'terraform/.terraform.lock.hcl') }}
          restore-keys: |
            deploy-infra-${{ runner.os }}-${{ needs.deploy-info.outputs.target_environment }}-
            deploy-infra-${{ runner.os }}-

      - name: Validate Environment
        uses: ./.github/actions/validate-environment
        with:
          environment: ${{ needs.deploy-info.outputs.target_environment }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
          aws-role: ${{ secrets.AWS_ASSUME_ROLE }}

      - name: Setup Infrastructure
        uses: ./.github/actions/setup-infrastructure
        with:
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
          aws-role: ${{ secrets.AWS_ASSUME_ROLE }}

      - name: Prepare Environment Variables
        id: prepare-env
        run: |
          # Convert repository owner to lowercase for project name
          PROJECT_NAME=$(echo "${{ github.repository_owner }}-static-site" | tr '[:upper:]' '[:lower:]')
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "Using project name: $PROJECT_NAME" >> $GITHUB_STEP_SUMMARY

      - name: Deploy Infrastructure
        id: deploy
        working-directory: terraform
        env:
          TF_VAR_environment: ${{ needs.deploy-info.outputs.target_environment }}
          TF_VAR_project_name: ${{ steps.prepare-env.outputs.project_name }}
          TF_VAR_github_repository: ${{ github.repository }}
          TF_VAR_aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
          # Environment-specific variables
          TF_VAR_enable_cross_region_replication: ${{ needs.deploy-info.outputs.target_environment == 'prod' && 'true' || 'false' }}
          TF_VAR_cloudfront_price_class: ${{ needs.deploy-info.outputs.target_environment == 'prod' && 'PriceClass_All' || needs.deploy-info.outputs.target_environment == 'staging' && 'PriceClass_200' || 'PriceClass_100' }}
          TF_VAR_waf_rate_limit: ${{ needs.deploy-info.outputs.target_environment == 'prod' && '5000' || needs.deploy-info.outputs.target_environment == 'staging' && '2000' || '1000' }}
          TF_VAR_enable_detailed_monitoring: ${{ needs.deploy-info.outputs.target_environment == 'dev' && 'false' || 'true' }}
          TF_VAR_alert_email_addresses: ${{ secrets.ALERT_EMAIL_ADDRESSES || '["admin@example.com"]' }}
          TF_VAR_monthly_budget_limit: ${{ vars.MONTHLY_BUDGET_LIMIT || '50' }}
        run: |
          echo "## ðŸ—ï¸ Infrastructure Deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy ID**: ${{ needs.deploy-info.outputs.deploy_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.deploy-info.outputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Initialize OpenTofu with backend
          echo "### ðŸ”§ Initializing OpenTofu" >> $GITHUB_STEP_SUMMARY
          tofu init
          
          # Create deployment plan
          echo "### ðŸ“‹ Creating Deployment Plan" >> $GITHUB_STEP_SUMMARY
          tofu plan -out=deployment.tfplan
          
          # Apply the deployment with enhanced error handling
          echo "### ðŸš€ Applying Deployment" >> $GITHUB_STEP_SUMMARY
          set -e  # Exit on any error
          
          # Set up cleanup trap
          cleanup() {
            echo "ðŸ§¹ Performing cleanup..." >> $GITHUB_STEP_SUMMARY
            if [ -f "deployment.tfplan" ]; then
              rm -f deployment.tfplan
            fi
            # Log current state for debugging
            tofu show -json > failure-state.json 2>/dev/null || true
          }
          trap cleanup EXIT
          
          if timeout 18m tofu apply -auto-approve deployment.tfplan; then
            echo "âœ… Infrastructure deployed successfully" >> $GITHUB_STEP_SUMMARY
            echo "deployment_status=success" >> $GITHUB_OUTPUT
            
            # Capture outputs with error handling
            if tofu output -json > deployment-outputs.json 2>/dev/null; then
              OUTPUTS=$(cat deployment-outputs.json | jq -c . 2>/dev/null || echo '{}')
              echo "deployment_outputs=$OUTPUTS" >> $GITHUB_OUTPUT
              
              # Extract key outputs for website deployment
              S3_BUCKET=$(jq -r '.s3_bucket_id.value // empty' deployment-outputs.json)
              CF_DISTRIBUTION=$(jq -r '.cloudfront_distribution_id.value // empty' deployment-outputs.json)
              CF_DOMAIN=$(jq -r '.cloudfront_domain_name.value // empty' deployment-outputs.json)
              
              echo "s3_bucket_id=$S3_BUCKET" >> $GITHUB_OUTPUT
              echo "cloudfront_distribution_id=$CF_DISTRIBUTION" >> $GITHUB_OUTPUT
              echo "cloudfront_domain_name=$CF_DOMAIN" >> $GITHUB_OUTPUT
              
              echo "### ðŸ“Š Deployment Outputs" >> $GITHUB_STEP_SUMMARY
              echo "- **S3 Bucket**: $S3_BUCKET" >> $GITHUB_STEP_SUMMARY
              echo "- **CloudFront Distribution**: $CF_DISTRIBUTION" >> $GITHUB_STEP_SUMMARY
              echo "- **CloudFront Domain**: $CF_DOMAIN" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Could not capture deployment outputs" >> $GITHUB_STEP_SUMMARY
              echo "deployment_outputs={}" >> $GITHUB_OUTPUT
            fi
          else
            APPLY_EXIT_CODE=$?
            echo "âŒ Infrastructure deployment failed (exit code: $APPLY_EXIT_CODE)" >> $GITHUB_STEP_SUMMARY
            echo "deployment_status=failed" >> $GITHUB_OUTPUT
            
            # Capture failure state for debugging
            echo "### ðŸ” Failure Analysis" >> $GITHUB_STEP_SUMMARY
            tofu show 2>/dev/null | tail -50 >> $GITHUB_STEP_SUMMARY || echo "Could not show current state"
            
            exit 1
          fi

      - name: Upload Deployment Outputs
        if: steps.deploy.outputs.deployment_status == 'success'
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: ${{ needs.deploy-info.outputs.deploy_id }}-infrastructure-outputs
          path: terraform/deployment-outputs.json
          retention-days: 30

      - name: Post-Deployment Validation
        if: steps.deploy.outputs.deployment_status == 'success'
        run: |
          echo "### ðŸ” Post-Deployment Validation" >> $GITHUB_STEP_SUMMARY
          
          S3_BUCKET="${{ steps.deploy.outputs.s3_bucket_id }}"
          CF_DISTRIBUTION="${{ steps.deploy.outputs.cloudfront_distribution_id }}"
          
          validation_errors=0
          
          # Validate S3 bucket
          if [ -n "$S3_BUCKET" ]; then
            if aws s3 ls "s3://$S3_BUCKET" >/dev/null 2>&1; then
              echo "âœ… S3 bucket accessible: $S3_BUCKET" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ S3 bucket not accessible: $S3_BUCKET" >> $GITHUB_STEP_SUMMARY
              validation_errors=$((validation_errors + 1))
            fi
          fi
          
          # Validate CloudFront distribution
          if [ -n "$CF_DISTRIBUTION" ]; then
            if aws cloudfront get-distribution --id "$CF_DISTRIBUTION" >/dev/null 2>&1; then
              echo "âœ… CloudFront distribution accessible: $CF_DISTRIBUTION" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ CloudFront distribution not accessible: $CF_DISTRIBUTION" >> $GITHUB_STEP_SUMMARY
              validation_errors=$((validation_errors + 1))
            fi
          fi
          
          if [ $validation_errors -eq 0 ]; then
            echo "âœ… Post-deployment validation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Post-deployment validation failed with $validation_errors errors" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  deploy-website:
    name: Deploy Website Content
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [deploy-info, deploy-infrastructure, development-auto-deploy-check]
    if: |
      always() &&
      needs.deploy-info.outputs.deploy_website == 'true' && 
      (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped') && 
      (
        (needs.deploy-info.outputs.has_content_changes == '1' || github.event.inputs.deploy_website == 'true') ||
        (needs.deploy-info.outputs.target_environment == 'dev' && needs.development-auto-deploy-check.result == 'success')
      ) &&
      (needs.development-auto-deploy-check.result == 'success' || needs.development-auto-deploy-check.result == 'skipped')
    environment: ${{ needs.deploy-info.outputs.target_environment }}
    outputs:
      website_url: ${{ steps.deploy-content.outputs.website_url }}
      deployment_status: ${{ steps.deploy-content.outputs.deployment_status }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Cache Website Dependencies
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: |
            ~/.cache/terraform
            terraform/.terraform
          key: deploy-website-${{ runner.os }}-${{ needs.deploy-info.outputs.target_environment }}-${{ hashFiles('src/**/*') }}
          restore-keys: |
            deploy-website-${{ runner.os }}-${{ needs.deploy-info.outputs.target_environment }}-
            deploy-website-${{ runner.os }}-

      - name: Setup Infrastructure
        uses: ./.github/actions/setup-infrastructure
        with:
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
          aws-role: ${{ secrets.AWS_ASSUME_ROLE }}

      - name: Download Website Artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          pattern: website-*
          merge-multiple: true
        continue-on-error: true

      - name: Deploy Website Content
        id: deploy-content
        env:
          S3_BUCKET: ${{ needs.deploy-infrastructure.outputs.s3_bucket_id }}
          CF_DISTRIBUTION: ${{ needs.deploy-infrastructure.outputs.cloudfront_distribution_id }}
          CF_DOMAIN: ${{ needs.deploy-infrastructure.outputs.cloudfront_domain_name }}
        run: |
          echo "## ðŸŒ Website Content Deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy ID**: ${{ needs.deploy-info.outputs.deploy_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.deploy-info.outputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Use built website if available, otherwise use source
          if [ -d "build" ]; then
            CONTENT_DIR="build"
            echo "âœ… Using built website content from BUILD workflow" >> $GITHUB_STEP_SUMMARY
          else
            CONTENT_DIR="src"
            echo "âš ï¸ Using source content directly (no BUILD artifacts found)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Get S3 bucket from infrastructure deployment or discover it
          if [ -z "$S3_BUCKET" ]; then
            echo "ðŸ” Discovering S3 bucket from Terraform state..." >> $GITHUB_STEP_SUMMARY
            cd terraform
            S3_BUCKET=$(tofu output -raw s3_bucket_id 2>/dev/null || echo "")
            CF_DISTRIBUTION=$(tofu output -raw cloudfront_distribution_id 2>/dev/null || echo "")
            CF_DOMAIN=$(tofu output -raw cloudfront_domain_name 2>/dev/null || echo "")
            cd ..
          fi
          
          if [ -z "$S3_BUCKET" ]; then
            echo "âš ï¸ Could not determine S3 bucket - infrastructure may not be deployed yet" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **First-time Setup Guidance**: Run infrastructure deployment first or ensure Terraform outputs are available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Common Causes:**" >> $GITHUB_STEP_SUMMARY  
            echo "- This is a first-time deployment (infrastructure needs to be deployed first)" >> $GITHUB_STEP_SUMMARY
            echo "- Infrastructure deployment failed or was skipped" >> $GITHUB_STEP_SUMMARY
            echo "- Terraform state is not accessible" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps**: Deploy infrastructure first, then retry website deployment" >> $GITHUB_STEP_SUMMARY
            echo "deployment_status=infrastructure_missing" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "### ðŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: $S3_BUCKET" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront Distribution**: $CF_DISTRIBUTION" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront Domain**: $CF_DOMAIN" >> $GITHUB_STEP_SUMMARY
          echo "- **Content Directory**: $CONTENT_DIR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Sync content to S3
          echo "### ðŸš€ Syncing Content to S3" >> $GITHUB_STEP_SUMMARY
          if aws s3 sync "$CONTENT_DIR/" "s3://$S3_BUCKET" --delete --exact-timestamps; then
            echo "âœ… Content synced successfully to S3" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to sync content to S3" >> $GITHUB_STEP_SUMMARY
            echo "deployment_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Invalidate CloudFront cache
          if [ -n "$CF_DISTRIBUTION" ]; then
            echo "### ðŸ”„ Invalidating CloudFront Cache" >> $GITHUB_STEP_SUMMARY
            
            # Attempt CloudFront invalidation with retry logic
            INVALIDATION_SUCCESS=false
            for attempt in 1 2 3; do
              echo "Attempt $attempt to invalidate CloudFront cache..."
              
              INVALIDATION_ID=$(aws cloudfront create-invalidation \
                --distribution-id "$CF_DISTRIBUTION" \
                --paths "/*" \
                --query 'Invalidation.Id' \
                --output text 2>/dev/null)
              
              if [ $? -eq 0 ] && [ -n "$INVALIDATION_ID" ] && [ "$INVALIDATION_ID" != "None" ]; then
                echo "âœ… CloudFront cache invalidation created: $INVALIDATION_ID" >> $GITHUB_STEP_SUMMARY
                INVALIDATION_SUCCESS=true
                break
              fi
              
              if [ $attempt -lt 3 ]; then
                echo "âš ï¸ Invalidation attempt $attempt failed, retrying in 10 seconds..." >> $GITHUB_STEP_SUMMARY
                sleep 10
              fi
            done
            
            if [ "$INVALIDATION_SUCCESS" = "false" ]; then
              echo "âš ï¸ CloudFront cache invalidation failed after 3 attempts" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ”§ **Note**: Website content was deployed successfully, but cache may take time to update" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No CloudFront distribution found - skipping cache invalidation" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **First-time Setup**: If this is initial deployment, CloudFront distribution will be available after infrastructure deployment completes" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Set outputs
          echo "deployment_status=success" >> $GITHUB_OUTPUT
          if [ -n "$CF_DOMAIN" ]; then
            echo "website_url=https://$CF_DOMAIN" >> $GITHUB_OUTPUT
            echo "### ðŸŒ Website URL" >> $GITHUB_STEP_SUMMARY
            echo "**Website is now live at**: https://$CF_DOMAIN" >> $GITHUB_STEP_SUMMARY
          else
            echo "website_url=https://$S3_BUCKET.s3.amazonaws.com" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŒ Website URL" >> $GITHUB_STEP_SUMMARY
            echo "**Website is available at**: https://$S3_BUCKET.s3.amazonaws.com" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify Website Deployment
        run: |
          echo "### ðŸ” Website Verification" >> $GITHUB_STEP_SUMMARY
          
          WEBSITE_URL="${{ steps.deploy-content.outputs.website_url }}"
          
          if [ -n "$WEBSITE_URL" ]; then
            echo "Testing website accessibility: $WEBSITE_URL"
            
            # Wait a moment for propagation
            sleep 30
            
            # Test website accessibility (basic check)
            if curl -s -f -I "$WEBSITE_URL" >/dev/null; then
              echo "âœ… Website is accessible at $WEBSITE_URL" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Website may not be immediately accessible (propagation delay expected)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  staging-usability-tests:
    name: Staging Usability Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [deploy-info, deploy-website]
    if: needs.deploy-info.outputs.target_environment == 'staging' && needs.deploy-website.result == 'success'
    outputs:
      usability_results: ${{ steps.run-tests.outputs.usability_results }}
      tests_passed: ${{ steps.run-tests.outputs.tests_passed }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      
      - name: Run Staging Usability Tests
        id: run-tests
        env:
          STAGING_URL: ${{ needs.deploy-website.outputs.website_url }}
        run: |
          echo "ðŸ§ª Running Staging Usability Test Suite" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site URL**: $STAGING_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Wait for deployment propagation
          echo "â³ Waiting for deployment propagation (60 seconds)..." >> $GITHUB_STEP_SUMMARY
          sleep 60
          
          # Extract domain from URL for staging tests
          SITE_DOMAIN=$(echo "$STAGING_URL" | sed 's|https\?://||' | sed 's|/.*||')
          
          # Run staging-specific usability tests
          if bash test/usability/staging-usability-tests.sh "$SITE_DOMAIN"; then
            echo "âœ… All staging usability tests passed" >> $GITHUB_STEP_SUMMARY
            echo "tests_passed=true" >> $GITHUB_OUTPUT
            
            # Extract test results
            if [ -f "test/usability/test-results/test-summary.json" ]; then
              RESULTS=$(cat test/usability/test-results/test-summary.json | jq -c .)
              echo "usability_results=$RESULTS" >> $GITHUB_OUTPUT
              
              # Add results to summary
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
              echo "- **Total Tests**: $(echo "$RESULTS" | jq -r '.summary.total_tests // "N/A"')" >> $GITHUB_STEP_SUMMARY
              echo "- **Passed**: $(echo "$RESULTS" | jq -r '.summary.passed_tests // "N/A"')" >> $GITHUB_STEP_SUMMARY
              echo "- **Failed**: $(echo "$RESULTS" | jq -r '.summary.failed_tests // "N/A"')" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Staging usability tests failed" >> $GITHUB_STEP_SUMMARY
            echo "Staging environment is not ready for production promotion" >> $GITHUB_STEP_SUMMARY
            echo "tests_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Update GitHub Deployment Status
        if: always()
        run: |
          # Update deployment status based on usability test results
          if [ "${{ steps.run-tests.outputs.tests_passed }}" = "true" ]; then
            DEPLOYMENT_STATUS="success"
            DESCRIPTION="Staging deployment validated - usability tests passed"
          else
            DEPLOYMENT_STATUS="failure"
            DESCRIPTION="Staging deployment failed usability validation"
          fi
          
          # Create deployment status
          gh api repos/${{ github.repository }}/deployments \
            --method POST \
            --field ref="${{ github.sha }}" \
            --field environment="staging" \
            --field auto_merge=false \
            --field required_contexts='[]' \
            --field description="Staging deployment with usability validation" \
            --silent || true
          
          # Get the deployment ID and update status
          DEPLOYMENT_ID=$(gh api repos/${{ github.repository }}/deployments \
            --paginate | jq -r '.[] | select(.environment=="staging" and .sha=="${{ github.sha }}") | .id' | head -1)
          
          if [ -n "$DEPLOYMENT_ID" ]; then
            gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
              --method POST \
              --field state="$DEPLOYMENT_STATUS" \
              --field description="$DESCRIPTION" \
              --field environment_url="${{ needs.deploy-website.outputs.website_url }}" \
              --silent || true
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Upload Usability Test Results
        if: always()
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: ${{ needs.deploy-info.outputs.deploy_id }}-staging-usability-results
          path: test/usability/test-results/
          retention-days: 30
        continue-on-error: true

  production-validation:
    name: Production Validation Suite
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-info, deploy-website]
    if: (needs.deploy-info.outputs.target_environment == 'prod' || needs.deploy-info.outputs.target_environment == 'production') && needs.deploy-website.result == 'success'
    outputs:
      validation_results: ${{ steps.run-validation.outputs.validation_results }}
      validation_passed: ${{ steps.run-validation.outputs.validation_passed }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      
      - name: Run Production Validation Suite
        id: run-validation
        env:
          PRODUCTION_URL: ${{ needs.deploy-website.outputs.website_url }}
        run: |
          echo "ðŸ” Running Production Validation Suite" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site URL**: $PRODUCTION_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Wait for deployment propagation (longer for production)
          echo "â³ Waiting for production deployment propagation (120 seconds)..." >> $GITHUB_STEP_SUMMARY
          sleep 120
          
          # Extract domain from URL for production tests
          SITE_DOMAIN=$(echo "$PRODUCTION_URL" | sed 's|https\?://||' | sed 's|/.*||')
          
          # Run comprehensive production validation tests
          validation_passed=true
          
          echo "### ðŸ”’ Security Validation" >> $GITHUB_STEP_SUMMARY
          
          # Enhanced security tests for production
          if curl -s -I "$PRODUCTION_URL" | grep -q "Strict-Transport-Security"; then
            echo "âœ… HSTS header present" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ HSTS header missing" >> $GITHUB_STEP_SUMMARY
            validation_passed=false
          fi
          
          if curl -s -I "$PRODUCTION_URL" | grep -q "Content-Security-Policy"; then
            echo "âœ… CSP header present" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ CSP header missing" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ Performance Validation" >> $GITHUB_STEP_SUMMARY
          
          # Performance tests
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' "$PRODUCTION_URL")
          if [ $(echo "$RESPONSE_TIME < 2.0" | bc) -eq 1 ]; then
            echo "âœ… Response time: ${RESPONSE_TIME}s (< 2.0s)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Response time: ${RESPONSE_TIME}s (> 2.0s)" >> $GITHUB_STEP_SUMMARY
            validation_passed=false
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Global Accessibility" >> $GITHUB_STEP_SUMMARY
          
          # Test from multiple regions (simulate global access)
          HTTP_STATUS=$(curl -o /dev/null -s -w '%{http_code}\n' "$PRODUCTION_URL")
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… HTTP Status: $HTTP_STATUS" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ HTTP Status: $HTTP_STATUS" >> $GITHUB_STEP_SUMMARY
            validation_passed=false
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Monitoring Integration" >> $GITHUB_STEP_SUMMARY
          
          # Verify monitoring is working (basic check)
          if aws cloudwatch describe-alarms --alarm-names "*static-site*" --query 'MetricAlarms[0].AlarmName' --output text >/dev/null 2>&1; then
            echo "âœ… CloudWatch alarms configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No CloudWatch alarms found" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Set final validation results
          if [ "$validation_passed" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Production validation passed - site is ready for traffic**" >> $GITHUB_STEP_SUMMARY
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Production validation failed - review issues before proceeding**" >> $GITHUB_STEP_SUMMARY
            echo "validation_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Create validation results JSON
          echo '{"security":true,"performance":true,"accessibility":true}' > validation-results.json
          VALIDATION_JSON=$(cat validation-results.json | jq -c .)
          echo "validation_results=$VALIDATION_JSON" >> $GITHUB_OUTPUT
      
      - name: Update Production Deployment Status
        if: always()
        run: |
          # Update deployment status based on validation results
          if [ "${{ steps.run-validation.outputs.validation_passed }}" = "true" ]; then
            DEPLOYMENT_STATUS="success"
            DESCRIPTION="Production deployment validated - all checks passed"
          else
            DEPLOYMENT_STATUS="failure"
            DESCRIPTION="Production deployment failed validation"
          fi
          
          # Create/update deployment status
          gh api repos/${{ github.repository }}/deployments \
            --method POST \
            --field ref="${{ github.sha }}" \
            --field environment="production" \
            --field auto_merge=false \
            --field required_contexts='[]' \
            --field description="Production deployment with full validation" \
            --silent || true
          
          # Get the deployment ID and update status
          DEPLOYMENT_ID=$(gh api repos/${{ github.repository }}/deployments \
            --paginate | jq -r '.[] | select(.environment=="production" and .sha=="${{ github.sha }}") | .id' | head -1)
          
          if [ -n "$DEPLOYMENT_ID" ]; then
            gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
              --method POST \
              --field state="$DEPLOYMENT_STATUS" \
              --field description="$DESCRIPTION" \
              --field environment_url="${{ needs.deploy-website.outputs.website_url }}" \
              --silent || true
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Upload Production Validation Results
        if: always()
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: ${{ needs.deploy-info.outputs.deploy_id }}-production-validation-results
          path: validation-results.json
          retention-days: 30
        continue-on-error: true

  update-deployment-status:
    name: Update Deployment Status & Badges
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [deploy-info, deploy-infrastructure, deploy-website, staging-usability-tests, production-validation, development-auto-deploy-check]
    if: always()
    permissions:
      deployments: write  # Needed for GitHub Deployments API
      pull-requests: write  # Needed to create and auto-merge PRs
    outputs:
      actual_deployment_occurred: ${{ steps.analyze-deployment.outputs.actual_deployment_occurred }}
      deployment_summary: ${{ steps.analyze-deployment.outputs.deployment_summary }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          token: ${{ github.token }}

      - name: Analyze Deployment Reality
        id: analyze-deployment
        run: |
          echo "## ðŸ” Deployment Reality Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TARGET_ENV="${{ needs.deploy-info.outputs.target_environment }}"
          INFRA_RESULT="${{ needs.deploy-infrastructure.result }}"
          WEBSITE_RESULT="${{ needs.deploy-website.result }}"
          
          echo "**Target Environment**: $TARGET_ENV" >> $GITHUB_STEP_SUMMARY
          echo "**Infrastructure Job**: $INFRA_RESULT" >> $GITHUB_STEP_SUMMARY
          echo "**Website Job**: $WEBSITE_RESULT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine if actual deployment occurred
          ACTUAL_DEPLOYMENT=false
          DEPLOYMENT_TYPE=""
          SKIP_REASON=""
          
          # First check for failures - any failure means no successful deployment
          if [ "$INFRA_RESULT" = "failure" ] || [ "$WEBSITE_RESULT" = "failure" ]; then
            ACTUAL_DEPLOYMENT=false
            SKIP_REASON="deployment-failed"
          elif [ "$INFRA_RESULT" = "success" ] || [ "$WEBSITE_RESULT" = "success" ]; then
            # At least one deployment succeeded and no failures
            ACTUAL_DEPLOYMENT=true
            if [ "$INFRA_RESULT" = "success" ] && [ "$WEBSITE_RESULT" = "success" ]; then
              DEPLOYMENT_TYPE="full"
            elif [ "$INFRA_RESULT" = "success" ]; then
              DEPLOYMENT_TYPE="infrastructure-only"
            elif [ "$WEBSITE_RESULT" = "success" ]; then
              DEPLOYMENT_TYPE="website-only"
            fi
          else
            # Both were skipped or had other non-success, non-failure results
            if [ "$INFRA_RESULT" = "skipped" ] && [ "$WEBSITE_RESULT" = "skipped" ]; then
              SKIP_REASON="no-changes-detected"
            else
              SKIP_REASON="conditions-not-met"
            fi
          fi
          
          echo "actual_deployment_occurred=$ACTUAL_DEPLOYMENT" >> $GITHUB_OUTPUT
          
          # Generate deployment summary
          if [ "$ACTUAL_DEPLOYMENT" = "true" ]; then
            DEPLOYMENT_SUMMARY="âœ… **Deployment Successful**: $DEPLOYMENT_TYPE deployment completed to $TARGET_ENV"
            echo "deployment_summary=$DEPLOYMENT_SUMMARY" >> $GITHUB_OUTPUT
            echo "$DEPLOYMENT_SUMMARY" >> $GITHUB_STEP_SUMMARY
          else
            case "$SKIP_REASON" in
              "no-changes-detected")
                DEPLOYMENT_SUMMARY="â„¹ï¸ **Deployment Skipped**: No changes detected for $TARGET_ENV environment"
                ;;
              "deployment-failed")
                DEPLOYMENT_SUMMARY="âŒ **Deployment Failed**: Check logs for $TARGET_ENV deployment errors"
                ;;
              "conditions-not-met")
                DEPLOYMENT_SUMMARY="â­ï¸ **Deployment Skipped**: Conditional requirements not met for $TARGET_ENV"
                ;;
            esac
            echo "deployment_summary=$DEPLOYMENT_SUMMARY" >> $GITHUB_OUTPUT
            echo "$DEPLOYMENT_SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create/Update GitHub Deployment
        id: github-deployment
        if: steps.analyze-deployment.outputs.actual_deployment_occurred == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "### ðŸš€ Creating GitHub Deployment Record" >> $GITHUB_STEP_SUMMARY
          
          TARGET_ENV="${{ needs.deploy-info.outputs.target_environment }}"
          WEBSITE_URL="${{ needs.deploy-website.outputs.website_url }}"
          
          # Create deployment record
          DEPLOYMENT_ID=$(gh api repos/${{ github.repository }}/deployments \
            --method POST \
            --field ref="${{ github.sha }}" \
            --field environment="$TARGET_ENV" \
            --field description="Deployment to $TARGET_ENV via ${{ github.event_name }}" \
            --field auto_merge=false \
            --jq .id)
          
          echo "**Deployment ID**: $DEPLOYMENT_ID" >> $GITHUB_STEP_SUMMARY
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          
          # Update deployment status
          DEPLOY_STATUS="success"
          DEPLOY_DESCRIPTION="Successfully deployed to $TARGET_ENV environment"
          
          if [ -n "$WEBSITE_URL" ]; then
            gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
              --method POST \
              --field state="$DEPLOY_STATUS" \
              --field description="$DEPLOY_DESCRIPTION" \
              --field environment_url="$WEBSITE_URL" \
              --field log_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
              --method POST \
              --field state="$DEPLOY_STATUS" \
              --field description="$DEPLOY_DESCRIPTION" \
              --field log_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          
          echo "âœ… GitHub deployment status updated" >> $GITHUB_STEP_SUMMARY


  deployment-summary:
    name: Deployment Summary  
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [deploy-info, deploy-infrastructure, deploy-website, staging-usability-tests, production-validation, development-auto-deploy-check, update-deployment-status]
    if: always()
    outputs:
      website_url: ${{ steps.export-url.outputs.website_url }}
      deployment_success: ${{ steps.export-url.outputs.deployment_success }}
      actual_deployment_occurred: ${{ needs.update-deployment-status.outputs.actual_deployment_occurred }}
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸš€ DEPLOY Phase Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy ID**: ${{ needs.deploy-info.outputs.deploy_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.deploy-info.outputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show deployment reality first
          echo "### ðŸŽ¯ Deployment Reality" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.update-deployment-status.outputs.deployment_summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Job Execution Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Infrastructure Deployment**: ${{ needs.deploy-infrastructure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Website Deployment**: ${{ needs.deploy-website.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Staging Usability Tests**: ${{ needs.staging-usability-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Production Validation**: ${{ needs.production-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status & Badge Update**: ${{ needs.update-deployment-status.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show website URL if available
          WEBSITE_URL="${{ needs.deploy-website.outputs.website_url }}"
          if [ -n "$WEBSITE_URL" ]; then
            echo "### ðŸŒ Deployed Website" >> $GITHUB_STEP_SUMMARY
            echo "**Live URL**: $WEBSITE_URL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Final status assessment using improved deployment analysis
          TARGET_ENV="${{ needs.deploy-info.outputs.target_environment }}"
          ACTUAL_DEPLOYMENT="${{ needs.update-deployment-status.outputs.actual_deployment_occurred }}"
          STAGING_TESTS_STATUS="${{ needs.staging-usability-tests.result }}"
          PRODUCTION_VALIDATION_STATUS="${{ needs.production-validation.result }}"
          
          # Use the new deployment reality analysis
          workflow_success=true
          
          # Check environment-specific validation requirements
          if [ "$TARGET_ENV" = "staging" ] && [ "$STAGING_TESTS_STATUS" = "failure" ]; then
            workflow_success=false
          fi
          
          if [ "$TARGET_ENV" = "prod" ] || [ "$TARGET_ENV" = "production" ]; then
            if [ "$PRODUCTION_VALIDATION_STATUS" = "failure" ]; then
              workflow_success=false
            fi
          fi
          
          # Enhanced status reporting that distinguishes deployment vs workflow success
          echo "### ðŸŽ¯ Final Status Assessment" >> $GITHUB_STEP_SUMMARY
          
          if [ "$workflow_success" = "true" ]; then
            if [ "$ACTUAL_DEPLOYMENT" = "true" ]; then
              echo "âœ… **WORKFLOW SUCCESSFUL - DEPLOYMENT COMPLETED**" >> $GITHUB_STEP_SUMMARY
              if [ "$TARGET_ENV" = "prod" ] || [ "$TARGET_ENV" = "production" ]; then
                echo "Production deployment completed with full validation - website is live and validated." >> $GITHUB_STEP_SUMMARY
              elif [ "$TARGET_ENV" = "staging" ]; then
                echo "Staging deployment completed with full validation - ready for production consideration." >> $GITHUB_STEP_SUMMARY
              else
                echo "Development deployment completed successfully." >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âœ… **WORKFLOW SUCCESSFUL - NO DEPLOYMENT NEEDED**" >> $GITHUB_STEP_SUMMARY
              echo "All validations passed, but no deployment was required (likely no changes detected)." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **WORKFLOW FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed validations and fix issues before proceeding." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Export Public URL
        id: export-url
        run: |
          # Export the public URL for external access
          WEBSITE_URL="${{ needs.deploy-website.outputs.website_url }}"
          TARGET_ENV="${{ needs.deploy-info.outputs.target_environment }}"
          ACTUAL_DEPLOYMENT="${{ needs.update-deployment-status.outputs.actual_deployment_occurred }}"
          STAGING_TESTS_STATUS="${{ needs.staging-usability-tests.result }}"
          PRODUCTION_VALIDATION_STATUS="${{ needs.production-validation.result }}"
          
          echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
          
          # Determine overall deployment success using improved logic
          workflow_success=true
          
          # Check environment-specific validation requirements (same logic as summary)
          if [ "$TARGET_ENV" = "staging" ] && [ "$STAGING_TESTS_STATUS" = "failure" ]; then
            workflow_success=false
          fi
          
          if [ "$TARGET_ENV" = "prod" ] || [ "$TARGET_ENV" = "production" ]; then
            if [ "$PRODUCTION_VALIDATION_STATUS" = "failure" ]; then
              workflow_success=false
            fi
          fi
          
          # Set deployment success output (workflow success, not just deployment occurrence)
          if [ "$workflow_success" = "true" ]; then
            echo "deployment_success=true" >> $GITHUB_OUTPUT
          else
            echo "deployment_success=false" >> $GITHUB_OUTPUT
          fi
          
          # Print URL to console for easy access
          if [ -n "$WEBSITE_URL" ]; then
            echo ""
            echo "ðŸŒ ========================================"
            echo "ðŸš€ WEBSITE DEPLOYED SUCCESSFULLY!"
            echo "ðŸŒ Public URL: $WEBSITE_URL"
            echo "ðŸŒ ========================================"
            echo ""
            
            # Add prominent notice to step summary
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# ðŸŽ‰ Website Deployed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸŒ **Public URL**: [$WEBSITE_URL]($WEBSITE_URL)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your static website is now live and accessible worldwide!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
            echo "- Test the website functionality" >> $GITHUB_STEP_SUMMARY
            echo "- Monitor performance metrics" >> $GITHUB_STEP_SUMMARY
            echo "- Check CloudWatch dashboards" >> $GITHUB_STEP_SUMMARY
            echo "- Verify security headers" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No website URL available - deployment may have failed"
          fi