name: DEPLOY - Static Website Deployment

on:
  workflow_dispatch:
    inputs:
      test_id:
        description: 'Test ID from TEST workflow (optional - will create new if not provided)'
        required: false
        type: string
      build_id:
        description: 'Build ID to reference (optional - will inherit from TEST)'
        required: false
        type: string
      environment:
        description: 'Target environment for deployment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: dev
      skip_test_check:
        description: 'Skip TEST workflow dependency check'
        required: false
        default: false
        type: boolean
      deploy_infrastructure:
        description: 'Deploy infrastructure changes'
        required: false
        default: true
        type: boolean
      deploy_website:
        description: 'Deploy website content'
        required: false
        default: true
        type: boolean
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
  workflow_run:
    workflows: ["TEST - Policy and Validation"]
    types: [completed]
    branches:
      - main

# OIDC Authentication Permissions for Production Deployment
# id-token: write - ESSENTIAL: Enables secure OIDC token generation for AWS authentication
# contents: read - Repository access for deployment workflows
# pull-requests: write - Deployment status updates and notifications
permissions:
  id-token: write
  contents: read
  pull-requests: write

concurrency:
  group: static-site-deployment-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

jobs:
  production-authorization:
    name: Production Authorization Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.inputs.environment == 'prod' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    outputs:
      authorized: ${{ steps.check-auth.outputs.authorized }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      
      - name: Check Code Owner Authorization
        id: check-auth
        run: |
          echo "🔐 Validating Production Deployment Authorization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get the actor (person triggering the deployment)
          ACTOR="${{ github.actor }}"
          echo "**Requesting User**: $ACTOR" >> $GITHUB_STEP_SUMMARY
          
          # Read CODEOWNERS file to check authorization
          if [ -f ".github/CODEOWNERS" ]; then
            # Extract code owners from CODEOWNERS file (handles different formats)
            CODE_OWNERS=$(grep -E '^(\*|/.github/workflows/)' .github/CODEOWNERS | grep -oE '@[a-zA-Z0-9_-]+' | sort -u || echo "")
            
            echo "**Code Owners**: $CODE_OWNERS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Check if actor is in the code owners list
            if echo "$CODE_OWNERS" | grep -q "@$ACTOR"; then
              echo "✅ **AUTHORIZED**: $ACTOR is a code owner" >> $GITHUB_STEP_SUMMARY
              echo "Production deployment can proceed" >> $GITHUB_STEP_SUMMARY
              echo "authorized=true" >> $GITHUB_OUTPUT
            else
              echo "❌ **UNAUTHORIZED**: $ACTOR is not a code owner" >> $GITHUB_STEP_SUMMARY
              echo "Production deployments are restricted to code owners only" >> $GITHUB_STEP_SUMMARY
              echo "** Authorized users**: $CODE_OWNERS" >> $GITHUB_STEP_SUMMARY
              echo "authorized=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "⚠️ **WARNING**: No CODEOWNERS file found" >> $GITHUB_STEP_SUMMARY
            echo "Production deployment proceeding without authorization check" >> $GITHUB_STEP_SUMMARY
            echo "authorized=true" >> $GITHUB_OUTPUT
          fi

  deploy-info:
    name: Deployment Information
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [production-authorization]
    if: needs.production-authorization.result == 'success' || needs.production-authorization.result == 'skipped'
    outputs:
      deploy_id: ${{ steps.generate-id.outputs.deploy_id }}
      test_id: ${{ steps.generate-id.outputs.test_id }}
      build_id: ${{ steps.generate-id.outputs.build_id }}
      target_environment: ${{ steps.generate-id.outputs.target_environment }}
      deploy_infrastructure: ${{ steps.generate-id.outputs.deploy_infrastructure }}
      deploy_website: ${{ steps.generate-id.outputs.deploy_website }}
      test_success: ${{ steps.check-test.outputs.test_success }}
      has_tf_changes: ${{ steps.detect-changes.outputs.has_tf_changes }}
      has_content_changes: ${{ steps.detect-changes.outputs.has_content_changes }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0
      - name: Check TEST Status
        id: check-test
        if: github.event_name == 'workflow_run' && github.event.inputs.skip_test_check != 'true'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "TEST workflow failed - cannot proceed with DEPLOY"
            echo "test_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "TEST workflow passed - proceeding with DEPLOY"
          echo "test_success=true" >> $GITHUB_OUTPUT

      - name: Download TEST Artifacts
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          run-id: ${{ github.event.workflow_run.id }}
          merge-multiple: true
        continue-on-error: true

      - name: Generate Deployment ID
        id: generate-id
        run: |
          # Secure input handling with validation
          TEST_ID_INPUT='${{ github.event.inputs.test_id }}'
          BUILD_ID_INPUT='${{ github.event.inputs.build_id }}'
          ENV_INPUT='${{ github.event.inputs.environment }}'
          
          # Input validation
          if [ -n "$TEST_ID_INPUT" ]; then
            if [ ${#TEST_ID_INPUT} -gt 100 ]; then
              echo "❌ ERROR: Test ID too long (max 100 chars)"
              exit 1
            fi
            if [[ ! "$TEST_ID_INPUT" =~ ^[a-zA-Z0-9_-]+$ ]]; then
              echo "❌ ERROR: Invalid characters in test ID"
              exit 1
            fi
          fi
          
          if [ -n "$BUILD_ID_INPUT" ]; then
            if [ ${#BUILD_ID_INPUT} -gt 100 ]; then
              echo "❌ ERROR: Build ID too long (max 100 chars)"
              exit 1
            fi
            if [[ ! "$BUILD_ID_INPUT" =~ ^[a-zA-Z0-9_-]+$ ]]; then
              echo "❌ ERROR: Invalid characters in build ID"
              exit 1
            fi
          fi
          
          # Set validated values
          if [ -n "$TEST_ID_INPUT" ]; then
            TEST_ID="$TEST_ID_INPUT"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            TEST_ID="test-${{ github.event.workflow_run.id }}"
          else
            TEST_ID="test-${{ github.run_id }}-auto"
          fi
          
          if [ -n "$BUILD_ID_INPUT" ]; then
            BUILD_ID="$BUILD_ID_INPUT"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            BUILD_ID=$(find . -name "*test*report*.json" -exec jq -r '.build_id // empty' {} \; | head -1 || echo "build-auto")
            if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "null" ]; then
              BUILD_ID="build-auto"
            fi
          else
            BUILD_ID="build-${{ github.run_id }}-auto"
          fi
          
          if [ -n "$ENV_INPUT" ]; then
            TARGET_ENV="$ENV_INPUT"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # PRs always deploy to staging for validation
            TARGET_ENV="staging"
          elif [ -n "${{ vars.DEFAULT_ENVIRONMENT }}" ]; then
            TARGET_ENV="${{ vars.DEFAULT_ENVIRONMENT }}"
          else
            TARGET_ENV="dev"
          fi
          
          DEPLOY_INFRASTRUCTURE="${{ github.event.inputs.deploy_infrastructure || 'true' }}"
          DEPLOY_WEBSITE="${{ github.event.inputs.deploy_website || 'true' }}"
          
          DEPLOY_ID="deploy-${{ github.run_id }}-${{ github.run_attempt }}"
          
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          echo "test_id=$TEST_ID" >> $GITHUB_OUTPUT
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "target_environment=$TARGET_ENV" >> $GITHUB_OUTPUT
          echo "deploy_infrastructure=$DEPLOY_INFRASTRUCTURE" >> $GITHUB_OUTPUT
          echo "deploy_website=$DEPLOY_WEBSITE" >> $GITHUB_OUTPUT
          
          echo "🚀 **DEPLOY Phase Started**" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy ID**: $DEPLOY_ID" >> $GITHUB_STEP_SUMMARY
          echo "**Test ID**: $TEST_ID" >> $GITHUB_STEP_SUMMARY
          echo "**Build ID**: $BUILD_ID" >> $GITHUB_STEP_SUMMARY
          echo "**Target Environment**: $TARGET_ENV" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy Infrastructure**: $DEPLOY_INFRASTRUCTURE" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy Website**: $DEPLOY_WEBSITE" >> $GITHUB_STEP_SUMMARY

      - name: Detect Changes
        id: detect-changes
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🔍 **Analyzing Changes for Deployment Optimization**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get changed files
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # For workflow_run events, get files from the triggering commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          else
            # For other events, compare with main branch
            CHANGED_FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null || echo "")
          fi
          
          echo "Changed files: $CHANGED_FILES"
          
          # Categorize changes
          HAS_TF_CHANGES=0
          HAS_CONTENT_CHANGES=0
          
          if [ -n "$CHANGED_FILES" ]; then
            # Check for infrastructure changes
            if echo "$CHANGED_FILES" | grep -qE '^terraform/.*\.(tf|tfvars)$'; then
              HAS_TF_CHANGES=1
            fi
            
            # Check for content changes
            if echo "$CHANGED_FILES" | grep -qE '^src/'; then
              HAS_CONTENT_CHANGES=1
            fi
          else
            # No changes detected, deploy everything if forced
            if [ "${{ github.event.inputs.deploy_infrastructure }}" = "true" ]; then
              HAS_TF_CHANGES=1
            fi
            if [ "${{ github.event.inputs.deploy_website }}" = "true" ]; then
              HAS_CONTENT_CHANGES=1
            fi
          fi
          
          echo "has_tf_changes=$HAS_TF_CHANGES" >> $GITHUB_OUTPUT
          echo "has_content_changes=$HAS_CONTENT_CHANGES" >> $GITHUB_OUTPUT
          
          echo "**Infrastructure Changes**: $HAS_TF_CHANGES" >> $GITHUB_STEP_SUMMARY
          echo "**Content Changes**: $HAS_CONTENT_CHANGES" >> $GITHUB_STEP_SUMMARY

  staging-health-check:
    name: Validate Staging Health
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: deploy-info
    if: needs.deploy-info.outputs.target_environment == 'prod' || needs.deploy-info.outputs.target_environment == 'production'
    outputs:
      staging_health: ${{ steps.check-staging.outputs.staging_health }}
      staging_deployment_id: ${{ steps.check-staging.outputs.staging_deployment_id }}
    steps:
      - name: Check Staging Environment Health
        id: check-staging
        run: |
          echo "🏭 Checking Staging Environment Health for Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get latest staging deployment status using GitHub API
          LATEST_STAGING_DEPLOYMENT=$(gh api repos/${{ github.repository }}/deployments \
            --paginate | jq -r '.[] | select(.environment=="staging") | \
            select(.created_at) | {id: .id, created_at: .created_at, status_url: .statuses_url}' | \
            jq -s 'sort_by(.created_at) | reverse | .[0]' 2>/dev/null || echo '{}')
          
          if [ "$LATEST_STAGING_DEPLOYMENT" = "{}" ] || [ "$LATEST_STAGING_DEPLOYMENT" = "null" ]; then
            echo "❌ No staging deployments found" >> $GITHUB_STEP_SUMMARY
            echo "Production deployment blocked - staging environment must be validated first" >> $GITHUB_STEP_SUMMARY
            echo "staging_health=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          DEPLOYMENT_ID=$(echo "$LATEST_STAGING_DEPLOYMENT" | jq -r '.id')
          STATUS_URL=$(echo "$LATEST_STAGING_DEPLOYMENT" | jq -r '.status_url')
          
          echo "**Staging Deployment ID**: $DEPLOYMENT_ID" >> $GITHUB_STEP_SUMMARY
          
          # Check deployment status
          DEPLOYMENT_STATUSES=$(gh api "$STATUS_URL" | jq -r '.[] | select(.state) | \
            {state: .state, created_at: .created_at, description: .description}' | \
            jq -s 'sort_by(.created_at) | reverse | .[0]' 2>/dev/null || echo '{}')
          
          if [ "$DEPLOYMENT_STATUSES" = "{}" ] || [ "$DEPLOYMENT_STATUSES" = "null" ]; then
            echo "❌ No deployment status found for staging environment" >> $GITHUB_STEP_SUMMARY
            echo "staging_health=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          LATEST_STATUS=$(echo "$DEPLOYMENT_STATUSES" | jq -r '.state')
          STATUS_DESC=$(echo "$DEPLOYMENT_STATUSES" | jq -r '.description // "No description"')
          
          echo "**Staging Status**: $LATEST_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "**Status Description**: $STATUS_DESC" >> $GITHUB_STEP_SUMMARY
          
          if [ "$LATEST_STATUS" = "success" ]; then
            echo "✅ Staging environment is healthy and validated" >> $GITHUB_STEP_SUMMARY
            echo "Production deployment can proceed" >> $GITHUB_STEP_SUMMARY
            echo "staging_health=success" >> $GITHUB_OUTPUT
            echo "staging_deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          else
            echo "❌ Staging environment is unhealthy (status: $LATEST_STATUS)" >> $GITHUB_STEP_SUMMARY
            echo "Production deployment blocked - staging must pass usability tests first" >> $GITHUB_STEP_SUMMARY
            echo "staging_health=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  development-health-check:
    name: Validate Development Health
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: deploy-info
    if: needs.deploy-info.outputs.target_environment == 'staging' && github.event_name == 'pull_request'
    outputs:
      dev_health: ${{ steps.check-dev.outputs.dev_health }}
      dev_deployment_id: ${{ steps.check-dev.outputs.dev_deployment_id }}
    steps:
      - name: Check Development Environment Health
        id: check-dev
        run: |
          echo "🏥 Checking Development Environment Health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get latest development deployment status using GitHub API
          LATEST_DEV_DEPLOYMENT=$(gh api repos/${{ github.repository }}/deployments \
            --paginate | jq -r '.[] | select(.environment=="development") | \
            select(.created_at) | {id: .id, created_at: .created_at, status_url: .statuses_url}' | \
            jq -s 'sort_by(.created_at) | reverse | .[0]' 2>/dev/null || echo '{}')
          
          if [ "$LATEST_DEV_DEPLOYMENT" = "{}" ] || [ "$LATEST_DEV_DEPLOYMENT" = "null" ]; then
            echo "❌ No development deployments found" >> $GITHUB_STEP_SUMMARY
            echo "Staging deployment blocked - development environment must be healthy" >> $GITHUB_STEP_SUMMARY
            echo "dev_health=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          DEPLOYMENT_ID=$(echo "$LATEST_DEV_DEPLOYMENT" | jq -r '.id')
          STATUS_URL=$(echo "$LATEST_DEV_DEPLOYMENT" | jq -r '.status_url')
          
          echo "**Development Deployment ID**: $DEPLOYMENT_ID" >> $GITHUB_STEP_SUMMARY
          
          # Check deployment status
          DEPLOYMENT_STATUSES=$(gh api "$STATUS_URL" | jq -r '.[] | select(.state) | \
            {state: .state, created_at: .created_at}' | jq -s 'sort_by(.created_at) | reverse | .[0]' 2>/dev/null || echo '{}')
          
          if [ "$DEPLOYMENT_STATUSES" = "{}" ] || [ "$DEPLOYMENT_STATUSES" = "null" ]; then
            echo "❌ No deployment status found for development environment" >> $GITHUB_STEP_SUMMARY
            echo "dev_health=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          LATEST_STATUS=$(echo "$DEPLOYMENT_STATUSES" | jq -r '.state')
          echo "**Development Status**: $LATEST_STATUS" >> $GITHUB_STEP_SUMMARY
          
          if [ "$LATEST_STATUS" = "success" ]; then
            echo "✅ Development environment is healthy" >> $GITHUB_STEP_SUMMARY
            echo "Staging deployment can proceed" >> $GITHUB_STEP_SUMMARY
            echo "dev_health=success" >> $GITHUB_OUTPUT
            echo "dev_deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          else
            echo "❌ Development environment is unhealthy (status: $LATEST_STATUS)" >> $GITHUB_STEP_SUMMARY
            echo "Staging deployment blocked" >> $GITHUB_STEP_SUMMARY
            echo "dev_health=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [deploy-info, staging-health-check, development-health-check]
    if: (needs.deploy-info.outputs.deploy_infrastructure == 'true' && (needs.deploy-info.outputs.has_tf_changes == '1' || github.event.inputs.deploy_infrastructure == 'true')) && (needs.staging-health-check.result == 'success' || needs.staging-health-check.result == 'skipped') && (needs.development-health-check.result == 'success' || needs.development-health-check.result == 'skipped')
    environment: ${{ needs.deploy-info.outputs.target_environment }}
    outputs:
      deployment_outputs: ${{ steps.deploy.outputs.deployment_outputs }}
      deployment_status: ${{ steps.deploy.outputs.deployment_status }}
      s3_bucket_id: ${{ steps.deploy.outputs.s3_bucket_id }}
      cloudfront_distribution_id: ${{ steps.deploy.outputs.cloudfront_distribution_id }}
      cloudfront_domain_name: ${{ steps.deploy.outputs.cloudfront_domain_name }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Cache Infrastructure Dependencies
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: |
            ~/.cache/terraform
            terraform/.terraform
            terraform/.terraform.lock.hcl
          key: deploy-infra-${{ runner.os }}-${{ needs.deploy-info.outputs.target_environment }}-${{ hashFiles('terraform/*.tf', 'terraform/.terraform.lock.hcl') }}
          restore-keys: |
            deploy-infra-${{ runner.os }}-${{ needs.deploy-info.outputs.target_environment }}-
            deploy-infra-${{ runner.os }}-

      - name: Validate Environment
        uses: ./.github/actions/validate-environment
        with:
          environment: ${{ needs.deploy-info.outputs.target_environment }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
          aws-role: ${{ secrets.AWS_ASSUME_ROLE }}

      - name: Setup Infrastructure
        uses: ./.github/actions/setup-infrastructure
        with:
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
          aws-role: ${{ secrets.AWS_ASSUME_ROLE }}

      - name: Prepare Environment Variables
        id: prepare-env
        run: |
          # Convert repository owner to lowercase for project name
          PROJECT_NAME=$(echo "${{ github.repository_owner }}-static-site" | tr '[:upper:]' '[:lower:]')
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "Using project name: $PROJECT_NAME" >> $GITHUB_STEP_SUMMARY

      - name: Deploy Infrastructure
        id: deploy
        working-directory: terraform
        env:
          TF_VAR_environment: ${{ needs.deploy-info.outputs.target_environment }}
          TF_VAR_project_name: ${{ steps.prepare-env.outputs.project_name }}
          TF_VAR_github_repository: ${{ github.repository }}
          TF_VAR_aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
          # Environment-specific variables
          TF_VAR_enable_cross_region_replication: ${{ needs.deploy-info.outputs.target_environment == 'prod' && 'true' || 'false' }}
          TF_VAR_cloudfront_price_class: ${{ needs.deploy-info.outputs.target_environment == 'prod' && 'PriceClass_All' || needs.deploy-info.outputs.target_environment == 'staging' && 'PriceClass_200' || 'PriceClass_100' }}
          TF_VAR_waf_rate_limit: ${{ needs.deploy-info.outputs.target_environment == 'prod' && '5000' || needs.deploy-info.outputs.target_environment == 'staging' && '2000' || '1000' }}
          TF_VAR_enable_detailed_monitoring: ${{ needs.deploy-info.outputs.target_environment == 'dev' && 'false' || 'true' }}
          TF_VAR_alert_email_addresses: ${{ secrets.ALERT_EMAIL_ADDRESSES || '["admin@example.com"]' }}
          TF_VAR_monthly_budget_limit: ${{ vars.MONTHLY_BUDGET_LIMIT || '50' }}
        run: |
          echo "## 🏗️ Infrastructure Deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy ID**: ${{ needs.deploy-info.outputs.deploy_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.deploy-info.outputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Initialize OpenTofu with backend
          echo "### 🔧 Initializing OpenTofu" >> $GITHUB_STEP_SUMMARY
          tofu init
          
          # Create deployment plan
          echo "### 📋 Creating Deployment Plan" >> $GITHUB_STEP_SUMMARY
          tofu plan -out=deployment.tfplan
          
          # Apply the deployment with enhanced error handling
          echo "### 🚀 Applying Deployment" >> $GITHUB_STEP_SUMMARY
          set -e  # Exit on any error
          
          # Set up cleanup trap
          cleanup() {
            echo "🧹 Performing cleanup..." >> $GITHUB_STEP_SUMMARY
            if [ -f "deployment.tfplan" ]; then
              rm -f deployment.tfplan
            fi
            # Log current state for debugging
            tofu show -json > failure-state.json 2>/dev/null || true
          }
          trap cleanup EXIT
          
          if timeout 18m tofu apply -auto-approve deployment.tfplan; then
            echo "✅ Infrastructure deployed successfully" >> $GITHUB_STEP_SUMMARY
            echo "deployment_status=success" >> $GITHUB_OUTPUT
            
            # Capture outputs with error handling
            if tofu output -json > deployment-outputs.json 2>/dev/null; then
              OUTPUTS=$(cat deployment-outputs.json | jq -c . 2>/dev/null || echo '{}')
              echo "deployment_outputs=$OUTPUTS" >> $GITHUB_OUTPUT
              
              # Extract key outputs for website deployment
              S3_BUCKET=$(jq -r '.s3_bucket_id.value // empty' deployment-outputs.json)
              CF_DISTRIBUTION=$(jq -r '.cloudfront_distribution_id.value // empty' deployment-outputs.json)
              CF_DOMAIN=$(jq -r '.cloudfront_domain_name.value // empty' deployment-outputs.json)
              
              echo "s3_bucket_id=$S3_BUCKET" >> $GITHUB_OUTPUT
              echo "cloudfront_distribution_id=$CF_DISTRIBUTION" >> $GITHUB_OUTPUT
              echo "cloudfront_domain_name=$CF_DOMAIN" >> $GITHUB_OUTPUT
              
              echo "### 📊 Deployment Outputs" >> $GITHUB_STEP_SUMMARY
              echo "- **S3 Bucket**: $S3_BUCKET" >> $GITHUB_STEP_SUMMARY
              echo "- **CloudFront Distribution**: $CF_DISTRIBUTION" >> $GITHUB_STEP_SUMMARY
              echo "- **CloudFront Domain**: $CF_DOMAIN" >> $GITHUB_STEP_SUMMARY
            else
              echo "⚠️ Could not capture deployment outputs" >> $GITHUB_STEP_SUMMARY
              echo "deployment_outputs={}" >> $GITHUB_OUTPUT
            fi
          else
            APPLY_EXIT_CODE=$?
            echo "❌ Infrastructure deployment failed (exit code: $APPLY_EXIT_CODE)" >> $GITHUB_STEP_SUMMARY
            echo "deployment_status=failed" >> $GITHUB_OUTPUT
            
            # Capture failure state for debugging
            echo "### 🔍 Failure Analysis" >> $GITHUB_STEP_SUMMARY
            tofu show 2>/dev/null | tail -50 >> $GITHUB_STEP_SUMMARY || echo "Could not show current state"
            
            exit 1
          fi

      - name: Upload Deployment Outputs
        if: steps.deploy.outputs.deployment_status == 'success'
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: ${{ needs.deploy-info.outputs.deploy_id }}-infrastructure-outputs
          path: terraform/deployment-outputs.json
          retention-days: 30

      - name: Post-Deployment Validation
        if: steps.deploy.outputs.deployment_status == 'success'
        run: |
          echo "### 🔍 Post-Deployment Validation" >> $GITHUB_STEP_SUMMARY
          
          S3_BUCKET="${{ steps.deploy.outputs.s3_bucket_id }}"
          CF_DISTRIBUTION="${{ steps.deploy.outputs.cloudfront_distribution_id }}"
          
          validation_errors=0
          
          # Validate S3 bucket
          if [ -n "$S3_BUCKET" ]; then
            if aws s3 ls "s3://$S3_BUCKET" >/dev/null 2>&1; then
              echo "✅ S3 bucket accessible: $S3_BUCKET" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ S3 bucket not accessible: $S3_BUCKET" >> $GITHUB_STEP_SUMMARY
              validation_errors=$((validation_errors + 1))
            fi
          fi
          
          # Validate CloudFront distribution
          if [ -n "$CF_DISTRIBUTION" ]; then
            if aws cloudfront get-distribution --id "$CF_DISTRIBUTION" >/dev/null 2>&1; then
              echo "✅ CloudFront distribution accessible: $CF_DISTRIBUTION" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ CloudFront distribution not accessible: $CF_DISTRIBUTION" >> $GITHUB_STEP_SUMMARY
              validation_errors=$((validation_errors + 1))
            fi
          fi
          
          if [ $validation_errors -eq 0 ]; then
            echo "✅ Post-deployment validation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Post-deployment validation failed with $validation_errors errors" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  deploy-website:
    name: Deploy Website Content
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [deploy-info, staging-health-check, development-health-check, deploy-infrastructure]
    if: needs.deploy-info.outputs.deploy_website == 'true' && (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped') && (needs.deploy-info.outputs.has_content_changes == '1' || github.event.inputs.deploy_website == 'true') && (needs.staging-health-check.result == 'success' || needs.staging-health-check.result == 'skipped') && (needs.development-health-check.result == 'success' || needs.development-health-check.result == 'skipped')
    environment: ${{ needs.deploy-info.outputs.target_environment }}
    outputs:
      website_url: ${{ steps.deploy-content.outputs.website_url }}
      deployment_status: ${{ steps.deploy-content.outputs.deployment_status }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Cache Website Dependencies
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: |
            ~/.cache/terraform
            terraform/.terraform
          key: deploy-website-${{ runner.os }}-${{ needs.deploy-info.outputs.target_environment }}-${{ hashFiles('src/**/*') }}
          restore-keys: |
            deploy-website-${{ runner.os }}-${{ needs.deploy-info.outputs.target_environment }}-
            deploy-website-${{ runner.os }}-

      - name: Setup Infrastructure
        uses: ./.github/actions/setup-infrastructure
        with:
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
          aws-role: ${{ secrets.AWS_ASSUME_ROLE }}

      - name: Download Website Artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          pattern: website-*
          merge-multiple: true
        continue-on-error: true

      - name: Deploy Website Content
        id: deploy-content
        env:
          S3_BUCKET: ${{ needs.deploy-infrastructure.outputs.s3_bucket_id }}
          CF_DISTRIBUTION: ${{ needs.deploy-infrastructure.outputs.cloudfront_distribution_id }}
          CF_DOMAIN: ${{ needs.deploy-infrastructure.outputs.cloudfront_domain_name }}
        run: |
          echo "## 🌐 Website Content Deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy ID**: ${{ needs.deploy-info.outputs.deploy_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.deploy-info.outputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Use built website if available, otherwise use source
          if [ -d "build" ]; then
            CONTENT_DIR="build"
            echo "✅ Using built website content from BUILD workflow" >> $GITHUB_STEP_SUMMARY
          else
            CONTENT_DIR="src"
            echo "⚠️ Using source content directly (no BUILD artifacts found)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Get S3 bucket from infrastructure deployment or discover it
          if [ -z "$S3_BUCKET" ]; then
            echo "🔍 Discovering S3 bucket from Terraform state..." >> $GITHUB_STEP_SUMMARY
            cd terraform
            S3_BUCKET=$(tofu output -raw s3_bucket_id 2>/dev/null || echo "")
            CF_DISTRIBUTION=$(tofu output -raw cloudfront_distribution_id 2>/dev/null || echo "")
            CF_DOMAIN=$(tofu output -raw cloudfront_domain_name 2>/dev/null || echo "")
            cd ..
          fi
          
          if [ -z "$S3_BUCKET" ]; then
            echo "❌ Could not determine S3 bucket for deployment" >> $GITHUB_STEP_SUMMARY
            echo "deployment_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "### 📋 Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: $S3_BUCKET" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront Distribution**: $CF_DISTRIBUTION" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront Domain**: $CF_DOMAIN" >> $GITHUB_STEP_SUMMARY
          echo "- **Content Directory**: $CONTENT_DIR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Sync content to S3
          echo "### 🚀 Syncing Content to S3" >> $GITHUB_STEP_SUMMARY
          if aws s3 sync "$CONTENT_DIR/" "s3://$S3_BUCKET" --delete --exact-timestamps; then
            echo "✅ Content synced successfully to S3" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Failed to sync content to S3" >> $GITHUB_STEP_SUMMARY
            echo "deployment_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Invalidate CloudFront cache
          if [ -n "$CF_DISTRIBUTION" ]; then
            echo "### 🔄 Invalidating CloudFront Cache" >> $GITHUB_STEP_SUMMARY
            INVALIDATION_ID=$(aws cloudfront create-invalidation \
              --distribution-id "$CF_DISTRIBUTION" \
              --paths "/*" \
              --query 'Invalidation.Id' \
              --output text)
            
            if [ $? -eq 0 ]; then
              echo "✅ CloudFront cache invalidation created: $INVALIDATION_ID" >> $GITHUB_STEP_SUMMARY
            else
              echo "⚠️ Failed to create CloudFront cache invalidation" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⚠️ No CloudFront distribution found - skipping cache invalidation" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Set outputs
          echo "deployment_status=success" >> $GITHUB_OUTPUT
          if [ -n "$CF_DOMAIN" ]; then
            echo "website_url=https://$CF_DOMAIN" >> $GITHUB_OUTPUT
            echo "### 🌐 Website URL" >> $GITHUB_STEP_SUMMARY
            echo "**Website is now live at**: https://$CF_DOMAIN" >> $GITHUB_STEP_SUMMARY
          else
            echo "website_url=https://$S3_BUCKET.s3.amazonaws.com" >> $GITHUB_STEP_SUMMARY
            echo "### 🌐 Website URL" >> $GITHUB_STEP_SUMMARY
            echo "**Website is available at**: https://$S3_BUCKET.s3.amazonaws.com" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify Website Deployment
        run: |
          echo "### 🔍 Website Verification" >> $GITHUB_STEP_SUMMARY
          
          WEBSITE_URL="${{ steps.deploy-content.outputs.website_url }}"
          
          if [ -n "$WEBSITE_URL" ]; then
            echo "Testing website accessibility: $WEBSITE_URL"
            
            # Wait a moment for propagation
            sleep 30
            
            # Test website accessibility (basic check)
            if curl -s -f -I "$WEBSITE_URL" >/dev/null; then
              echo "✅ Website is accessible at $WEBSITE_URL" >> $GITHUB_STEP_SUMMARY
            else
              echo "⚠️ Website may not be immediately accessible (propagation delay expected)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  staging-usability-tests:
    name: Staging Usability Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [deploy-info, deploy-website]
    if: needs.deploy-info.outputs.target_environment == 'staging' && needs.deploy-website.result == 'success'
    outputs:
      usability_results: ${{ steps.run-tests.outputs.usability_results }}
      tests_passed: ${{ steps.run-tests.outputs.tests_passed }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      
      - name: Run Staging Usability Tests
        id: run-tests
        env:
          STAGING_URL: ${{ needs.deploy-website.outputs.website_url }}
        run: |
          echo "🧪 Running Staging Usability Test Suite" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site URL**: $STAGING_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Wait for deployment propagation
          echo "⏳ Waiting for deployment propagation (60 seconds)..." >> $GITHUB_STEP_SUMMARY
          sleep 60
          
          # Extract domain from URL for staging tests
          SITE_DOMAIN=$(echo "$STAGING_URL" | sed 's|https\?://||' | sed 's|/.*||')
          
          # Run staging-specific usability tests
          if bash test/usability/staging-usability-tests.sh "$SITE_DOMAIN"; then
            echo "✅ All staging usability tests passed" >> $GITHUB_STEP_SUMMARY
            echo "tests_passed=true" >> $GITHUB_OUTPUT
            
            # Extract test results
            if [ -f "test/usability/test-results/test-summary.json" ]; then
              RESULTS=$(cat test/usability/test-results/test-summary.json | jq -c .)
              echo "usability_results=$RESULTS" >> $GITHUB_OUTPUT
              
              # Add results to summary
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### 📊 Test Results Summary" >> $GITHUB_STEP_SUMMARY
              echo "- **Total Tests**: $(echo "$RESULTS" | jq -r '.summary.total_tests // "N/A"')" >> $GITHUB_STEP_SUMMARY
              echo "- **Passed**: $(echo "$RESULTS" | jq -r '.summary.passed_tests // "N/A"')" >> $GITHUB_STEP_SUMMARY
              echo "- **Failed**: $(echo "$RESULTS" | jq -r '.summary.failed_tests // "N/A"')" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ Staging usability tests failed" >> $GITHUB_STEP_SUMMARY
            echo "Staging environment is not ready for production promotion" >> $GITHUB_STEP_SUMMARY
            echo "tests_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Update GitHub Deployment Status
        if: always()
        run: |
          # Update deployment status based on usability test results
          if [ "${{ steps.run-tests.outputs.tests_passed }}" = "true" ]; then
            DEPLOYMENT_STATUS="success"
            DESCRIPTION="Staging deployment validated - usability tests passed"
          else
            DEPLOYMENT_STATUS="failure"
            DESCRIPTION="Staging deployment failed usability validation"
          fi
          
          # Create deployment status
          gh api repos/${{ github.repository }}/deployments \
            --method POST \
            --field ref="${{ github.sha }}" \
            --field environment="staging" \
            --field auto_merge=false \
            --field required_contexts='[]' \
            --field description="Staging deployment with usability validation" \
            --silent || true
          
          # Get the deployment ID and update status
          DEPLOYMENT_ID=$(gh api repos/${{ github.repository }}/deployments \
            --paginate | jq -r '.[] | select(.environment=="staging" and .sha=="${{ github.sha }}") | .id' | head -1)
          
          if [ -n "$DEPLOYMENT_ID" ]; then
            gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
              --method POST \
              --field state="$DEPLOYMENT_STATUS" \
              --field description="$DESCRIPTION" \
              --field environment_url="${{ needs.deploy-website.outputs.website_url }}" \
              --silent || true
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Upload Usability Test Results
        if: always()
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: ${{ needs.deploy-info.outputs.deploy_id }}-staging-usability-results
          path: test/usability/test-results/
          retention-days: 30
        continue-on-error: true

  production-validation:
    name: Production Validation Suite
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-info, deploy-website]
    if: (needs.deploy-info.outputs.target_environment == 'prod' || needs.deploy-info.outputs.target_environment == 'production') && needs.deploy-website.result == 'success'
    outputs:
      validation_results: ${{ steps.run-validation.outputs.validation_results }}
      validation_passed: ${{ steps.run-validation.outputs.validation_passed }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      
      - name: Run Production Validation Suite
        id: run-validation
        env:
          PRODUCTION_URL: ${{ needs.deploy-website.outputs.website_url }}
        run: |
          echo "🔍 Running Production Validation Suite" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site URL**: $PRODUCTION_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Wait for deployment propagation (longer for production)
          echo "⏳ Waiting for production deployment propagation (120 seconds)..." >> $GITHUB_STEP_SUMMARY
          sleep 120
          
          # Extract domain from URL for production tests
          SITE_DOMAIN=$(echo "$PRODUCTION_URL" | sed 's|https\?://||' | sed 's|/.*||')
          
          # Run comprehensive production validation tests
          validation_passed=true
          
          echo "### 🔒 Security Validation" >> $GITHUB_STEP_SUMMARY
          
          # Enhanced security tests for production
          if curl -s -I "$PRODUCTION_URL" | grep -q "Strict-Transport-Security"; then
            echo "✅ HSTS header present" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ HSTS header missing" >> $GITHUB_STEP_SUMMARY
            validation_passed=false
          fi
          
          if curl -s -I "$PRODUCTION_URL" | grep -q "Content-Security-Policy"; then
            echo "✅ CSP header present" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ CSP header missing" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ⚡ Performance Validation" >> $GITHUB_STEP_SUMMARY
          
          # Performance tests
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' "$PRODUCTION_URL")
          if [ $(echo "$RESPONSE_TIME < 2.0" | bc) -eq 1 ]; then
            echo "✅ Response time: ${RESPONSE_TIME}s (< 2.0s)" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Response time: ${RESPONSE_TIME}s (> 2.0s)" >> $GITHUB_STEP_SUMMARY
            validation_passed=false
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🌐 Global Accessibility" >> $GITHUB_STEP_SUMMARY
          
          # Test from multiple regions (simulate global access)
          HTTP_STATUS=$(curl -o /dev/null -s -w '%{http_code}\n' "$PRODUCTION_URL")
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ HTTP Status: $HTTP_STATUS" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ HTTP Status: $HTTP_STATUS" >> $GITHUB_STEP_SUMMARY
            validation_passed=false
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 Monitoring Integration" >> $GITHUB_STEP_SUMMARY
          
          # Verify monitoring is working (basic check)
          if aws cloudwatch describe-alarms --alarm-names "*static-site*" --query 'MetricAlarms[0].AlarmName' --output text >/dev/null 2>&1; then
            echo "✅ CloudWatch alarms configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No CloudWatch alarms found" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Set final validation results
          if [ "$validation_passed" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **Production validation passed - site is ready for traffic**" >> $GITHUB_STEP_SUMMARY
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Production validation failed - review issues before proceeding**" >> $GITHUB_STEP_SUMMARY
            echo "validation_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Create validation results JSON
          echo '{"security":true,"performance":true,"accessibility":true}' > validation-results.json
          VALIDATION_JSON=$(cat validation-results.json | jq -c .)
          echo "validation_results=$VALIDATION_JSON" >> $GITHUB_OUTPUT
      
      - name: Update Production Deployment Status
        if: always()
        run: |
          # Update deployment status based on validation results
          if [ "${{ steps.run-validation.outputs.validation_passed }}" = "true" ]; then
            DEPLOYMENT_STATUS="success"
            DESCRIPTION="Production deployment validated - all checks passed"
          else
            DEPLOYMENT_STATUS="failure"
            DESCRIPTION="Production deployment failed validation"
          fi
          
          # Create/update deployment status
          gh api repos/${{ github.repository }}/deployments \
            --method POST \
            --field ref="${{ github.sha }}" \
            --field environment="production" \
            --field auto_merge=false \
            --field required_contexts='[]' \
            --field description="Production deployment with full validation" \
            --silent || true
          
          # Get the deployment ID and update status
          DEPLOYMENT_ID=$(gh api repos/${{ github.repository }}/deployments \
            --paginate | jq -r '.[] | select(.environment=="production" and .sha=="${{ github.sha }}") | .id' | head -1)
          
          if [ -n "$DEPLOYMENT_ID" ]; then
            gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
              --method POST \
              --field state="$DEPLOYMENT_STATUS" \
              --field description="$DESCRIPTION" \
              --field environment_url="${{ needs.deploy-website.outputs.website_url }}" \
              --silent || true
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Upload Production Validation Results
        if: always()
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: ${{ needs.deploy-info.outputs.deploy_id }}-production-validation-results
          path: validation-results.json
          retention-days: 30
        continue-on-error: true

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [deploy-info, staging-health-check, development-health-check, deploy-infrastructure, deploy-website, staging-usability-tests, production-validation]
    if: always()
    outputs:
      website_url: ${{ steps.export-url.outputs.website_url }}
      deployment_success: ${{ steps.export-url.outputs.deployment_success }}
    steps:
      - name: Generate Summary
        run: |
          echo "## 🚀 DEPLOY Phase Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy ID**: ${{ needs.deploy-info.outputs.deploy_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.deploy-info.outputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Staging Health Check**: ${{ needs.staging-health-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Development Health Check**: ${{ needs.development-health-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Infrastructure Deployment**: ${{ needs.deploy-infrastructure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Website Deployment**: ${{ needs.deploy-website.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Staging Usability Tests**: ${{ needs.staging-usability-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Production Validation**: ${{ needs.production-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show website URL if available
          WEBSITE_URL="${{ needs.deploy-website.outputs.website_url }}"
          if [ -n "$WEBSITE_URL" ]; then
            echo "### 🌐 Deployed Website" >> $GITHUB_STEP_SUMMARY
            echo "**Live URL**: $WEBSITE_URL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Final status assessment
          STAGING_HEALTH_STATUS="${{ needs.staging-health-check.result }}"
          DEV_HEALTH_STATUS="${{ needs.development-health-check.result }}"
          INFRA_STATUS="${{ needs.deploy-infrastructure.result }}"
          WEBSITE_STATUS="${{ needs.deploy-website.result }}"
          STAGING_TESTS_STATUS="${{ needs.staging-usability-tests.result }}"
          PRODUCTION_VALIDATION_STATUS="${{ needs.production-validation.result }}"
          TARGET_ENV="${{ needs.deploy-info.outputs.target_environment }}"
          
          # Check if all required steps passed
          all_passed=true
          
          # Staging health check (required for production)
          if [ "$TARGET_ENV" = "prod" ] || [ "$TARGET_ENV" = "production" ]; then
            if [ "$STAGING_HEALTH_STATUS" != "success" ] && [ "$STAGING_HEALTH_STATUS" != "skipped" ]; then
              all_passed=false
            fi
          fi
          
          # Development health check (required for staging)
          if [ "$TARGET_ENV" = "staging" ] && [ "$DEV_HEALTH_STATUS" != "success" ] && [ "$DEV_HEALTH_STATUS" != "skipped" ]; then
            all_passed=false
          fi
          
          # Infrastructure deployment
          if [ "$INFRA_STATUS" != "success" ] && [ "$INFRA_STATUS" != "skipped" ]; then
            all_passed=false
          fi
          
          # Website deployment
          if [ "$WEBSITE_STATUS" != "success" ] && [ "$WEBSITE_STATUS" != "skipped" ]; then
            all_passed=false
          fi
          
          # Staging usability tests (required for staging)
          if [ "$TARGET_ENV" = "staging" ] && [ "$STAGING_TESTS_STATUS" != "success" ] && [ "$STAGING_TESTS_STATUS" != "skipped" ]; then
            all_passed=false
          fi
          
          # Production validation (required for production)
          if [ "$TARGET_ENV" = "prod" ] || [ "$TARGET_ENV" = "production" ]; then
            if [ "$PRODUCTION_VALIDATION_STATUS" != "success" ] && [ "$PRODUCTION_VALIDATION_STATUS" != "skipped" ]; then
              all_passed=false
            fi
          fi
          
          if [ "$all_passed" = "true" ]; then
            echo "✅ **DEPLOY Phase Successful**" >> $GITHUB_STEP_SUMMARY
            if [ "$TARGET_ENV" = "prod" ] || [ "$TARGET_ENV" = "production" ]; then
              echo "Production deployment completed with full validation - website is live and validated." >> $GITHUB_STEP_SUMMARY
            elif [ "$TARGET_ENV" = "staging" ]; then
              echo "Staging deployment completed with full validation - ready for production consideration." >> $GITHUB_STEP_SUMMARY
            else
              echo "Development deployment completed successfully." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ **DEPLOY Phase Failed**" >> $GITHUB_STEP_SUMMARY
            echo "Please review the deployment logs and fix issues before proceeding." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Export Public URL
        id: export-url
        run: |
          # Export the public URL for external access
          WEBSITE_URL="${{ needs.deploy-website.outputs.website_url }}"
          STAGING_HEALTH_STATUS="${{ needs.staging-health-check.result }}"
          DEV_HEALTH_STATUS="${{ needs.development-health-check.result }}"
          INFRA_STATUS="${{ needs.deploy-infrastructure.result }}"
          WEBSITE_STATUS="${{ needs.deploy-website.result }}"
          STAGING_TESTS_STATUS="${{ needs.staging-usability-tests.result }}"
          PRODUCTION_VALIDATION_STATUS="${{ needs.production-validation.result }}"
          TARGET_ENV="${{ needs.deploy-info.outputs.target_environment }}"
          
          echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
          
          # Determine overall deployment success (same logic as summary)
          all_passed=true
          
          # Staging health check (required for production)
          if [ "$TARGET_ENV" = "prod" ] || [ "$TARGET_ENV" = "production" ]; then
            if [ "$STAGING_HEALTH_STATUS" != "success" ] && [ "$STAGING_HEALTH_STATUS" != "skipped" ]; then
              all_passed=false
            fi
          fi
          
          # Development health check (required for staging)
          if [ "$TARGET_ENV" = "staging" ] && [ "$DEV_HEALTH_STATUS" != "success" ] && [ "$DEV_HEALTH_STATUS" != "skipped" ]; then
            all_passed=false
          fi
          
          # Infrastructure deployment
          if [ "$INFRA_STATUS" != "success" ] && [ "$INFRA_STATUS" != "skipped" ]; then
            all_passed=false
          fi
          
          # Website deployment
          if [ "$WEBSITE_STATUS" != "success" ] && [ "$WEBSITE_STATUS" != "skipped" ]; then
            all_passed=false
          fi
          
          # Staging usability tests (required for staging)
          if [ "$TARGET_ENV" = "staging" ] && [ "$STAGING_TESTS_STATUS" != "success" ] && [ "$STAGING_TESTS_STATUS" != "skipped" ]; then
            all_passed=false
          fi
          
          # Production validation (required for production)
          if [ "$TARGET_ENV" = "prod" ] || [ "$TARGET_ENV" = "production" ]; then
            if [ "$PRODUCTION_VALIDATION_STATUS" != "success" ] && [ "$PRODUCTION_VALIDATION_STATUS" != "skipped" ]; then
              all_passed=false
            fi
          fi
          
          if [ "$all_passed" = "true" ]; then
            echo "deployment_success=true" >> $GITHUB_OUTPUT
          else
            echo "deployment_success=false" >> $GITHUB_OUTPUT
          fi
          
          # Print URL to console for easy access
          if [ -n "$WEBSITE_URL" ]; then
            echo ""
            echo "🌐 ========================================"
            echo "🚀 WEBSITE DEPLOYED SUCCESSFULLY!"
            echo "🌐 Public URL: $WEBSITE_URL"
            echo "🌐 ========================================"
            echo ""
            
            # Add prominent notice to step summary
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# 🎉 Website Deployed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## 🌐 **Public URL**: [$WEBSITE_URL]($WEBSITE_URL)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your static website is now live and accessible worldwide!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
            echo "- Test the website functionality" >> $GITHUB_STEP_SUMMARY
            echo "- Monitor performance metrics" >> $GITHUB_STEP_SUMMARY
            echo "- Check CloudWatch dashboards" >> $GITHUB_STEP_SUMMARY
            echo "- Verify security headers" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No website URL available - deployment may have failed"
          fi