name: TEST - Quality Gates and Validation

on:
  workflow_run:
    workflows: ["BUILD - Code Validation and Artifact Creation"]
    types: [completed]
    branches: [main, 'feature/*', 'bugfix/*', 'hotfix/*']
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build ID to test (optional)'
        required: false
        type: string
      environment:
        description: 'Target environment'
        required: false
        type: choice
        options: [dev, staging, prod]
        default: dev
      skip_build_check:
        description: 'Skip BUILD workflow dependency check'
        required: false
        type: boolean
        default: true
      force_all_jobs:
        description: 'Force all jobs to run regardless of change detection'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read
  pull-requests: write
  security-events: write

env:
  AWS_DEFAULT_REGION: us-east-1
  TF_IN_AUTOMATION: true

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  info:
    name: "📋 Test Information"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Only run if BUILD succeeded (when triggered by workflow_run) or if manual dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    outputs:
      test_id: ${{ steps.info.outputs.test_id }}
      build_id: ${{ steps.info.outputs.build_id }}
      environment: ${{ steps.info.outputs.environment }}
      has_terraform_changes: ${{ steps.detect.outputs.terraform }}
      has_website_changes: ${{ steps.detect.outputs.website }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Test Info
        id: info
        run: |
          TEST_ID="test-${{ github.run_id }}-${{ github.run_attempt }}"

          # Determine build ID
          if [ -n "${{ github.event.inputs.build_id }}" ]; then
            BUILD_ID="${{ github.event.inputs.build_id }}"
          else
            BUILD_ID="build-${{ github.event.workflow_run.id || github.run_id }}"
          fi

          # Determine environment
          ENV="${{ github.event.inputs.environment || 'dev' }}"

          echo "test_id=$TEST_ID" >> $GITHUB_OUTPUT
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "environment=$ENV" >> $GITHUB_OUTPUT

          echo "# 🧪 TEST Phase" >> $GITHUB_STEP_SUMMARY
          echo "- **Test ID**: $TEST_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID**: $BUILD_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENV" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 🔍 Job Execution Decisions" >> $GITHUB_STEP_SUMMARY
          echo "- **Force All Jobs**: ${{ github.event.inputs.force_all_jobs || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Build Check**: ${{ github.event.inputs.skip_build_check || 'false' }}" >> $GITHUB_STEP_SUMMARY

      - name: Detect Changes
        id: detect
        uses: dorny/paths-filter@v3
        with:
          filters: |
            terraform:
              - 'terraform/**'
            website:
              - 'src/**'

      - name: Debug Change Detection
        run: |
          echo "- **Terraform Changes**: ${{ steps.detect.outputs.terraform }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Website Changes**: ${{ steps.detect.outputs.website }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Execution Logic:" >> $GITHUB_STEP_SUMMARY
          echo "- **Infrastructure Tests**: Will run if terraform changes OR skip_build_check OR force_all_jobs" >> $GITHUB_STEP_SUMMARY
          echo "- **Policy Validation**: Will run if terraform changes OR skip_build_check OR force_all_jobs" >> $GITHUB_STEP_SUMMARY
          echo "- **Website Tests**: Will run if website changes OR skip_build_check OR force_all_jobs" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-Deployment Usability**: Will run if environment != dev OR force_all_jobs" >> $GITHUB_STEP_SUMMARY

  infrastructure-tests:
    name: "🏗️ Infrastructure Unit Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: info
    if: needs.info.outputs.has_terraform_changes == 'true' || github.event.inputs.skip_build_check == 'true' || github.event.inputs.force_all_jobs == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: build-artifacts-${{ needs.info.outputs.build_id }}
          path: ./artifacts

      - name: Setup Infrastructure Tools
        run: |
          echo "## 🔧 Setting up infrastructure test tools" >> $GITHUB_STEP_SUMMARY

          # Install OpenTofu for infrastructure tests
          curl -L -o /tmp/tofu.zip https://github.com/opentofu/opentofu/releases/download/v1.6.1/tofu_1.6.1_linux_amd64.zip
          unzip -q /tmp/tofu.zip -d /tmp
          sudo mv /tmp/tofu /usr/local/bin/

          # Install jq for JSON processing
          sudo apt-get update && sudo apt-get install -y jq

          echo "✅ Infrastructure tools ready" >> $GITHUB_STEP_SUMMARY

      - name: Run Comprehensive Unit Tests
        run: |
          echo "## 🏗️ Running Comprehensive Unit Tests" >> $GITHUB_STEP_SUMMARY

          # Make test script executable
          chmod +x test/unit/run-tests.sh

          # Run the comprehensive test suite
          if bash test/unit/run-tests.sh; then
            echo "✅ All unit tests passed successfully" >> $GITHUB_STEP_SUMMARY

            # Display test summary
            if [ -f "test/unit/test-results/test-summary.json" ]; then
              TOTAL_TESTS=$(jq -r '.individual_tests.total' test/unit/test-results/test-summary.json)
              PASSED_TESTS=$(jq -r '.individual_tests.passed' test/unit/test-results/test-summary.json)
              SUCCESS_RATE=$(jq -r '.individual_tests.success_rate' test/unit/test-results/test-summary.json)

              echo "**Test Results:**" >> $GITHUB_STEP_SUMMARY
              echo "- Total Tests: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
              echo "- Passed: $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY
              echo "- Success Rate: $SUCCESS_RATE%" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ Unit tests failed" >> $GITHUB_STEP_SUMMARY

            # Display failure details if available
            if [ -f "test/unit/test-results/test-summary.json" ]; then
              FAILED_TESTS=$(jq -r '.individual_tests.failed' test/unit/test-results/test-summary.json)
              echo "- Failed Tests: $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
            fi

            exit 1
          fi

      - name: Run Environment Configuration Tests
        run: |
          echo "## 🔧 Environment Configuration Validation" >> $GITHUB_STEP_SUMMARY

          # Set environment variables for testing
          export TF_VAR_environment="${{ needs.info.outputs.environment }}"
          export GITHUB_REPOSITORY="${{ github.repository }}"
          export GITHUB_REF="${{ github.ref }}"
          export GITHUB_SHA="${{ github.sha }}"
          export GITHUB_WORKFLOW="${{ github.workflow }}"
          export GITHUB_RUN_ID="${{ github.run_id }}"
          export GITHUB_RUN_NUMBER="${{ github.run_number }}"

          # Make test script executable and run
          chmod +x test/unit/test-environment-config.sh

          if bash test/unit/test-environment-config.sh; then
            echo "✅ Environment configuration tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Environment configuration tests had issues - reviewing results" >> $GITHUB_STEP_SUMMARY

            # For development, don't fail on environment config issues
            if [ "${{ needs.info.outputs.environment }}" = "dev" ]; then
              echo "ℹ️ Development environment - configuration issues noted but not blocking" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ Environment configuration validation failed for ${{ needs.info.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

      - name: Run Authentication Tests
        run: |
          echo "## 🔐 Authentication Validation" >> $GITHUB_STEP_SUMMARY

          # Set required variables for auth testing
          export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"

          # Make test script executable and run
          chmod +x test/unit/test-authentication.sh

          if bash test/unit/test-authentication.sh; then
            echo "✅ Authentication tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Authentication tests had issues - reviewing results" >> $GITHUB_STEP_SUMMARY

            # For development, don't fail on auth issues (local testing)
            if [ "${{ needs.info.outputs.environment }}" = "dev" ] && [ -z "${{ env.GITHUB_ACTIONS }}" ]; then
              echo "ℹ️ Local development - authentication tests not required" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.info.outputs.environment }}" = "dev" ]; then
              echo "⚠️ Development environment - authentication issues noted but not blocking" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ Authentication validation failed for ${{ needs.info.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

      - name: Upload Unit Test Results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results-${{ needs.info.outputs.test_id }}
          path: test/unit/test-results/
          retention-days: 7

  policy-validation:
    name: "📋 Policy Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: [info, infrastructure-tests]
    if: needs.info.outputs.has_terraform_changes == 'true' || github.event.inputs.skip_build_check == 'true' || github.event.inputs.force_all_jobs == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Infrastructure Test Results
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-test-results-${{ needs.info.outputs.test_id }}
          path: ./terraform

      - name: Setup Policy Tools
        run: |
          echo "## 🔧 Policy Tools Setup" >> $GITHUB_STEP_SUMMARY

          # Install OpenTofu
          curl -L -o /tmp/tofu.zip https://github.com/opentofu/opentofu/releases/download/v1.6.1/tofu_1.6.1_linux_amd64.zip
          unzip -q /tmp/tofu.zip -d /tmp
          sudo mv /tmp/tofu /usr/local/bin/

          # Install policy tools
          curl -L -o /tmp/opa https://github.com/open-policy-agent/opa/releases/download/v0.59.0/opa_linux_amd64_static
          chmod +x /tmp/opa
          sudo mv /tmp/opa /usr/local/bin/

          echo "✅ Policy tools ready" >> $GITHUB_STEP_SUMMARY

      - name: Policy Validation Tests
        run: |
          echo "## 📋 Policy Validation" >> $GITHUB_STEP_SUMMARY

          # Determine environment for policy enforcement
          ENV="${{ needs.info.outputs.environment }}"
          echo "- **Environment**: $ENV" >> $GITHUB_STEP_SUMMARY

          # Create basic security policies
          mkdir -p policies
          cat > policies/security.rego << 'EOF'
          package terraform.security

          # Ensure S3 buckets have encryption
          deny[msg] {
            resource := input.planned_values.root_module.resources[_]
            resource.type == "aws_s3_bucket"
            not resource.values.server_side_encryption_configuration
            msg := sprintf("S3 bucket '%s' must have encryption enabled", [resource.name])
          }

          # Ensure CloudFront distributions use HTTPS
          deny[msg] {
            resource := input.planned_values.root_module.resources[_]
            resource.type == "aws_cloudfront_distribution"
            resource.values.viewer_protocol_policy != "redirect-to-https"
            msg := sprintf("CloudFront distribution '%s' must redirect HTTP to HTTPS", [resource.name])
          }
          EOF

          # Run policy validation
          if [ -f "terraform/test.tfplan" ]; then
            tofu -chdir=terraform show -json test.tfplan > plan.json
            POLICY_VIOLATIONS=$(opa eval -d policies/ -i plan.json "data.terraform.security.deny[x]" --format pretty | grep -c "true" || echo "0")

            if [ "$POLICY_VIOLATIONS" -gt 0 ]; then
              echo "⚠️ **$POLICY_VIOLATIONS policy violation(s) found**" >> $GITHUB_STEP_SUMMARY

              # Environment-specific enforcement
              if [ "$ENV" = "prod" ]; then
                echo "❌ **PRODUCTION DEPLOYMENT BLOCKED** - Policy violations not allowed in production" >> $GITHUB_STEP_SUMMARY
                echo "Fix all policy violations before production deployment" >> $GITHUB_STEP_SUMMARY
                exit 1
              elif [ "$ENV" = "staging" ]; then
                echo "⚠️ **WARNING**: Policy violations detected but allowing staging deployment" >> $GITHUB_STEP_SUMMARY
                echo "These issues must be fixed before production deployment" >> $GITHUB_STEP_SUMMARY
              else
                echo "ℹ️ Policy violations noted for development environment" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "✅ Policy validation passed - no violations found" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "➖ No terraform plan found, skipping policy validation" >> $GITHUB_STEP_SUMMARY
          fi

  website-tests:
    name: "🌐 Website Content Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: info
    if: needs.info.outputs.has_website_changes == 'true' || github.event.inputs.skip_build_check == 'true' || github.event.inputs.force_all_jobs == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: build-artifacts-${{ needs.info.outputs.build_id }}
          path: ./artifacts

      - name: Website Tests
        run: |
          echo "## 🌐 Website Content Tests" >> $GITHUB_STEP_SUMMARY

          # Extract website artifacts if available
          if [ -f "artifacts/website-*.tar.gz" ]; then
            mkdir -p website-test
            tar -xzf artifacts/website-*.tar.gz -C website-test
          else
            cp -r src website-test
          fi

          # Test HTML structure
          ERRORS=0

          # Check for required HTML elements
          if grep -q "<title>" website-test/index.html; then
            echo "✅ index.html has title tag" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ index.html missing title tag" >> $GITHUB_STEP_SUMMARY
            ERRORS=$((ERRORS + 1))
          fi

          if grep -q "<meta.*viewport" website-test/index.html; then
            echo "✅ index.html has viewport meta tag" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ index.html missing viewport meta tag" >> $GITHUB_STEP_SUMMARY
          fi

          # Check 404 page
          if [ -f "website-test/404.html" ]; then
            echo "✅ 404.html exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ 404.html missing" >> $GITHUB_STEP_SUMMARY
            ERRORS=$((ERRORS + 1))
          fi

          # Check robots.txt
          if [ -f "website-test/robots.txt" ]; then
            echo "✅ robots.txt exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ robots.txt missing" >> $GITHUB_STEP_SUMMARY
            ERRORS=$((ERRORS + 1))
          fi

          if [ $ERRORS -gt 0 ]; then
            echo "❌ Website tests failed with $ERRORS errors" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  pre-deployment-usability:
    name: "🌐 Pre-Deployment Usability Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: info
    if: needs.info.outputs.environment != 'dev' || github.event.inputs.force_all_jobs == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pre-Deployment Usability Testing
        run: |
          echo "## 🌐 Pre-Deployment Usability Tests" >> $GITHUB_STEP_SUMMARY
          echo "**Testing current live environment before deployment**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Make usability test script executable
          chmod +x test/usability/run-usability-tests.sh

          # Run usability tests on current environment
          ENV="${{ needs.info.outputs.environment }}"
          echo "**Environment:** $ENV" >> $GITHUB_STEP_SUMMARY
          echo "**Purpose:** Validate current live environment before deploying new changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if bash test/usability/run-usability-tests.sh "$ENV"; then
            echo "✅ Pre-deployment usability tests passed" >> $GITHUB_STEP_SUMMARY
            echo "- Current $ENV environment is healthy" >> $GITHUB_STEP_SUMMARY
            echo "- Ready to proceed with deployment" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Pre-deployment usability tests detected issues" >> $GITHUB_STEP_SUMMARY
            echo "- Current $ENV environment has problems" >> $GITHUB_STEP_SUMMARY
            echo "- These issues exist before new deployment" >> $GITHUB_STEP_SUMMARY

            # For staging, warn but continue; for production, this should block
            if [ "$ENV" = "prod" ]; then
              echo "❌ **PRODUCTION DEPLOYMENT BLOCKED** - Current environment has issues" >> $GITHUB_STEP_SUMMARY
              echo "Fix current production issues before deploying" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "⚠️ Proceeding with deployment - will validate post-deployment" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload Pre-Deployment Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pre-deployment-usability-results-${{ needs.info.outputs.test_id }}
          path: test/usability/test-results/
          retention-days: 7


  summary:
    name: "📊 Test Summary"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [info, infrastructure-tests, policy-validation, website-tests, pre-deployment-usability]
    if: always()
    outputs:
      tests_passed: ${{ steps.summary.outputs.tests_passed }}
    steps:
      - name: Test Summary
        id: summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 📊 Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.infrastructure-tests.result == 'success' && '✅ Passed' || needs.infrastructure-tests.result == 'skipped' && '➖ Skipped' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "| Policy Validation | ${{ needs.policy-validation.result == 'success' && '✅ Passed' || needs.policy-validation.result == 'skipped' && '➖ Skipped' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "| Website Content | ${{ needs.website-tests.result == 'success' && '✅ Passed' || needs.website-tests.result == 'skipped' && '➖ Skipped' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-Deployment Usability | ${{ needs.pre-deployment-usability.result == 'success' && '✅ Passed' || needs.pre-deployment-usability.result == 'skipped' && '➖ Skipped' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check overall status
          FAILED_JOBS=""
          if [ "${{ needs.infrastructure-tests.result }}" = "failure" ]; then FAILED_JOBS="${FAILED_JOBS}Infrastructure "; fi
          if [ "${{ needs.policy-validation.result }}" = "failure" ]; then FAILED_JOBS="${FAILED_JOBS}Policy "; fi
          if [ "${{ needs.website-tests.result }}" = "failure" ]; then FAILED_JOBS="${FAILED_JOBS}Website "; fi
          if [ "${{ needs.pre-deployment-usability.result }}" = "failure" ]; then FAILED_JOBS="${FAILED_JOBS}Pre-Deployment-Usability "; fi

          if [ -z "$FAILED_JOBS" ]; then
            echo "🎉 **ALL TESTS PASSED** - Ready for RUN phase" >> $GITHUB_STEP_SUMMARY
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "❌ **TESTS FAILED** - Failed jobs: $FAILED_JOBS" >> $GITHUB_STEP_SUMMARY
            echo "tests_passed=false" >> $GITHUB_OUTPUT
          fi
