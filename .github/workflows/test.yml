name: TEST - Quality Gates and Validation

on:
  workflow_run:
    workflows: ["BUILD - Code Validation and Artifact Creation"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_build_check:
        description: 'Skip BUILD workflow dependency check'
        required: false
        type: boolean
        default: false
      environment:
        description: 'Target test environment'
        required: false
        type: choice
        options: [dev, staging, prod]
        default: dev

permissions:
  contents: read
  security-events: write
  actions: read
  id-token: write

env:
  AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
  OPENTOFU_VERSION: ${{ vars.OPENTOFU_VERSION }}
  TF_IN_AUTOMATION: true

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  info:
    name: "ðŸ“‹ Test Information"
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      target_environment: ${{ steps.info.outputs.target_environment }}
      test_id: ${{ steps.info.outputs.test_id }}
      commit_sha: ${{ steps.info.outputs.commit_sha }}
    steps:
      - name: Determine Test Configuration
        id: info
        run: |
          TEST_ID="test-$(date +%Y%m%d-%H%M%S)-${{ github.run_id }}"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_ENV="${{ inputs.environment }}"
            COMMIT_SHA="${{ github.sha }}"
            TRIGGER_SOURCE="manual dispatch"
            BUILD_CHECK="${{ inputs.skip_build_check }}"
          else
            # Triggered by BUILD workflow
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              if [ "${{ inputs.skip_build_check }}" != "true" ]; then
                echo "âŒ BUILD workflow failed - aborting tests"
                exit 1
              fi
            fi

            BRANCH="${{ github.event.workflow_run.head_branch }}"
            case "$BRANCH" in
              main) TARGET_ENV="staging" ;;
              *) TARGET_ENV="dev" ;;
            esac

            COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
            TRIGGER_SOURCE="automatic via BUILD workflow"
          fi

          echo "target_environment=$TARGET_ENV" >> $GITHUB_OUTPUT
          echo "test_id=$TEST_ID" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

          echo "# ðŸ§ª TEST Phase" >> $GITHUB_STEP_SUMMARY
          echo "- **Test ID**: $TEST_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $TARGET_ENV ($TRIGGER_SOURCE)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: $COMMIT_SHA" >> $GITHUB_STEP_SUMMARY

  policy-validation:
    name: "ðŸ” Authenticated Policy Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: info
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.info.outputs.commit_sha }}

      - name: Determine Target Account
        id: account
        run: |
          TARGET_ENV="${{ needs.info.outputs.target_environment }}"
          case "$TARGET_ENV" in
            dev)
              echo "account_id=${{ vars.AWS_ACCOUNT_ID_DEV }}" >> $GITHUB_OUTPUT
              echo "environment_dir=dev" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "account_id=${{ vars.AWS_ACCOUNT_ID_STAGING }}" >> $GITHUB_OUTPUT
              echo "environment_dir=staging" >> $GITHUB_OUTPUT
              ;;
            prod)
              echo "account_id=${{ vars.AWS_ACCOUNT_ID_PROD }}" >> $GITHUB_OUTPUT
              echo "environment_dir=prod" >> $GITHUB_OUTPUT
              ;;
          esac

          # Capitalize first letter for IAM role name (Dev, Staging, Prod)
          ENV_CAP="$(echo "${TARGET_ENV}" | sed 's/./\U&/')"
          echo "environment_cap=$ENV_CAP" >> $GITHUB_OUTPUT

      - name: ðŸ” Configure AWS Credentials via OIDC
        id: auth
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ steps.account.outputs.account_id }}:role/GitHubActions-StaticSite-${{ steps.account.outputs.environment_cap }}-Role
          role-session-name: github-actions-test-${{ needs.info.outputs.target_environment }}-${{ github.run_id }}
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}
          audience: sts.amazonaws.com

      - name: âœ… Verify Authentication
        id: verify
        run: |
          echo "## ðŸ” Authentication & Policy Validation - ${{ needs.info.outputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify OIDC authentication succeeded
          echo "**ðŸ” Verifying OIDC Authentication:**" >> $GITHUB_STEP_SUMMARY
          CALLER_IDENTITY=$(aws sts get-caller-identity --output json)
          ACCOUNT_ID=$(echo "$CALLER_IDENTITY" | jq -r '.Account')
          USER_ARN=$(echo "$CALLER_IDENTITY" | jq -r '.Arn')

          echo "- **Account ID**: $ACCOUNT_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Assumed Role**: $USER_ARN" >> $GITHUB_STEP_SUMMARY
          echo "âœ… OIDC authentication successful" >> $GITHUB_STEP_SUMMARY

      - name: Setup OpenTofu and Policy Tools
        run: |
          # Install OpenTofu
          curl -L -o /tmp/tofu.zip \
            https://github.com/opentofu/opentofu/releases/download/v${{ env.OPENTOFU_VERSION }}/tofu_${{ env.OPENTOFU_VERSION }}_linux_amd64.zip
          unzip -q /tmp/tofu.zip -d /tmp
          sudo mv /tmp/tofu /usr/local/bin/

          # Install Conftest
          CONFTEST_VERSION=0.62.0
          curl -L -o /tmp/conftest.tar.gz \
            https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz
          cd /tmp && tar xzf conftest.tar.gz
          sudo mv /tmp/conftest /usr/local/bin/
          chmod +x /usr/local/bin/conftest

          # Verify installations
          tofu version || exit 1
          conftest --version || exit 1
          echo "âœ… All tools installed successfully"

      - name: ðŸ“‹ Generate Authenticated Terraform Plan
        id: plan
        working-directory: terraform/environments/${{ steps.account.outputs.environment_dir }}
        env:
          TARGET_ENV: ${{ needs.info.outputs.target_environment }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“‹ Terraform Plan Generation:**" >> $GITHUB_STEP_SUMMARY

          # Create backend override to use local (ephemeral) backend
          # Override files (_override.tf) take precedence over original backend.tf
          # This approach:
          # - Uses local backend (ephemeral, destroyed after runner completes)
          # - Queries AWS directly to discover existing resources
          # - Perfect for validation workflows that don't deploy
          # - No state bucket permissions needed
          echo "ðŸ”§ Creating local backend override for validation..."
          cat > backend_override.tf <<'EOF'
terraform {
  backend "local" {
    path = "terraform.tfstate"
  }
}
EOF

          # Initialize with local backend (ephemeral, destroyed after runner completes)
          echo "ðŸ”§ Initializing Terraform with local backend..."
          tofu init -no-color

          # Configuration validation
          echo "ðŸ” Validating configuration..."
          if tofu validate -no-color; then
            echo "âœ… Configuration syntax valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Configuration validation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Generate plan with authenticated credentials
          # Plan queries AWS APIs directly to discover existing resources
          # This implicitly tests:
          # - AWS credential validity
          # - IAM permissions for all resources
          # - Data source access (STS, S3, etc.)
          echo "ðŸ“‹ Generating deployment plan (querying AWS directly)..."
          set +e
          tofu plan -no-color -out=policy.tfplan
          PLAN_EXIT_CODE=$?
          set -e

          if [ $PLAN_EXIT_CODE -ne 0 ]; then
            echo "âŒ **PLAN GENERATION FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "- This indicates authentication or permission issues" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Plan generated successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: Local (ephemeral, validation-only)" >> $GITHUB_STEP_SUMMARY
          echo "- **Credential Validation**: Implicit (plan succeeded)" >> $GITHUB_STEP_SUMMARY
          echo "- **Permission Verification**: Implicit (all resources accessible)" >> $GITHUB_STEP_SUMMARY

          # Convert plan to JSON for OPA analysis
          tofu show -json policy.tfplan > plan.json

      - name: ðŸ›¡ï¸ Run OPA Security Policy Validation
        working-directory: terraform/environments/${{ steps.account.outputs.environment_dir }}
        env:
          TARGET_ENV: ${{ needs.info.outputs.target_environment }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ›¡ï¸ OPA Security Policy Validation:**" >> $GITHUB_STEP_SUMMARY

          # Copy policy files
          cp ../../../policies/*.rego . || exit 1

          # Run security policies
          SECURITY_VIOLATIONS=0
          set +e
          conftest test --policy foundation-security.rego plan.json \
            --namespace terraform.foundation.security > security_output.txt 2>&1
          SECURITY_EXIT_CODE=$?
          set -e

          if [ $SECURITY_EXIT_CODE -eq 0 ]; then
            echo "âœ… All security policies passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Security Policy Violations Found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Violation | Resource | Issue |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|----------|-------|" >> $GITHUB_STEP_SUMMARY

            # Parse conftest output and format violations
            if [ -f security_output.txt ]; then
              grep -E "FAIL|Error:" security_output.txt | while IFS= read -r line; do
                violation=$(echo "$line" | sed 's/^FAIL - //' | sed 's/Error: //')
                echo "| Security | Infrastructure | $violation |" >> $GITHUB_STEP_SUMMARY
              done

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>ðŸ“‹ Full Security Policy Output</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat security_output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
            SECURITY_VIOLATIONS=1
          fi

          # Run compliance policies
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“‹ OPA Compliance Policy Validation:**" >> $GITHUB_STEP_SUMMARY

          set +e
          conftest test --policy foundation-compliance.rego plan.json \
            --namespace terraform.foundation.compliance > compliance_output.txt 2>&1
          COMPLIANCE_EXIT_CODE=$?
          set -e

          if [ $COMPLIANCE_EXIT_CODE -eq 0 ]; then
            echo "âœ… All compliance policies passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Compliance Policy Warnings Found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Warning | Resource | Recommendation |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|----------|----------------|" >> $GITHUB_STEP_SUMMARY

            # Parse compliance output and format warnings
            if [ -f compliance_output.txt ]; then
              grep -E "WARN|Warning:" compliance_output.txt | while IFS= read -r line; do
                warning=$(echo "$line" | sed 's/^WARN - //' | sed 's/Warning: //')
                echo "| Compliance | Infrastructure | $warning |" >> $GITHUB_STEP_SUMMARY
              done

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>ðŸ“‹ Full Compliance Policy Output</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat compliance_output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Environment-specific enforcement
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$TARGET_ENV" = "prod" ] && [ $SECURITY_VIOLATIONS -gt 0 ]; then
            echo "âŒ **VALIDATION FAILED** - Production deployment blocked" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ $SECURITY_VIOLATIONS -gt 0 ]; then
            echo "âš ï¸ **SECURITY VIOLATIONS FOUND** - Review for $TARGET_ENV" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŽ‰ **ALL VALIDATIONS PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Authentication successful" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Credentials valid" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Permissions verified" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Security policies compliant" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Compliance policies satisfied" >> $GITHUB_STEP_SUMMARY
          fi

          # Cleanup
          rm -f policy.tfplan plan.json *.rego *_output.txt

  summary:
    name: "ðŸ“Š Test Summary"
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [info, policy-validation]
    if: always()
    steps:
      - name: Test Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Test Results Summary - ${{ needs.info.outputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check unified validation status
          VALIDATION_STATUS="${{ needs.policy-validation.result }}"

          if [ "$VALIDATION_STATUS" = "success" ]; then
            echo "ðŸŽ‰ **ALL VALIDATIONS PASSED** - Ready for RUN phase" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Validation Type | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ” OIDC Authentication | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”‘ Credential Validation | âœ… Passed (via terraform plan) |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”“ Permission Verification | âœ… Passed (via terraform plan) |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ›¡ï¸ Security Policies | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“‹ Compliance Policies | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Target Environment**: ${{ needs.info.outputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
            echo "**Infrastructure Status**: Ready for deployment" >> $GITHUB_STEP_SUMMARY
          elif [ "$VALIDATION_STATUS" = "skipped" ]; then
            echo "âž– **VALIDATION SKIPPED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **VALIDATION FAILED** - Deployment blocked" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Target Environment**: ${{ needs.info.outputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
            echo "**Issue**: Review policy validation results above for details" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
