name: TEST - Quality Gates and Validation

on:
  workflow_run:
    workflows: ["BUILD - Code Validation and Artifact Creation"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_build_check:
        description: 'Skip BUILD workflow dependency check'
        required: false
        type: boolean
        default: false
      environment:
        description: 'Target test environment'
        required: false
        type: choice
        options: [dev, staging, prod]
        default: dev

permissions:
  contents: read
  security-events: write
  actions: read
  id-token: write

env:
  AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
  OPENTOFU_VERSION: ${{ vars.OPENTOFU_VERSION }}
  TF_IN_AUTOMATION: true

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  info:
    name: "ðŸ“‹ Test Information"
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      target_environment: ${{ steps.info.outputs.target_environment }}
      test_id: ${{ steps.info.outputs.test_id }}
      commit_sha: ${{ steps.info.outputs.commit_sha }}
    steps:
      - name: Determine Test Configuration
        id: info
        run: |
          TEST_ID="test-$(date +%Y%m%d-%H%M%S)-${{ github.run_id }}"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_ENV="${{ inputs.environment }}"
            COMMIT_SHA="${{ github.sha }}"
            TRIGGER_SOURCE="manual dispatch"
            BUILD_CHECK="${{ inputs.skip_build_check }}"
          else
            # Triggered by BUILD workflow
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              if [ "${{ inputs.skip_build_check }}" != "true" ]; then
                echo "âŒ BUILD workflow failed - aborting tests"
                exit 1
              fi
            fi

            BRANCH="${{ github.event.workflow_run.head_branch }}"
            case "$BRANCH" in
              main) TARGET_ENV="staging" ;;
              *) TARGET_ENV="dev" ;;
            esac

            COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
            TRIGGER_SOURCE="automatic via BUILD workflow"
          fi

          echo "target_environment=$TARGET_ENV" >> $GITHUB_OUTPUT
          echo "test_id=$TEST_ID" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

          echo "# ðŸ§ª TEST Phase" >> $GITHUB_STEP_SUMMARY
          echo "- **Test ID**: $TEST_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $TARGET_ENV ($TRIGGER_SOURCE)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: $COMMIT_SHA" >> $GITHUB_STEP_SUMMARY

  policy-validation:
    name: "ðŸ“‹ Policy Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: info
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.info.outputs.commit_sha }}

      - name: Setup OpenTofu and Policy Tools
        run: |
          # Install OpenTofu
          curl -L -o /tmp/tofu.zip \
            https://github.com/opentofu/opentofu/releases/download/v${{ env.OPENTOFU_VERSION }}/tofu_${{ env.OPENTOFU_VERSION }}_linux_amd64.zip
          unzip -q /tmp/tofu.zip -d /tmp
          sudo mv /tmp/tofu /usr/local/bin/

          # Install OPA
          OPA_VERSION=v1.8.0
          curl -L -o /tmp/opa \
            https://openpolicyagent.org/downloads/${OPA_VERSION}/opa_linux_amd64_static
          chmod +x /tmp/opa
          sudo mv /tmp/opa /usr/local/bin/

          # Install Conftest
          CONFTEST_VERSION=0.62.0
          curl -L -o /tmp/conftest.tar.gz \
            https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz
          cd /tmp && tar xzf conftest.tar.gz
          sudo mv /tmp/conftest /usr/local/bin/
          chmod +x /usr/local/bin/conftest

          # Verify installations
          echo "=== Tool Verification ==="
          tofu version || exit 1
          opa version || exit 1
          conftest --version || exit 1
          echo "âœ… All policy tools installed successfully"

      - name: Policy Validation with OPA
        working-directory: terraform/environments/staging
        env:
          TARGET_ENV: ${{ needs.info.outputs.target_environment }}
        run: |
          echo "## ðŸ“‹ Policy Validation with OPA - $TARGET_ENV" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Temporarily move existing backend configuration for policy validation
          if [ -f "backend.tf" ]; then
            mv backend.tf backend.tf.bak
          fi

          # Create local backend for policy validation
          cat > backend.tf <<EOF
          terraform {
            backend "local" {
              path = "terraform.tfstate.policy"
            }
          }
          EOF

          # Create provider override to skip AWS credential validation
          # This allows policy testing without real AWS credentials
          cat > provider_override.tf <<EOF
          provider "aws" {
            region                      = "us-east-1"
            skip_credentials_validation = true
            skip_requesting_account_id  = true
            skip_metadata_api_check     = true
            access_key                  = "mock_access_key"
            secret_key                  = "mock_secret_key"
          }
          EOF

          # Initialize with local backend for policy validation
          tofu init -reconfigure

          # Configuration validation
          echo "**ðŸ” Configuration Validation:**" >> $GITHUB_STEP_SUMMARY
          if tofu validate; then
            echo "âœ… Terraform configuration syntax is valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Terraform configuration validation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Generate plan
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“‹ Generating Plan for Policy Analysis:**" >> $GITHUB_STEP_SUMMARY

          # Remove any existing plan file
          rm -f policy.tfplan

          # Run the plan command (using staging environment defaults)
          set +e
          tofu plan -out=policy.tfplan -refresh=false
          PLAN_EXIT_CODE=$?
          set -e

          # Check if plan command succeeded
          if [ $PLAN_EXIT_CODE -ne 0 ]; then
            echo "âŒ **PLAN GENERATION FAILED** (exit code: $PLAN_EXIT_CODE)" >> $GITHUB_STEP_SUMMARY
            echo "Plan command returned non-zero exit code. Check logs for errors." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Check if plan file was created
          if [ -f "policy.tfplan" ]; then
            echo "âœ… Plan file generated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **PLAN GENERATION FAILED** - No plan file created" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Convert plan to JSON
          tofu show -json policy.tfplan > plan.json

          # Copy policy files
          cp ../../../policies/*.rego . || exit 1

          # Run security policies
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ›¡ï¸ OPA Security Policy Validation:**" >> $GITHUB_STEP_SUMMARY

          SECURITY_VIOLATIONS=0
          set +e
          conftest test --policy foundation-security.rego plan.json \
            --namespace terraform.foundation.security > security_output.txt 2>&1
          SECURITY_EXIT_CODE=$?
          set -e

          if [ $SECURITY_EXIT_CODE -eq 0 ]; then
            echo "âœ… All security policies passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Security Policy Violations Found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Violation | Resource | Issue |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|----------|-------|" >> $GITHUB_STEP_SUMMARY

            # Parse conftest output and format violations
            if [ -f security_output.txt ]; then
              grep -E "FAIL|Error:" security_output.txt | while IFS= read -r line; do
                # Extract violation details and format for table
                violation=$(echo "$line" | sed 's/^FAIL - //' | sed 's/Error: //')
                echo "| Security | Infrastructure | $violation |" >> $GITHUB_STEP_SUMMARY
              done

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>ðŸ“‹ Full Security Policy Output</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat security_output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
            SECURITY_VIOLATIONS=1
          fi

          # Run compliance policies
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“‹ OPA Compliance Policy Validation:**" >> $GITHUB_STEP_SUMMARY

          set +e
          conftest test --policy foundation-compliance.rego plan.json \
            --namespace terraform.foundation.compliance > compliance_output.txt 2>&1
          COMPLIANCE_EXIT_CODE=$?
          set -e

          if [ $COMPLIANCE_EXIT_CODE -eq 0 ]; then
            echo "âœ… All compliance policies passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Compliance Policy Warnings Found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Warning | Resource | Recommendation |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|----------|----------------|" >> $GITHUB_STEP_SUMMARY

            # Parse compliance output and format warnings
            if [ -f compliance_output.txt ]; then
              grep -E "WARN|Warning:" compliance_output.txt | while IFS= read -r line; do
                warning=$(echo "$line" | sed 's/^WARN - //' | sed 's/Warning: //')
                echo "| Compliance | Infrastructure | $warning |" >> $GITHUB_STEP_SUMMARY
              done

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>ðŸ“‹ Full Compliance Policy Output</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat compliance_output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Environment-specific enforcement
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$TARGET_ENV" = "prod" ] && [ $SECURITY_VIOLATIONS -gt 0 ]; then
            echo "âŒ **POLICY VALIDATION FAILED** - Production deployment blocked" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ $SECURITY_VIOLATIONS -gt 0 ]; then
            echo "âš ï¸ **SECURITY VIOLATIONS FOUND** - Review for $TARGET_ENV environment" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŽ‰ **ALL POLICIES COMPLIANT**" >> $GITHUB_STEP_SUMMARY
          fi

          # Cleanup: Restore original backend configuration and remove provider override
          if [ -f "backend.tf.bak" ]; then
            mv backend.tf.bak backend.tf
          fi
          rm -f provider_override.tf

  credential-validation:
    name: "ðŸ” AWS Credential Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [info, policy-validation]
    strategy:
      matrix:
        environment: [dev, staging, prod]
      fail-fast: false
    steps:
      - name: Determine Account ID
        id: account
        run: |
          ENV="${{ matrix.environment }}"
          case "$ENV" in
            dev)
              echo "account_id=${{ vars.AWS_ACCOUNT_ID_DEV }}" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "account_id=${{ vars.AWS_ACCOUNT_ID_STAGING }}" >> $GITHUB_OUTPUT
              ;;
            prod)
              echo "account_id=${{ vars.AWS_ACCOUNT_ID_PROD }}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Configure AWS Credentials via OIDC
        id: auth
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ steps.account.outputs.account_id }}:role/GitHubActions-StaticSite-${{ matrix.environment }}-Role
          role-session-name: github-actions-test-${{ matrix.environment }}-${{ github.run_id }}
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}
          audience: sts.amazonaws.com

      - name: Validate Credentials and Permissions
        run: |
          echo "## ðŸ” Credential Validation - ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify STS caller identity
          echo "**ðŸ” Verifying AWS Identity:**" >> $GITHUB_STEP_SUMMARY
          CALLER_IDENTITY=$(aws sts get-caller-identity --output json)
          ACCOUNT_ID=$(echo "$CALLER_IDENTITY" | jq -r '.Account')
          USER_ARN=$(echo "$CALLER_IDENTITY" | jq -r '.Arn')

          echo "- **Account ID**: $ACCOUNT_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Assumed Role**: $USER_ARN" >> $GITHUB_STEP_SUMMARY

          # Verify IAM role exists and is accessible
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ” Verifying IAM Role Access:**" >> $GITHUB_STEP_SUMMARY
          ROLE_NAME="GitHubActions-StaticSite-${{ matrix.environment }}-Role"

          if aws iam get-role --role-name "$ROLE_NAME" > /dev/null 2>&1; then
            echo "âœ… IAM role $ROLE_NAME is accessible" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Cannot access IAM role $ROLE_NAME (may lack iam:GetRole permission)" >> $GITHUB_STEP_SUMMARY
          fi

          # Verify S3 access (basic permission check)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ” Verifying S3 Access:**" >> $GITHUB_STEP_SUMMARY
          if aws s3 ls > /dev/null 2>&1; then
            echo "âœ… S3 access verified" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ S3 access failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Verify CloudWatch Logs access
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ” Verifying CloudWatch Logs Access:**" >> $GITHUB_STEP_SUMMARY
          if aws logs describe-log-groups --limit 1 > /dev/null 2>&1; then
            echo "âœ… CloudWatch Logs access verified" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ CloudWatch Logs access limited" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **CREDENTIAL VALIDATION PASSED** for ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY

  summary:
    name: "ðŸ“Š Test Summary"
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [info, policy-validation, credential-validation]
    if: always()
    steps:
      - name: Test Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY

          # Check Policy Validation status
          POLICY_STATUS="${{ needs.policy-validation.result }}"
          if [ "$POLICY_STATUS" = "success" ]; then
            echo "| Policy Validation | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$POLICY_STATUS" = "skipped" ]; then
            echo "| Policy Validation | âž– Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Policy Validation | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check Credential Validation status
          CREDENTIAL_STATUS="${{ needs.credential-validation.result }}"
          if [ "$CREDENTIAL_STATUS" = "success" ]; then
            echo "| Credential Validation | âœ… Passed (all environments) |" >> $GITHUB_STEP_SUMMARY
          elif [ "$CREDENTIAL_STATUS" = "skipped" ]; then
            echo "| Credential Validation | âž– Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Credential Validation | âŒ Failed (check logs for environment details) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine overall success
          if [ "$POLICY_STATUS" = "success" ] && [ "$CREDENTIAL_STATUS" = "success" ]; then
            echo "ðŸŽ‰ **ALL TESTS PASSED** - Ready for RUN phase" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âœ… Policy Compliance**: Infrastructure configuration meets security policies" >> $GITHUB_STEP_SUMMARY
            echo "**âœ… Credential Access**: OIDC authentication verified for all environments" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **TESTS FAILED** - Deployment blocked" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "$POLICY_STATUS" != "success" ]; then
              echo "**âŒ Policy Issues**: Review policy validation results above" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "$CREDENTIAL_STATUS" != "success" ]; then
              echo "**âŒ Credential Issues**: Review credential validation results above" >> $GITHUB_STEP_SUMMARY
            fi
            exit 1
          fi
