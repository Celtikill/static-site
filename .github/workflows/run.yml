name: RUN - Deployment Operations

on:
  workflow_run:
    workflows: ["TEST - Quality Gates and Validation"]
    types: [completed]
    branches: [main, 'feature/*', 'bugfix/*', 'hotfix/*']
  workflow_dispatch:
    inputs:
      test_id:
        description: 'Test ID from TEST workflow (optional)'
        required: false
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options: [dev, staging, prod]
        default: dev
      skip_test_check:
        description: 'Skip TEST workflow dependency check'
        required: false
        type: boolean
        default: false
      deploy_infrastructure:
        description: 'Deploy infrastructure changes'
        required: false
        type: boolean
        default: true
      deploy_website:
        description: 'Deploy website content'
        required: false
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read
  pull-requests: write
  deployments: write

env:
  AWS_DEFAULT_REGION: us-east-1
  TF_IN_AUTOMATION: true

concurrency:
  group: run-${{ inputs.environment || 'auto' }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run:
    name: Deploy to ${{ inputs.environment || 'auto' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only run if TEST succeeded or if manual dispatch with skip
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    environment: ${{ steps.info.outputs.target_environment }}
    outputs:
      deployment_url: ${{ steps.website.outputs.deployment_url }}
      infrastructure_outputs: ${{ steps.infrastructure.outputs.outputs }}
      deployment_status: ${{ steps.summary.outputs.status }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Info  
        id: info
        run: |
          RUN_ID="run-${{ github.run_id }}-${{ github.run_attempt }}"
          
          # Determine target environment
          if [ -n "${{ github.event.inputs.environment }}" ]; then
            TARGET_ENV="${{ github.event.inputs.environment }}"
            ENV_SOURCE="Manual Input"
          elif [[ "${{ github.event.workflow_run.head_branch || github.ref_name }}" =~ ^(feature|bugfix|hotfix)/ ]]; then
            TARGET_ENV="dev"
            ENV_SOURCE="Feature Branch Auto-Deploy"
          else
            TARGET_ENV="dev"
            ENV_SOURCE="Default"
          fi
          
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "target_environment=$TARGET_ENV" >> $GITHUB_OUTPUT
          
          echo "# ðŸš€ RUN Phase" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: $RUN_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $TARGET_ENV ($ENV_SOURCE)" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.event.workflow_run.head_branch || github.ref_name }}" >> $GITHUB_STEP_SUMMARY

      - name: Production Authorization
        if: steps.info.outputs.target_environment == 'prod'
        run: |
          echo "ðŸ” **Production Deployment Authorization**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if triggered by manual dispatch (requires authorization)
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "âŒ Production deployments require manual authorization" >> $GITHUB_STEP_SUMMARY
            echo "Use: gh workflow run run.yml --field environment=prod" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Check CODEOWNERS authorization
          ACTOR="${{ github.actor }}"
          if [ -f ".github/CODEOWNERS" ]; then
            CODE_OWNERS=$(grep -E '^(\*|/\.github/workflows/)' .github/CODEOWNERS | grep -oE '@[a-zA-Z0-9_-]+' | sort -u || echo "")
            
            if echo "$CODE_OWNERS" | grep -q "@$ACTOR"; then
              echo "âœ… **AUTHORIZED**: $ACTOR is a code owner" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **UNAUTHORIZED**: $ACTOR is not a code owner" >> $GITHUB_STEP_SUMMARY
              echo "Code owners: $CODE_OWNERS" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "âš ï¸ No CODEOWNERS file found - proceeding" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ASSUME_ROLE }}
          role-session-name: github-actions-run-${{ steps.info.outputs.run_id }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Setup Tools
        run: |
          echo "## ðŸ”§ Setting up deployment tools" >> $GITHUB_STEP_SUMMARY
          
          # Install OpenTofu
          curl -L -o /tmp/tofu.zip https://github.com/opentofu/opentofu/releases/download/v1.6.1/tofu_1.6.1_linux_amd64.zip
          unzip -q /tmp/tofu.zip -d /tmp
          sudo mv /tmp/tofu /usr/local/bin/
          
          # Install AWS CLI (if not already available)
          if ! command -v aws &> /dev/null; then
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
          fi
          
          echo "âœ… Deployment tools ready" >> $GITHUB_STEP_SUMMARY

      - name: Deploy Infrastructure
        id: infrastructure
        if: github.event.inputs.deploy_infrastructure != 'false'
        working-directory: terraform
        run: |
          echo "## ðŸ—ï¸ Infrastructure Deployment" >> $GITHUB_STEP_SUMMARY
          
          # Initialize with backend
          if tofu init -reconfigure; then
            echo "âœ… Terraform initialized" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Terraform initialization failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Plan deployment
          if tofu plan -var="environment=${{ steps.info.outputs.target_environment }}" -out=deploy.tfplan; then
            echo "âœ… Terraform plan created" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Terraform plan failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Show what will be deployed
          PLAN_SUMMARY=$(tofu show -json deploy.tfplan | jq -r '.resource_changes[] | select(.change.actions[] | . != "no-op") | "\(.change.actions | join(",")) \(.type).\(.name)"' | head -10)
          if [ -n "$PLAN_SUMMARY" ]; then
            echo "**Changes to be applied:**" >> $GITHUB_STEP_SUMMARY
            echo "$PLAN_SUMMARY" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          else
            echo "No infrastructure changes to apply" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Apply changes
          if tofu apply -auto-approve deploy.tfplan; then
            echo "âœ… Infrastructure deployment successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Infrastructure deployment failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Output important values
          OUTPUTS=$(tofu output -json 2>/dev/null || echo '{}')
          echo "outputs=$OUTPUTS" >> $GITHUB_OUTPUT
          
          # Display key outputs
          BUCKET_NAME=$(echo "$OUTPUTS" | jq -r '.s3_bucket_name.value // "N/A"')
          CLOUDFRONT_URL=$(echo "$OUTPUTS" | jq -r '.cloudfront_domain_name.value // "N/A"')
          echo "**Deployment Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- S3 Bucket: $BUCKET_NAME" >> $GITHUB_STEP_SUMMARY  
          echo "- CloudFront URL: $CLOUDFRONT_URL" >> $GITHUB_STEP_SUMMARY

      - name: Deploy Website
        id: website
        if: github.event.inputs.deploy_website != 'false'
        run: |
          echo "## ðŸŒ Website Content Deployment" >> $GITHUB_STEP_SUMMARY
          
          # Get S3 bucket name from terraform outputs or use default naming
          BUCKET_NAME=""
          if [ -f "terraform/terraform.tfstate" ]; then
            BUCKET_NAME=$(cd terraform && tofu output -raw s3_bucket_name 2>/dev/null || echo "")
          fi
          
          if [ -z "$BUCKET_NAME" ]; then
            # Fallback to conventional naming
            BUCKET_NAME="static-site-${{ steps.info.outputs.target_environment }}-$(date +%s | tail -c 6)"
            echo "âš ï¸ Using fallback bucket name: $BUCKET_NAME" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Sync website content to S3
          if aws s3 sync src/ s3://$BUCKET_NAME/ --delete --quiet; then
            echo "âœ… Website content uploaded to S3" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Website upload failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Get CloudFront distribution ID and invalidate cache
          DISTRIBUTION_ID=""
          if [ -f "terraform/terraform.tfstate" ]; then
            DISTRIBUTION_ID=$(cd terraform && tofu output -raw cloudfront_distribution_id 2>/dev/null || echo "")
          fi
          
          if [ -n "$DISTRIBUTION_ID" ]; then
            if aws cloudfront create-invalidation --distribution-id "$DISTRIBUTION_ID" --paths "/*" --query 'Invalidation.Id' --output text; then
              echo "âœ… CloudFront cache invalidated" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Cache invalidation failed (non-blocking)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No CloudFront distribution found" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Determine deployment URL
          if [ -f "terraform/terraform.tfstate" ]; then
            DEPLOYMENT_URL=$(cd terraform && tofu output -raw cloudfront_domain_name 2>/dev/null || echo "")
            if [ -n "$DEPLOYMENT_URL" ] && [[ "$DEPLOYMENT_URL" != "null" ]]; then
              DEPLOYMENT_URL="https://$DEPLOYMENT_URL"
            else
              DEPLOYMENT_URL="https://$BUCKET_NAME.s3-website-${{ env.AWS_DEFAULT_REGION }}.amazonaws.com"
            fi
          else
            DEPLOYMENT_URL="https://$BUCKET_NAME.s3-website-${{ env.AWS_DEFAULT_REGION }}.amazonaws.com"
          fi
          
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "**Website URL**: $DEPLOYMENT_URL" >> $GITHUB_STEP_SUMMARY

      - name: Post-Deployment Validation
        continue-on-error: true
        run: |
          echo "## ðŸ” Post-Deployment Validation" >> $GITHUB_STEP_SUMMARY
          
          DEPLOYMENT_URL="${{ steps.website.outputs.deployment_url }}"
          
          if [ -n "$DEPLOYMENT_URL" ]; then
            # Wait a moment for deployment to propagate
            sleep 10
            
            # Test website accessibility
            if curl -s -f -L "$DEPLOYMENT_URL" > /dev/null; then
              echo "âœ… Website is accessible" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Website may not be ready yet" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Test 404 page
            if curl -s -f -L "$DEPLOYMENT_URL/nonexistent-page" > /dev/null; then
              echo "âš ï¸ 404 handling may need verification" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… 404 handling appears correct" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No deployment URL available for testing" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Update GitHub Deployment
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const environment = '${{ steps.info.outputs.target_environment }}';
            const deploymentUrl = '${{ steps.website.outputs.deployment_url }}';
            const success = '${{ job.status }}' === 'success';
            
            // Create deployment status
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: success ? 'success' : 'failure',
              description: `Deployment to ${environment} ${success ? 'successful' : 'failed'}`,
              environment_url: deploymentUrl,
              log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });

      - name: Deployment Summary
        id: summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ github.event.inputs.deploy_infrastructure != 'false' && 'âœ… Deployed' || 'âž– Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "| Website Content | ${{ github.event.inputs.deploy_website != 'false' && 'âœ… Deployed' || 'âž– Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "ðŸŽ‰ **DEPLOYMENT SUCCESSFUL**" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
            if [ -n "${{ steps.website.outputs.deployment_url }}" ]; then
              echo "ðŸŒ **Website**: ${{ steps.website.outputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **DEPLOYMENT FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi