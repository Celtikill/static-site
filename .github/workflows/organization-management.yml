name: ORG - Organization Management (Isolated)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options: [plan, apply, destroy]
        default: plan
      scope:
        description: 'Scope of management operations'
        required: false
        type: choice
        options: [all, organization, roles]
        default: all
      import_mode:
        description: 'Import existing accounts instead of creating new'
        required: false
        type: boolean
        default: true
      create_mode:
        description: 'Create new accounts (for fresh demo setup)'
        required: false
        type: boolean
        default: false
      target_environments:
        description: 'Target environments for role operations (comma-separated or "all")'
        required: false
        type: string
        default: 'all'
      confirm_destruction:
        description: 'Type "CONFIRM" to allow destructive operations'
        required: false
        type: string
        default: ''

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
  OPENTOFU_VERSION: ${{ vars.OPENTOFU_VERSION }}
  TF_IN_AUTOMATION: true
  TF_CLI_ARGS: "-no-color"
  NO_COLOR: 1

concurrency:
  group: org-management-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validation:
    name: "🔍 Pre-flight Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_proceed: ${{ steps.validate.outputs.should_proceed }}
      action: ${{ steps.validate.outputs.action }}

    steps:
      - name: Validate inputs
        id: validate
        run: |
          echo "Validating organization management workflow inputs..."

          # Validate action
          if [[ "${{ inputs.action }}" == "destroy" && "${{ inputs.confirm_destruction }}" != "CONFIRM" ]]; then
            echo "❌ Destructive action requires confirmation"
            echo "should_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Validate mode consistency
          if [[ "${{ inputs.import_mode }}" == "true" && "${{ inputs.create_mode }}" == "true" ]]; then
            echo "❌ Cannot enable both import_mode and create_mode"
            echo "should_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "✅ Validation passed"
          echo "should_proceed=true" >> $GITHUB_OUTPUT
          echo "action=${{ inputs.action }}" >> $GITHUB_OUTPUT

  organization-management:
    name: "🏢 Organization Management - ${{ inputs.action }}"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: validation
    if: needs.validation.outputs.should_proceed == 'true'
    environment:
      name: management
      url: https://console.aws.amazon.com/organizations/v2/home

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4


      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ASSUME_ROLE_CENTRAL }}
          role-session-name: GitHubActions-OrgManagement-${{ github.run_id }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}

      - name: Verify AWS access
        run: |
          echo "🔐 Verifying AWS access..."
          aws sts get-caller-identity
          aws organizations describe-organization --output table || echo "⚠️  Organization may not exist yet"

      - name: Initialize Terraform
        working-directory: terraform/foundations/org-management
        run: |
          echo "🚀 Initializing Terraform for organization management..."
          tofu init -upgrade

      - name: Configure Terraform variables
        working-directory: terraform/foundations/org-management
        run: |
          echo "⚙️  Configuring Terraform variables..."
          cat > terraform.tfvars <<EOF
          import_existing_accounts = ${{ inputs.import_mode }}
          create_new_accounts = ${{ inputs.create_mode }}
          aws_region = "${{ env.AWS_DEFAULT_REGION }}"
          github_repo = "${{ github.repository }}"
          organization_name = "static-site-org"
          EOF

          echo "📄 Generated terraform.tfvars:"
          cat terraform.tfvars

      - name: Terraform Plan
        working-directory: terraform/foundations/org-management
        run: |
          echo "📋 Running Terraform plan..."
          tofu plan -detailed-exitcode -out=tfplan

          # Store plan result
          echo "PLAN_RESULT=$?" >> $GITHUB_ENV

      - name: Display Plan Summary
        working-directory: terraform/foundations/org-management
        if: always()
        run: |
          if [[ "$PLAN_RESULT" == "0" ]]; then
            echo "✅ No changes required"
          elif [[ "$PLAN_RESULT" == "2" ]]; then
            echo "📝 Changes detected - plan saved to tfplan"
            echo ""
            echo "### Plan Summary"
            tofu show -no-color tfplan | head -50
          else
            echo "❌ Plan failed"
            exit 1
          fi

      - name: Terraform Apply
        working-directory: terraform/foundations/org-management
        if: inputs.action == 'apply' && env.PLAN_RESULT == '2'
        run: |
          echo "🚀 Applying Terraform changes..."
          tofu apply -auto-approve tfplan

          echo ""
          echo "### Applied Changes Summary"
          tofu output -json | jq .

      - name: Terraform Destroy
        working-directory: terraform/foundations/org-management
        if: inputs.action == 'destroy'
        run: |
          echo "🗑️  Destroying organization management infrastructure..."
          echo "⚠️  This will remove organization structure, accounts, and policies"
          tofu destroy -auto-approve

      - name: Organization Status
        if: always() && (inputs.action == 'plan' || inputs.action == 'apply')
        run: |
          echo "🏢 Current Organization Status:"
          echo ""

          # Organization overview
          aws organizations describe-organization --output table 2>/dev/null || echo "No organization found"

          echo ""
          echo "📊 Organizational Units:"
          aws organizations list-organizational-units-for-parent \
            --parent-id $(aws organizations list-roots --query 'Roots[0].Id' --output text 2>/dev/null) \
            --output table 2>/dev/null || echo "No OUs found"

          echo ""
          echo "👥 Accounts:"
          aws organizations list-accounts --output table 2>/dev/null || echo "No accounts found"

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        if: inputs.action == 'plan' && env.PLAN_RESULT == '2'
        with:
          name: org-management-plan-${{ github.run_id }}
          path: terraform/foundations/org-management/tfplan
          retention-days: 7

  cross-account-roles:
    name: "🔐 Cross-Account Role Management"
    if: inputs.scope == 'all' || inputs.scope == 'roles'
    uses: ./.github/workflows/reusable-cross-account-roles.yml
    with:
      account_mapping: |
        {
          "dev": "822529998967",
          "staging": "927588814642",
          "prod": "546274483801"
        }
      external_id: "github-actions-static-site"
      management_account_id: "223938610551"
      action: ${{ inputs.action }}
      target_environments: ${{ inputs.target_environments }}
    secrets:
      aws_role_arn: ${{ secrets.AWS_ASSUME_ROLE_CENTRAL }}

  summary:
    name: "📊 Workflow Summary"
    runs-on: ubuntu-latest
    needs: [validation, organization-management, cross-account-roles]
    if: always()

    steps:
      - name: Workflow Summary
        run: |
          echo "## Organization Management Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scope:** ${{ inputs.scope }}" >> $GITHUB_STEP_SUMMARY
          echo "**Import Mode:** ${{ inputs.import_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Create Mode:** ${{ inputs.create_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Environments:** ${{ inputs.target_environments }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Organization Management Status
          if [[ "${{ inputs.scope }}" == "all" || "${{ inputs.scope }}" == "organization" ]]; then
            echo "### 🏛️ Organization Management" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.organization-management.result }}" == "success" ]]; then
              echo "✅ **Organization setup completed successfully**" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.organization-management.result }}" == "failure" ]]; then
              echo "❌ **Organization setup failed** - Check logs for details" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.organization-management.result }}" == "skipped" ]]; then
              echo "⏭️ **Organization setup skipped**" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Cross-Account Roles Status
          if [[ "${{ inputs.scope }}" == "all" || "${{ inputs.scope }}" == "roles" ]]; then
            echo "### 🔐 Cross-Account Roles" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.cross-account-roles.result }}" == "success" ]]; then
              echo "✅ **Cross-account roles managed successfully**" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.cross-account-roles.result }}" == "failure" ]]; then
              echo "❌ **Cross-account roles failed** - Check logs for details" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.cross-account-roles.result }}" == "skipped" ]]; then
              echo "⏭️ **Cross-account roles skipped**" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Overall Status
          if [[ "${{ needs.validation.result }}" == "failure" ]]; then
            echo "❌ **Overall Status: Validation Failed** - Check input parameters" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.organization-management.result }}" == "success" && "${{ needs.cross-account-roles.result }}" == "success" ]]; then
            echo "✅ **Overall Status: All Operations Completed Successfully**" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.organization-management.result }}" == "failure" || "${{ needs.cross-account-roles.result }}" == "failure" ]]; then
            echo "❌ **Overall Status: Some Operations Failed** - Check individual job logs" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ **Overall Status: Operations Completed** - Some jobs may have been skipped" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Review organization structure in AWS Console" >> $GITHUB_STEP_SUMMARY
          echo "- Verify cross-account roles can be assumed" >> $GITHUB_STEP_SUMMARY
          echo "- Test GitHub Actions deployment workflows" >> $GITHUB_STEP_SUMMARY
          echo "- Update GitHub secrets if needed" >> $GITHUB_STEP_SUMMARY