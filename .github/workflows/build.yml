name: BUILD - Code Validation and Artifact Creation

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: false
        type: choice
        options: [dev, staging, prod]
        default: dev
      force_build:
        description: 'Force build all components'
        required: false
        type: boolean
        default: false
  pull_request:
    branches: [main]
  push:
    branches: [main, 'feature/*', 'bugfix/*', 'hotfix/*']

permissions:
  id-token: write
  contents: read
  pull-requests: write
  security-events: write

env:
  # AWS Configuration
  AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION || 'us-east-1' }}
  MANAGEMENT_ACCOUNT_ID: ${{ vars.MANAGEMENT_ACCOUNT_ID }}
  AWS_ACCOUNT_ID_DEV: ${{ vars.AWS_ACCOUNT_ID_DEV }}
  AWS_ACCOUNT_ID_STAGING: ${{ vars.AWS_ACCOUNT_ID_STAGING }}
  AWS_ACCOUNT_ID_PROD: ${{ vars.AWS_ACCOUNT_ID_PROD }}

  # Project Identity (use built-in GitHub context vars)
  REPO_FULL_NAME: ${{ github.repository }}
  REPO_OWNER: ${{ github.repository_owner }}
  PROJECT_NAME: ${{ vars.PROJECT_NAME || 'celtikill-static-site' }}
  PROJECT_SHORT_NAME: ${{ vars.PROJECT_SHORT_NAME || 'static-site' }}
  EXTERNAL_ID: ${{ vars.EXTERNAL_ID || 'github-actions-static-site' }}

  # Infrastructure Tools
  OPENTOFU_VERSION: ${{ vars.OPENTOFU_VERSION || '1.8.4' }}
  TF_IN_AUTOMATION: true
  TF_CLI_ARGS: "-no-color"

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  info:
    name: "ðŸ“‹ Build Information"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      build_id: ${{ steps.info.outputs.build_id }}
      environment: ${{ steps.info.outputs.environment }}
      has_terraform_changes: ${{ steps.changes.outputs.terraform }}
      has_content_changes: ${{ steps.changes.outputs.content }}
      has_workflow_changes: ${{ steps.changes.outputs.workflows }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build Info
        id: info
        run: |
          BUILD_ID="build-${{ github.run_id }}-${{ github.run_attempt }}"
          ENV="${{ github.event.inputs.environment || 'dev' }}"

          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "environment=$ENV" >> $GITHUB_OUTPUT

          echo "# ðŸ—ï¸ BUILD Phase" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID**: $BUILD_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENV" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

      - name: Detect Changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            terraform:
              - 'terraform/**'
            content:
              - 'src/**'
            workflows:
              - '.github/workflows/**'
            docs:
              - '**/*.md'
            tests:
              - 'test/**'

  infrastructure:
    name: "ðŸ—ï¸ Infrastructure Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: info
    if: needs.info.outputs.has_terraform_changes == 'true' || github.event.inputs.force_build == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Infrastructure Tools
        run: |
          echo "## ðŸ”§ Infrastructure Tools Setup" >> $GITHUB_STEP_SUMMARY

          # Install OpenTofu
          curl -L -o /tmp/tofu.zip https://github.com/opentofu/opentofu/releases/download/v${{ env.OPENTOFU_VERSION }}/tofu_${{ env.OPENTOFU_VERSION }}_linux_amd64.zip
          unzip -q /tmp/tofu.zip -d /tmp
          sudo mv /tmp/tofu /usr/local/bin/
          echo "âœ… OpenTofu installed: $(tofu version)" >> $GITHUB_STEP_SUMMARY

      - name: Validate Terraform
        working-directory: terraform
        run: |
          echo "## âœ… Terraform Validation" >> $GITHUB_STEP_SUMMARY

          # Format check
          if tofu fmt -check -recursive; then
            echo "âœ… Format check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Format check failed - run 'tofu fmt -recursive'" >> $GITHUB_STEP_SUMMARY
            echo "**Files needing formatting:**" >> $GITHUB_STEP_SUMMARY
            tofu fmt -recursive -diff | head -20 >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Initialize without backend for validation
          cp backend.tf backend.tf.bak 2>/dev/null || true
          rm -f backend.tf

          if tofu init -backend=false; then
            echo "âœ… Init successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Init failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Validate configuration
          if tofu validate; then
            echo "âœ… Validation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Validation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Restore backend file
          mv backend.tf.bak backend.tf 2>/dev/null || true

      - name: Validate Environment Outputs
        working-directory: terraform
        run: |
          echo "## ðŸ“‹ Environment Outputs Validation" >> $GITHUB_STEP_SUMMARY

          REQUIRED_OUTPUTS=("s3_bucket_id" "s3_bucket_name" "website_url" "cloudwatch_dashboard_url" "deployment_info")
          VALIDATION_ERRORS=0

          for env in dev staging prod; do
            OUTPUTS_FILE="environments/${env}/outputs.tf"

            if [ ! -f "$OUTPUTS_FILE" ]; then
              echo "âŒ Missing outputs.tf for ${env} environment" >> $GITHUB_STEP_SUMMARY
              VALIDATION_ERRORS=$((VALIDATION_ERRORS + 1))
              continue
            fi

            echo "**${env} environment:**" >> $GITHUB_STEP_SUMMARY

            for output in "${REQUIRED_OUTPUTS[@]}"; do
              if grep -q "output \"${output}\"" "$OUTPUTS_FILE"; then
                echo "- âœ… ${output}" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âŒ ${output} (missing)" >> $GITHUB_STEP_SUMMARY
                VALIDATION_ERRORS=$((VALIDATION_ERRORS + 1))
              fi
            done

            echo "" >> $GITHUB_STEP_SUMMARY
          done

          if [ $VALIDATION_ERRORS -gt 0 ]; then
            echo "âŒ **Output validation failed** - ${VALIDATION_ERRORS} errors found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Required outputs:** s3_bucket_id, s3_bucket_name, website_url, cloudwatch_dashboard_url, deployment_info" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** s3_bucket_name must be an alias for s3_bucket_id for workflow compatibility" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **All required outputs present** in all environments" >> $GITHUB_STEP_SUMMARY
          fi

  security-checkov:
    name: "ðŸ”’ Checkov Security Scan"
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: info
    if: needs.info.outputs.has_terraform_changes == 'true' || github.event.inputs.force_build == 'true'
    outputs:
      checkov_exit: ${{ steps.scan.outputs.checkov_exit }}
      checkov_critical: ${{ steps.scan.outputs.checkov_critical }}
      checkov_high: ${{ steps.scan.outputs.checkov_high }}
      checkov_total: ${{ steps.scan.outputs.checkov_total }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Checkov
        run: |
          echo "## ðŸ”§ Checkov Setup" >> $GITHUB_STEP_SUMMARY
          pip3 install checkov --quiet
          echo "âœ… Checkov installed: $(checkov --version)" >> $GITHUB_STEP_SUMMARY


      - name: Security Scanning - Checkov
        id: scan
        run: |
          echo "## ðŸ”’ Checkov Security Analysis" >> $GITHUB_STEP_SUMMARY

          # Run Checkov with JSON output
          checkov -d terraform --framework terraform -o json --skip-check CKV_AWS_20,CKV_AWS_117 --quiet > checkov-results.json || CHECKOV_EXIT=$?

          # Set default exit code if not set
          CHECKOV_EXIT=${CHECKOV_EXIT:-0}

          # Debug: Check if file was created
          if [ ! -f "checkov-results.json" ]; then
            echo "âš ï¸ Checkov results file not created, running with CLI output..." >> $GITHUB_STEP_SUMMARY
            checkov -d terraform --framework terraform --output cli --skip-check CKV_AWS_20,CKV_AWS_117 > checkov-cli.txt 2>&1 || true
            echo '{"results": {"passed_checks": [], "failed_checks": []}}' > checkov-results.json
          fi

          # Parse and display results
          if [ -f "checkov-results.json" ]; then
            # Count findings by severity
            CRITICAL_COUNT=$(jq '[.results.failed_checks[]? | select(.severity == "CRITICAL")] | length' checkov-results.json 2>/dev/null || echo "0")
            HIGH_COUNT=$(jq '[.results.failed_checks[]? | select(.severity == "HIGH")] | length' checkov-results.json 2>/dev/null || echo "0")
            MEDIUM_COUNT=$(jq '[.results.failed_checks[]? | select(.severity == "MEDIUM")] | length' checkov-results.json 2>/dev/null || echo "0")
            LOW_COUNT=$(jq '[.results.failed_checks[]? | select(.severity == "LOW")] | length' checkov-results.json 2>/dev/null || echo "0")
            TOTAL_FAILED=$(jq '.results.failed_checks | length' checkov-results.json 2>/dev/null || echo "0")
            TOTAL_PASSED=$(jq '.results.passed_checks | length' checkov-results.json 2>/dev/null || echo "0")

            # If no severity classification, treat all as medium
            if [ "$CRITICAL_COUNT" = "0" ] && [ "$HIGH_COUNT" = "0" ] && [ "$MEDIUM_COUNT" = "0" ] && [ "$LOW_COUNT" = "0" ] && [ "$TOTAL_FAILED" -gt "0" ]; then
              MEDIUM_COUNT=$TOTAL_FAILED
            fi

            TOTAL_FINDINGS=$((CRITICAL_COUNT + HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))

            # Display detailed results
            echo "### ðŸ“Š Checkov Results Summary" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ **Critical**: $CRITICAL_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ  **High**: $HIGH_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ **Medium**: $MEDIUM_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”µ **Low**: $LOW_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Passed**: $TOTAL_PASSED checks" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Issues**: $TOTAL_FINDINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show sample findings if any exist
            if [ "$TOTAL_FINDINGS" -gt "0" ]; then
              echo "### ðŸ” Sample Checkov Findings (Top 5)" >> $GITHUB_STEP_SUMMARY
              jq -r '.results.failed_checks[]? | "- **" + (.check_id // "Unknown") + "**: " + (.check_name // "No description") + " (File: " + (.file_path // "Unknown") + ")"' checkov-results.json 2>/dev/null | head -5 >> $GITHUB_STEP_SUMMARY || echo "- No detailed findings available" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Checkov results file not found" >> $GITHUB_STEP_SUMMARY
            CHECKOV_EXIT=1
          fi

          # Create summary artifact
          cat > checkov-security-summary.md << EOF
          # Checkov Security Analysis Report

          **Build ID**: ${{ needs.info.outputs.build_id }}
          **Scan Date**: $(date -u)
          **Status**: $([ $CHECKOV_EXIT -eq 0 ] && echo "PASSED" || echo "FAILED")

          ## Summary
          - **Critical**: $CRITICAL_COUNT
          - **High**: $HIGH_COUNT
          - **Medium**: $MEDIUM_COUNT
          - **Low**: $LOW_COUNT
          - **Total Issues**: $TOTAL_FINDINGS
          - **Passed Checks**: $TOTAL_PASSED
          EOF

          # Set output for next steps
          echo "checkov_exit=$CHECKOV_EXIT" >> $GITHUB_OUTPUT
          echo "checkov_critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "checkov_high=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "checkov_total=$TOTAL_FINDINGS" >> $GITHUB_OUTPUT

          # Determine success based on actual findings, not exit code
          if [ "$CRITICAL_COUNT" -eq "0" ] && [ "$HIGH_COUNT" -eq "0" ]; then
            echo "âœ… **Checkov scan completed successfully - No critical or high severity issues found**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Checkov found security issues** (Critical: $CRITICAL_COUNT, High: $HIGH_COUNT)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Checkov Results
        uses: actions/upload-artifact@v4
        with:
          name: checkov-results-${{ needs.info.outputs.build_id }}
          path: |
            checkov-security-summary.md
            checkov-results.json
          retention-days: 7

  security-trivy:
    name: "ðŸ›¡ï¸ Trivy Security Scan"
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: info
    if: needs.info.outputs.has_terraform_changes == 'true' || github.event.inputs.force_build == 'true'
    outputs:
      trivy_exit: ${{ steps.scan.outputs.trivy_exit }}
      trivy_critical: ${{ steps.scan.outputs.trivy_critical }}
      trivy_high: ${{ steps.scan.outputs.trivy_high }}
      trivy_total: ${{ steps.scan.outputs.trivy_total }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Trivy
        run: |
          echo "## ðŸ”§ Trivy Setup" >> $GITHUB_STEP_SUMMARY
          wget -qO- https://github.com/aquasecurity/trivy/releases/download/v0.48.3/trivy_0.48.3_Linux-64bit.tar.gz | tar xzf - -C /tmp
          sudo mv /tmp/trivy /usr/local/bin/
          echo "âœ… Trivy installed: $(trivy --version)" >> $GITHUB_STEP_SUMMARY

      - name: Security Scanning - Trivy
        id: scan
        run: |
          echo "## ðŸ›¡ï¸ Trivy Security Analysis" >> $GITHUB_STEP_SUMMARY
          # Debug ignore file status
          if [ -f ".trivyignore" ]; then
            echo "âœ… Found .trivyignore file with $(wc -l < .trivyignore) lines" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ Ignored items: $(grep -v '^#' .trivyignore | grep -v '^$' | wc -l) rules" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No .trivyignore file found" >> $GITHUB_STEP_SUMMARY
          fi

          # Run Trivy with JSON output (uses .trivyignore automatically if present)
          if trivy fs --security-checks vuln,config --format json --output trivy-results.json terraform/; then
            TRIVY_EXIT=0
          else
            TRIVY_EXIT=1
          fi

          # Parse and display results
          if [ -f "trivy-results.json" ]; then
            # Count findings by severity
            CRITICAL_COUNT=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "CRITICAL")] | length' trivy-results.json 2>/dev/null || echo "0")
            HIGH_COUNT=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "HIGH")] | length' trivy-results.json 2>/dev/null || echo "0")
            MEDIUM_COUNT=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "MEDIUM")] | length' trivy-results.json 2>/dev/null || echo "0")
            LOW_COUNT=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "LOW")] | length' trivy-results.json 2>/dev/null || echo "0")
            TOTAL_FINDINGS=$((CRITICAL_COUNT + HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))

            # Display detailed results
            echo "### ðŸ“Š Trivy Results Summary" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ **Critical**: $CRITICAL_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ  **High**: $HIGH_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ **Medium**: $MEDIUM_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”µ **Low**: $LOW_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Issues**: $TOTAL_FINDINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show sample findings if any exist
            if [ "$TOTAL_FINDINGS" -gt "0" ]; then
              echo "### ðŸ” Sample Trivy Findings (Top 5)" >> $GITHUB_STEP_SUMMARY
              jq -r '.Results[]?.Misconfigurations[]? | "- **" + (.ID // "Unknown") + "**: " + (.Title // "No description") + " (Severity: " + (.Severity // "Unknown") + ")"' trivy-results.json 2>/dev/null | head -5 >> $GITHUB_STEP_SUMMARY || echo "- No detailed findings available" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Trivy results file not found" >> $GITHUB_STEP_SUMMARY
            TRIVY_EXIT=1
          fi

          # Create summary artifact
          cat > trivy-security-summary.md << EOF
          # Trivy Security Analysis Report

          **Build ID**: ${{ needs.info.outputs.build_id }}
          **Scan Date**: $(date -u)
          **Status**: $([ $CRITICAL_COUNT -eq 0 ] && [ $HIGH_COUNT -eq 0 ] && echo "PASSED" || echo "FAILED")

          ## Summary
          - **Critical**: $CRITICAL_COUNT
          - **High**: $HIGH_COUNT
          - **Medium**: $MEDIUM_COUNT
          - **Low**: $LOW_COUNT
          - **Total Issues**: $TOTAL_FINDINGS
          EOF

          # Set output for next steps
          echo "trivy_exit=$TRIVY_EXIT" >> $GITHUB_OUTPUT
          echo "trivy_critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "trivy_high=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "trivy_total=$TOTAL_FINDINGS" >> $GITHUB_OUTPUT

          if [ $TRIVY_EXIT -eq 0 ]; then
            echo "âœ… **Trivy scan completed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Trivy found security issues**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Trivy Results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-${{ needs.info.outputs.build_id }}
          path: |
            trivy-security-summary.md
            trivy-results.json
          retention-days: 7

  security-analysis:
    name: "ðŸ“Š Security Analysis"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [info, security-checkov, security-trivy]
    if: always() && (needs.security-checkov.result != 'skipped' || needs.security-trivy.result != 'skipped')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process Security Results
        run: |
          echo "## ðŸ Security Results Summary" >> $GITHUB_STEP_SUMMARY

          # Get results from previous steps
          CHECKOV_EXIT="${{ needs.security-checkov.outputs.checkov_exit || '0' }}"
          TRIVY_EXIT="${{ needs.security-trivy.outputs.trivy_exit || '0' }}"
          CHECKOV_CRITICAL="${{ needs.security-checkov.outputs.checkov_critical || '0' }}"
          TRIVY_CRITICAL="${{ needs.security-trivy.outputs.trivy_critical || '0' }}"
          CHECKOV_HIGH="${{ needs.security-checkov.outputs.checkov_high || '0' }}"
          TRIVY_HIGH="${{ needs.security-trivy.outputs.trivy_high || '0' }}"

          TOTAL_CRITICAL=$((CHECKOV_CRITICAL + TRIVY_CRITICAL))
          TOTAL_HIGH=$((CHECKOV_HIGH + TRIVY_HIGH))
          SECURITY_ERRORS=0

          # Apply blocking logic for critical/high findings
          if [ $TOTAL_CRITICAL -gt 0 ]; then
            echo "ðŸ”´ **CRITICAL SECURITY ISSUES**: $TOTAL_CRITICAL findings" >> $GITHUB_STEP_SUMMARY
            SECURITY_ERRORS=$((SECURITY_ERRORS + 1))
          fi

          if [ $TOTAL_HIGH -gt 0 ]; then
            echo "ðŸŸ  **HIGH SECURITY ISSUES**: $TOTAL_HIGH findings" >> $GITHUB_STEP_SUMMARY
            SECURITY_ERRORS=$((SECURITY_ERRORS + 1))
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Overall Security Status" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status | Critical | High |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov | $([ $CHECKOV_CRITICAL -eq 0 ] && [ $CHECKOV_HIGH -eq 0 ] && echo "âœ… PASS" || echo "âŒ FAIL") | $CHECKOV_CRITICAL | $CHECKOV_HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy   | $([ $TRIVY_CRITICAL -eq 0 ] && [ $TRIVY_HIGH -eq 0 ] && echo "âœ… PASS" || echo "âŒ FAIL") | $TRIVY_CRITICAL | $TRIVY_HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$([ $SECURITY_ERRORS -eq 0 ] && echo "âœ… PASS" || echo "âŒ FAIL")** | **$TOTAL_CRITICAL** | **$TOTAL_HIGH** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Final decision
          if [ $SECURITY_ERRORS -gt 0 ]; then
            echo "ðŸš¨ **BUILD FAILED** - Critical or High security findings detected" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required**: Fix security issues before deployment" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **All security scans passed** - No critical or high severity findings" >> $GITHUB_STEP_SUMMARY
          fi

  website:
    name: "ðŸŒ Website Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: info
    if: needs.info.outputs.has_content_changes == 'true' || github.event.inputs.force_build == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Website Content
        run: |
          echo "## ðŸŒ Website Content Validation" >> $GITHUB_STEP_SUMMARY

          # Check required files
          REQUIRED_FILES=("src/index.html" "src/404.html" "src/robots.txt")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ $file missing" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          done

          # Basic HTML validation (non-blocking)
          if command -v html5validator >/dev/null 2>&1 || pip3 install html5validator --quiet; then
            html5validator --root src/ --also-check-css && echo "âœ… HTML validation passed" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ HTML validation warnings (non-blocking)" >> $GITHUB_STEP_SUMMARY || true
          fi

  cost-projection:
    name: "ðŸ“Š Cost Projection"
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: [info, infrastructure]
    if: needs.info.outputs.has_terraform_changes == 'true' || github.event.inputs.force_build == 'true'
    outputs:
      monthly_cost: ${{ steps.calculate.outputs.monthly_cost }}
      budget_status: ${{ steps.calculate.outputs.budget_status }}
      cost_report_available: ${{ steps.calculate.outputs.cost_report_available }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Calculate Cost Projection
        id: calculate
        run: |
          echo "## ðŸ“Š Cost Projection Analysis" >> $GITHUB_STEP_SUMMARY

          # Set environment-specific budget limits and usage multipliers (matching Terraform defaults)
          case "${{ needs.info.outputs.environment }}" in
            "dev")
              BUDGET_LIMIT=50
              ENV_MULTIPLIER=0.7
              S3_STORAGE_GB=10
              CF_DATA_GB=50
              CF_REQUESTS=100000
              ;;
            "staging")
              BUDGET_LIMIT=75
              ENV_MULTIPLIER=0.8
              S3_STORAGE_GB=25
              CF_DATA_GB=200
              CF_REQUESTS=500000
              ;;
            "prod")
              BUDGET_LIMIT=200
              ENV_MULTIPLIER=1.0
              S3_STORAGE_GB=100
              CF_DATA_GB=2000
              CF_REQUESTS=5000000
              ;;
            *)
              BUDGET_LIMIT=100
              ENV_MULTIPLIER=0.5
              S3_STORAGE_GB=50
              CF_DATA_GB=500
              CF_REQUESTS=1000000
              ;;
          esac

          echo "### ðŸŽ¯ Infrastructure-aware cost calculation for ${{ needs.info.outputs.environment }} environment" >> $GITHUB_STEP_SUMMARY

          # S3 Storage costs (matching Terraform cost projection module)
          S3_STORAGE_COST=$(echo "scale=2; $S3_STORAGE_GB * 0.023" | bc)
          S3_REPLICATION_COST=$(echo "scale=2; $S3_STORAGE_GB * 0.023" | bc)  # Cross-region replication enabled by default
          S3_ACCESS_LOGS_COST=$(echo "scale=2; 1 * 0.023" | bc)  # Access logging enabled by default
          S3_REQUESTS_COST=$(echo "scale=3; ($ENV_MULTIPLIER * 1000 * 0.0004 / 1000) + ($ENV_MULTIPLIER * 100 * 0.005 / 1000)" | bc)

          # CloudFront costs
          CF_DATA_COST=$(echo "scale=2; $CF_DATA_GB * 0.085" | bc)
          CF_REQUESTS_COST=$(echo "scale=3; $CF_REQUESTS * 0.010 / 10000" | bc)  # HTTPS requests

          # WAF costs (matching Terraform: WebACL + 5 rules + processing)
          WAF_WEB_ACL_COST=5.00
          WAF_RULES_COST=$(echo "scale=2; 5 * 1.00" | bc)  # 5 rules at $1 each
          WAF_REQUESTS_PROCESSED=$(echo "scale=2; ($CF_REQUESTS / 1000000) * 0.60" | bc)
          WAF_RULE_EVALUATIONS=$(echo "scale=2; ($CF_REQUESTS / 1000000) * 5 * 0.06" | bc)
          WAF_COST=$(echo "scale=2; $WAF_WEB_ACL_COST + $WAF_RULES_COST + $WAF_REQUESTS_PROCESSED + $WAF_RULE_EVALUATIONS" | bc)

          # Route53 costs (conditional - default disabled)
          ROUTE53_HOSTED_ZONE_COST=0.50
          ROUTE53_QUERIES_MILLIONS=$(echo "scale=2; $ENV_MULTIPLIER * 0.5" | bc)  # Realistic query estimate
          ROUTE53_QUERIES_COST=$(echo "scale=2; $ROUTE53_QUERIES_MILLIONS * 0.40" | bc)
          ROUTE53_COST=0.00  # Disabled by default in Terraform

          # KMS costs (enabled by default)
          KMS_KEY_COST=1.00
          KMS_REQUESTS_COST=$(echo "scale=2; ($ENV_MULTIPLIER * 10 / 10) * 0.03" | bc)  # 10k requests per month estimated
          KMS_COST=$(echo "scale=2; $KMS_KEY_COST + $KMS_REQUESTS_COST" | bc)

          # CloudWatch costs (with free tiers)
          CW_LOG_INGESTION_GB=$(echo "scale=2; $ENV_MULTIPLIER * 10" | bc)  # More realistic log volume
          CW_LOG_INGESTION_COST=$(echo "scale=2; if ($CW_LOG_INGESTION_GB > 5) ($CW_LOG_INGESTION_GB - 5) * 0.50 else 0" | bc -l)
          CW_LOG_STORAGE_COST=$(echo "scale=2; if ($CW_LOG_INGESTION_GB > 5) ($CW_LOG_INGESTION_GB - 5) * 0.03 else 0" | bc -l)
          CW_CUSTOM_METRICS=25
          CW_CUSTOM_METRICS_COST=$(echo "scale=2; if ($CW_CUSTOM_METRICS > 10) ($CW_CUSTOM_METRICS - 10) * 0.30 else 0" | bc -l)
          CW_DASHBOARDS=2
          CW_DASHBOARD_COST=$(echo "scale=2; if ($CW_DASHBOARDS > 3) ($CW_DASHBOARDS - 3) * 3.00 else 0" | bc -l)
          CW_ALARMS=15
          CW_ALARMS_COST=$(echo "scale=2; if ($CW_ALARMS > 10) ($CW_ALARMS - 10) * 0.10 else 0" | bc -l)
          CW_COST=$(echo "scale=2; $CW_LOG_INGESTION_COST + $CW_LOG_STORAGE_COST + $CW_CUSTOM_METRICS_COST + $CW_DASHBOARD_COST + $CW_ALARMS_COST" | bc)

          # SNS costs (very minimal)
          SNS_REQUESTS_COST=$(echo "scale=3; $ENV_MULTIPLIER * 0.01 * 0.50" | bc)  # Minimal request volume
          SNS_EMAIL_COST=0.02  # Estimated email notifications cost
          SNS_COST=$(echo "scale=2; $SNS_REQUESTS_COST + $SNS_EMAIL_COST" | bc)

          # Calculate total monthly cost
          MONTHLY_COST=$(echo "scale=2; $S3_STORAGE_COST + $S3_REPLICATION_COST + $S3_ACCESS_LOGS_COST + $S3_REQUESTS_COST + $CF_DATA_COST + $CF_REQUESTS_COST + $WAF_COST + $ROUTE53_COST + $KMS_COST + $CW_COST + $SNS_COST" | bc)
          ANNUAL_COST=$(echo "scale=2; $MONTHLY_COST * 12" | bc)

          # Display cost breakdown
          echo "### ðŸ’° Detailed Cost Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Storage Services:**" >> $GITHUB_STEP_SUMMARY
          echo "- Primary Storage (${S3_STORAGE_GB}GB): \$${S3_STORAGE_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- Cross-Region Replication: \$${S3_REPLICATION_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- Access Logging: \$${S3_ACCESS_LOGS_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- Request Costs: \$${S3_REQUESTS_COST}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront CDN:**" >> $GITHUB_STEP_SUMMARY
          echo "- Data Transfer (${CF_DATA_GB}GB): \$${CF_DATA_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- HTTPS Requests (${CF_REQUESTS}): \$${CF_REQUESTS_COST}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security & Monitoring:**" >> $GITHUB_STEP_SUMMARY
          echo "- WAF (Web ACL + Rules + Processing): \$${WAF_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- KMS Encryption: \$${KMS_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- CloudWatch (incl. free tiers): \$${CW_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- SNS Notifications: \$${SNS_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- Route53 DNS: \$${ROUTE53_COST} (disabled)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculate budget utilization
          BUDGET_UTILIZATION=$(echo "$MONTHLY_COST * 100 / $BUDGET_LIMIT" | bc -l)
          BUDGET_UTILIZATION_INT=${BUDGET_UTILIZATION%.*}

          # Determine budget status
          if [ "$BUDGET_UTILIZATION_INT" -ge 100 ]; then
            BUDGET_STATUS="critical"
            BUDGET_EMOJI="ðŸ”´"
            BUDGET_MESSAGE="CRITICAL: Cost exceeds budget!"
          elif [ "$BUDGET_UTILIZATION_INT" -ge 80 ]; then
            BUDGET_STATUS="warning"
            BUDGET_EMOJI="ðŸŸ¡"
            BUDGET_MESSAGE="WARNING: Approaching budget limit"
          else
            BUDGET_STATUS="healthy"
            BUDGET_EMOJI="ðŸŸ¢"
            BUDGET_MESSAGE="HEALTHY: Within budget"
          fi

          # Display summary in GitHub Actions
          echo "### ðŸ’° Cost Projection Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Monthly Cost | \$${MONTHLY_COST} |" >> $GITHUB_STEP_SUMMARY
          echo "| Annual Cost | \$${ANNUAL_COST} |" >> $GITHUB_STEP_SUMMARY
          echo "| Budget Limit | \$${BUDGET_LIMIT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Utilization | ${BUDGET_UTILIZATION_INT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${BUDGET_EMOJI} ${BUDGET_MESSAGE} |" >> $GITHUB_STEP_SUMMARY

          # Create cost report file
          echo "# ðŸ’° AWS Cost Projection Report" > cost-projection-report.md
          echo "" >> cost-projection-report.md
          echo "Environment ${{ needs.info.outputs.environment }} - Build ID ${{ needs.info.outputs.build_id }}" >> cost-projection-report.md
          echo "Generated \$(date -u)" >> cost-projection-report.md
          echo "" >> cost-projection-report.md
          echo "## ðŸ“Š Cost Summary" >> cost-projection-report.md
          echo "| Monthly Cost | \$\${MONTHLY_COST} USD |" >> cost-projection-report.md
          echo "| Annual Projection | \$\${ANNUAL_COST} USD |" >> cost-projection-report.md
          echo "| Budget Limit | \$\${BUDGET_LIMIT} USD |" >> cost-projection-report.md
          echo "| Budget Utilization | \${BUDGET_UTILIZATION_INT}% |" >> cost-projection-report.md
          echo "" >> cost-projection-report.md
          echo "## ðŸš¦ Budget Status" >> cost-projection-report.md
          echo "\${BUDGET_EMOJI} \${BUDGET_MESSAGE}" >> cost-projection-report.md
          echo "" >> cost-projection-report.md
          echo "---" >> cost-projection-report.md
          echo "Cost projections based on AWS us-east-1 pricing and estimated usage patterns" >> cost-projection-report.md

          # Create JSON report
          echo "{" > cost-projection.json
          echo "  \"environment\": \"${{ needs.info.outputs.environment }}\"," >> cost-projection.json
          echo "  \"build_id\": \"${{ needs.info.outputs.build_id }}\"," >> cost-projection.json
          echo "  \"timestamp\": \"\$(date -u -Iseconds)\"," >> cost-projection.json
          echo "  \"costs\": {" >> cost-projection.json
          echo "    \"monthly_usd\": \${MONTHLY_COST}," >> cost-projection.json
          echo "    \"annual_usd\": \${ANNUAL_COST}" >> cost-projection.json
          echo "  }," >> cost-projection.json
          echo "  \"budget\": {" >> cost-projection.json
          echo "    \"limit_usd\": \${BUDGET_LIMIT}," >> cost-projection.json
          echo "    \"utilization_percent\": \${BUDGET_UTILIZATION_INT}," >> cost-projection.json
          echo "    \"status\": \"\${BUDGET_STATUS}\"" >> cost-projection.json
          echo "  }" >> cost-projection.json
          echo "}" >> cost-projection.json

          # Set outputs
          echo "monthly_cost=${MONTHLY_COST}" >> $GITHUB_OUTPUT
          echo "budget_status=${BUDGET_STATUS}" >> $GITHUB_OUTPUT
          echo "cost_report_available=true" >> $GITHUB_OUTPUT

      - name: Upload Cost Reports
        if: steps.calculate.outputs.cost_report_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cost-projection-${{ needs.info.outputs.build_id }}
          path: |
            terraform/cost-projection-report.md
            terraform/cost-projection.json
            terraform/plan-output.txt
          retention-days: 30

  artifacts:
    name: "ðŸ“¦ Create Artifacts"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [info, infrastructure, security-analysis, website, cost-projection]
    if: always() && !failure()
    outputs:
      artifacts_created: ${{ steps.create.outputs.created }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Artifacts
        id: create
        run: |
          echo "## ðŸ“¦ Creating Build Artifacts" >> $GITHUB_STEP_SUMMARY

          # Create website archive
          if [ -d "src" ]; then
            tar -czf website-${{ needs.info.outputs.build_id }}.tar.gz -C src .
            echo "âœ… Website archive created" >> $GITHUB_STEP_SUMMARY
          fi

          # Create terraform archive
          if [ -d "terraform" ]; then
            tar -czf terraform-${{ needs.info.outputs.build_id }}.tar.gz terraform/
            echo "âœ… Terraform archive created" >> $GITHUB_STEP_SUMMARY
          fi

          echo "created=true" >> $GITHUB_OUTPUT

      - name: Download Security Results
        if: needs.security-checkov.result == 'success' || needs.security-trivy.result == 'success'
        uses: actions/download-artifact@v4
        with:
          pattern: '*-results-${{ needs.info.outputs.build_id }}'
          merge-multiple: true

      - name: Download Cost Projection
        if: needs.cost-projection.result == 'success'
        uses: actions/download-artifact@v4
        with:
          pattern: 'cost-projection-${{ needs.info.outputs.build_id }}'
          merge-multiple: true

      - name: Upload Artifacts
        if: steps.create.outputs.created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ needs.info.outputs.build_id }}
          path: |
            website-*.tar.gz
            terraform-*.tar.gz
            *-security-summary.md
            checkov-results.json
            trivy-results.json
            cost-projection-report.md
            cost-projection.json
          retention-days: 7

      - name: Build Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.infrastructure.result == 'success' && 'âœ… Validated' || needs.infrastructure.result == 'skipped' && 'âž– No changes' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "| Website | ${{ needs.website.result == 'success' && 'âœ… Validated' || needs.website.result == 'skipped' && 'âž– No changes' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-analysis.result == 'success' && 'ðŸ”’ Enhanced Analysis - Passed' || needs.security-analysis.result == 'skipped' && 'âž– Skipped' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "| Cost Projection | ${{ needs.cost-projection.result == 'success' && 'ðŸ’° Projected' || needs.cost-projection.result == 'skipped' && 'âž– Skipped' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "| Artifacts | ${{ steps.create.outputs.created == 'true' && 'âœ… Created' || 'âž– None needed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check overall status
          FAILED_JOBS=""
          if [ "${{ needs.infrastructure.result }}" = "failure" ]; then FAILED_JOBS="${FAILED_JOBS}Infrastructure "; fi
          if [ "${{ needs.security-analysis.result }}" = "failure" ]; then FAILED_JOBS="${FAILED_JOBS}Security "; fi
          if [ "${{ needs.website.result }}" = "failure" ]; then FAILED_JOBS="${FAILED_JOBS}Website "; fi
          if [ "${{ needs.cost-projection.result }}" = "failure" ]; then FAILED_JOBS="${FAILED_JOBS}Cost-Projection "; fi

          if [ -z "$FAILED_JOBS" ]; then
            echo "ðŸŽ‰ **BUILD Successful** - Ready for TEST phase" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **BUILD Failed** - Failed jobs: $FAILED_JOBS" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
