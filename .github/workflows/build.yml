name: BUILD - Code Validation and Artifact Creation

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: false
        type: choice
        options: [dev, staging, prod]
        default: dev
      force_build:
        description: 'Force build all components'
        required: false
        type: boolean
        default: false
  pull_request:
    branches: [main]
  push:
    branches: [main, 'feature/*', 'bugfix/*', 'hotfix/*']

permissions:
  id-token: write
  contents: read
  pull-requests: write
  security-events: write

env:
  AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
  OPENTOFU_VERSION: ${{ vars.OPENTOFU_VERSION }}
  TF_IN_AUTOMATION: true
  TF_CLI_ARGS: "-no-color"

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  info:
    name: "ðŸ“‹ Build Information"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      build_id: ${{ steps.info.outputs.build_id }}
      environment: ${{ steps.info.outputs.environment }}
      has_terraform_changes: ${{ steps.changes.outputs.terraform }}
      has_content_changes: ${{ steps.changes.outputs.content }}
      has_workflow_changes: ${{ steps.changes.outputs.workflows }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build Info
        id: info
        run: |
          BUILD_ID="build-${{ github.run_id }}-${{ github.run_attempt }}"
          ENV="${{ github.event.inputs.environment || 'dev' }}"

          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "environment=$ENV" >> $GITHUB_OUTPUT

          echo "# ðŸ—ï¸ BUILD Phase" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID**: $BUILD_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENV" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

      - name: Detect Changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            terraform:
              - 'terraform/**'
            content:
              - 'src/**'
            workflows:
              - '.github/workflows/**'
            docs:
              - '**/*.md'
            tests:
              - 'test/**'

  infrastructure:
    name: "ðŸ—ï¸ Infrastructure Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: info
    if: needs.info.outputs.has_terraform_changes == 'true' || github.event.inputs.force_build == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Infrastructure Tools
        run: |
          echo "## ðŸ”§ Infrastructure Tools Setup" >> $GITHUB_STEP_SUMMARY

          # Install OpenTofu
          curl -L -o /tmp/tofu.zip https://github.com/opentofu/opentofu/releases/download/v${{ env.OPENTOFU_VERSION }}/tofu_${{ env.OPENTOFU_VERSION }}_linux_amd64.zip
          unzip -q /tmp/tofu.zip -d /tmp
          sudo mv /tmp/tofu /usr/local/bin/
          echo "âœ… OpenTofu installed: $(tofu version)" >> $GITHUB_STEP_SUMMARY

      - name: Validate Terraform
        working-directory: terraform
        run: |
          echo "## âœ… Terraform Validation" >> $GITHUB_STEP_SUMMARY

          # Format check
          if tofu fmt -check -recursive; then
            echo "âœ… Format check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Format check failed - run 'tofu fmt -recursive'" >> $GITHUB_STEP_SUMMARY
            echo "**Files needing formatting:**" >> $GITHUB_STEP_SUMMARY
            tofu fmt -recursive -diff | head -20 >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Initialize without backend for validation
          cp backend.tf backend.tf.bak 2>/dev/null || true
          rm -f backend.tf

          if tofu init -backend=false; then
            echo "âœ… Init successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Init failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Validate configuration
          if tofu validate; then
            echo "âœ… Validation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Validation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Restore backend file
          mv backend.tf.bak backend.tf 2>/dev/null || true

  security-checkov:
    name: "ðŸ”’ Checkov Security Scan"
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: info
    if: needs.info.outputs.has_terraform_changes == 'true' || github.event.inputs.force_build == 'true'
    outputs:
      checkov_exit: ${{ steps.scan.outputs.checkov_exit }}
      checkov_critical: ${{ steps.scan.outputs.checkov_critical }}
      checkov_high: ${{ steps.scan.outputs.checkov_high }}
      checkov_total: ${{ steps.scan.outputs.checkov_total }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Checkov
        run: |
          echo "## ðŸ”§ Checkov Setup" >> $GITHUB_STEP_SUMMARY
          pip3 install checkov --quiet
          echo "âœ… Checkov installed: $(checkov --version)" >> $GITHUB_STEP_SUMMARY


      - name: Security Scanning - Checkov
        id: scan
        run: |
          echo "## ðŸ”’ Checkov Security Analysis" >> $GITHUB_STEP_SUMMARY

          # Run Checkov with JSON output
          checkov -d terraform --framework terraform --output json -o checkov-results.json --skip-check CKV_AWS_20,CKV_AWS_117 --quiet || CHECKOV_EXIT=$?

          # Set default exit code if not set
          CHECKOV_EXIT=${CHECKOV_EXIT:-0}

          # Debug: Check if file was created
          if [ ! -f "checkov-results.json" ]; then
            echo "âš ï¸ Checkov results file not created, running with CLI output..." >> $GITHUB_STEP_SUMMARY
            checkov -d terraform --framework terraform --output cli --skip-check CKV_AWS_20,CKV_AWS_117 > checkov-cli.txt 2>&1 || true
            echo '{"results": {"passed_checks": [], "failed_checks": []}}' > checkov-results.json
          fi

          # Parse and display results
          if [ -f "checkov-results.json" ]; then
            # Count findings by severity
            CRITICAL_COUNT=$(jq '[.results.failed_checks[]? | select(.severity == "CRITICAL")] | length' checkov-results.json 2>/dev/null || echo "0")
            HIGH_COUNT=$(jq '[.results.failed_checks[]? | select(.severity == "HIGH")] | length' checkov-results.json 2>/dev/null || echo "0")
            MEDIUM_COUNT=$(jq '[.results.failed_checks[]? | select(.severity == "MEDIUM")] | length' checkov-results.json 2>/dev/null || echo "0")
            LOW_COUNT=$(jq '[.results.failed_checks[]? | select(.severity == "LOW")] | length' checkov-results.json 2>/dev/null || echo "0")
            TOTAL_FAILED=$(jq '.results.failed_checks | length' checkov-results.json 2>/dev/null || echo "0")
            TOTAL_PASSED=$(jq '.results.passed_checks | length' checkov-results.json 2>/dev/null || echo "0")

            # If no severity classification, treat all as medium
            if [ "$CRITICAL_COUNT" = "0" ] && [ "$HIGH_COUNT" = "0" ] && [ "$MEDIUM_COUNT" = "0" ] && [ "$LOW_COUNT" = "0" ] && [ "$TOTAL_FAILED" -gt "0" ]; then
              MEDIUM_COUNT=$TOTAL_FAILED
            fi

            TOTAL_FINDINGS=$((CRITICAL_COUNT + HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))

            # Display detailed results
            echo "### ðŸ“Š Checkov Results Summary" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ **Critical**: $CRITICAL_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ  **High**: $HIGH_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ **Medium**: $MEDIUM_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”µ **Low**: $LOW_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Passed**: $TOTAL_PASSED checks" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Issues**: $TOTAL_FINDINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show sample findings if any exist
            if [ "$TOTAL_FINDINGS" -gt "0" ]; then
              echo "### ðŸ” Sample Checkov Findings (Top 5)" >> $GITHUB_STEP_SUMMARY
              jq -r '.results.failed_checks[]? | "- **" + (.check_id // "Unknown") + "**: " + (.check_name // "No description") + " (File: " + (.file_path // "Unknown") + ")"' checkov-results.json 2>/dev/null | head -5 >> $GITHUB_STEP_SUMMARY || echo "- No detailed findings available" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Checkov results file not found" >> $GITHUB_STEP_SUMMARY
            CHECKOV_EXIT=1
          fi

          # Create summary artifact
          cat > checkov-security-summary.md << EOF
          # Checkov Security Analysis Report

          **Build ID**: ${{ needs.info.outputs.build_id }}
          **Scan Date**: $(date -u)
          **Status**: $([ $CHECKOV_EXIT -eq 0 ] && echo "PASSED" || echo "FAILED")

          ## Summary
          - **Critical**: $CRITICAL_COUNT
          - **High**: $HIGH_COUNT
          - **Medium**: $MEDIUM_COUNT
          - **Low**: $LOW_COUNT
          - **Total Issues**: $TOTAL_FINDINGS
          - **Passed Checks**: $TOTAL_PASSED
          EOF

          # Set output for next steps
          echo "checkov_exit=$CHECKOV_EXIT" >> $GITHUB_OUTPUT
          echo "checkov_critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "checkov_high=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "checkov_total=$TOTAL_FINDINGS" >> $GITHUB_OUTPUT

          # Determine success based on actual findings, not exit code
          if [ "$CRITICAL_COUNT" -eq "0" ] && [ "$HIGH_COUNT" -eq "0" ]; then
            echo "âœ… **Checkov scan completed successfully - No critical or high severity issues found**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Checkov found security issues** (Critical: $CRITICAL_COUNT, High: $HIGH_COUNT)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Checkov Results
        uses: actions/upload-artifact@v4
        with:
          name: checkov-results-${{ needs.info.outputs.build_id }}
          path: |
            checkov-security-summary.md
            checkov-results.json
          retention-days: 7

  security-trivy:
    name: "ðŸ›¡ï¸ Trivy Security Scan"
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: info
    if: needs.info.outputs.has_terraform_changes == 'true' || github.event.inputs.force_build == 'true'
    outputs:
      trivy_exit: ${{ steps.scan.outputs.trivy_exit }}
      trivy_critical: ${{ steps.scan.outputs.trivy_critical }}
      trivy_high: ${{ steps.scan.outputs.trivy_high }}
      trivy_total: ${{ steps.scan.outputs.trivy_total }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Trivy
        run: |
          echo "## ðŸ”§ Trivy Setup" >> $GITHUB_STEP_SUMMARY
          wget -qO- https://github.com/aquasecurity/trivy/releases/download/v0.48.3/trivy_0.48.3_Linux-64bit.tar.gz | tar xzf - -C /tmp
          sudo mv /tmp/trivy /usr/local/bin/
          echo "âœ… Trivy installed: $(trivy --version)" >> $GITHUB_STEP_SUMMARY

      - name: Security Scanning - Trivy
        id: scan
        run: |
          echo "## ðŸ›¡ï¸ Trivy Security Analysis" >> $GITHUB_STEP_SUMMARY
          
          # Debug ignore file status
          if [ -f ".trivyignore" ]; then
            echo "âœ… Found .trivyignore file with $(wc -l < .trivyignore) lines" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ Ignored items: $(grep -v '^#' .trivyignore | grep -v '^$' | wc -l) rules" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No .trivyignore file found" >> $GITHUB_STEP_SUMMARY
          fi

          # Run Trivy with JSON output (uses .trivyignore automatically if present)
          if trivy fs --security-checks vuln,config --format json --output trivy-results.json terraform/; then
            TRIVY_EXIT=0
          else
            TRIVY_EXIT=1
          fi

          # Parse and display results
          if [ -f "trivy-results.json" ]; then
            # Count findings by severity
            CRITICAL_COUNT=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "CRITICAL")] | length' trivy-results.json 2>/dev/null || echo "0")
            HIGH_COUNT=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "HIGH")] | length' trivy-results.json 2>/dev/null || echo "0")
            MEDIUM_COUNT=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "MEDIUM")] | length' trivy-results.json 2>/dev/null || echo "0")
            LOW_COUNT=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "LOW")] | length' trivy-results.json 2>/dev/null || echo "0")
            TOTAL_FINDINGS=$((CRITICAL_COUNT + HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))

            # Display detailed results
            echo "### ðŸ“Š Trivy Results Summary" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ **Critical**: $CRITICAL_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ  **High**: $HIGH_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ **Medium**: $MEDIUM_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”µ **Low**: $LOW_COUNT findings" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Issues**: $TOTAL_FINDINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show sample findings if any exist
            if [ "$TOTAL_FINDINGS" -gt "0" ]; then
              echo "### ðŸ” Sample Trivy Findings (Top 5)" >> $GITHUB_STEP_SUMMARY
              jq -r '.Results[]?.Misconfigurations[]? | "- **" + (.ID // "Unknown") + "**: " + (.Title // "No description") + " (Severity: " + (.Severity // "Unknown") + ")"' trivy-results.json 2>/dev/null | head -5 >> $GITHUB_STEP_SUMMARY || echo "- No detailed findings available" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Trivy results file not found" >> $GITHUB_STEP_SUMMARY
            TRIVY_EXIT=1
          fi

          # Create summary artifact
          cat > trivy-security-summary.md << EOF
          # Trivy Security Analysis Report

          **Build ID**: ${{ needs.info.outputs.build_id }}
          **Scan Date**: $(date -u)
          **Status**: $([ $TRIVY_EXIT -eq 0 ] && echo "PASSED" || echo "FAILED")

          ## Summary
          - **Critical**: $CRITICAL_COUNT
          - **High**: $HIGH_COUNT
          - **Medium**: $MEDIUM_COUNT
          - **Low**: $LOW_COUNT
          - **Total Issues**: $TOTAL_FINDINGS
          EOF

          # Set output for next steps
          echo "trivy_exit=$TRIVY_EXIT" >> $GITHUB_OUTPUT
          echo "trivy_critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "trivy_high=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "trivy_total=$TOTAL_FINDINGS" >> $GITHUB_OUTPUT

          if [ $TRIVY_EXIT -eq 0 ]; then
            echo "âœ… **Trivy scan completed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Trivy found security issues**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Trivy Results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-${{ needs.info.outputs.build_id }}
          path: |
            trivy-security-summary.md
            trivy-results.json
          retention-days: 7

  security-analysis:
    name: "ðŸ“Š Security Analysis"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [info, security-checkov, security-trivy]
    if: always() && (needs.security-checkov.result != 'skipped' || needs.security-trivy.result != 'skipped')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process Security Results
        run: |
          echo "## ðŸ Security Results Summary" >> $GITHUB_STEP_SUMMARY

          # Get results from previous steps
          CHECKOV_EXIT="${{ needs.security-checkov.outputs.checkov_exit || '0' }}"
          TRIVY_EXIT="${{ needs.security-trivy.outputs.trivy_exit || '0' }}"
          CHECKOV_CRITICAL="${{ needs.security-checkov.outputs.checkov_critical || '0' }}"
          TRIVY_CRITICAL="${{ needs.security-trivy.outputs.trivy_critical || '0' }}"
          CHECKOV_HIGH="${{ needs.security-checkov.outputs.checkov_high || '0' }}"
          TRIVY_HIGH="${{ needs.security-trivy.outputs.trivy_high || '0' }}"

          TOTAL_CRITICAL=$((CHECKOV_CRITICAL + TRIVY_CRITICAL))
          TOTAL_HIGH=$((CHECKOV_HIGH + TRIVY_HIGH))
          SECURITY_ERRORS=0

          # Apply blocking logic for critical/high findings
          if [ $TOTAL_CRITICAL -gt 0 ]; then
            echo "ðŸ”´ **CRITICAL SECURITY ISSUES**: $TOTAL_CRITICAL findings" >> $GITHUB_STEP_SUMMARY
            SECURITY_ERRORS=$((SECURITY_ERRORS + 1))
          fi

          if [ $TOTAL_HIGH -gt 0 ]; then
            echo "ðŸŸ  **HIGH SECURITY ISSUES**: $TOTAL_HIGH findings" >> $GITHUB_STEP_SUMMARY
            SECURITY_ERRORS=$((SECURITY_ERRORS + 1))
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Overall Security Status" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status | Critical | High |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov | $([ $CHECKOV_CRITICAL -eq 0 ] && [ $CHECKOV_HIGH -eq 0 ] && echo "âœ… PASS" || echo "âŒ FAIL") | $CHECKOV_CRITICAL | $CHECKOV_HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy   | $([ $TRIVY_EXIT -eq 0 ] && echo "âœ… PASS" || echo "âŒ FAIL") | $TRIVY_CRITICAL | $TRIVY_HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$([ $SECURITY_ERRORS -eq 0 ] && echo "âœ… PASS" || echo "âŒ FAIL")** | **$TOTAL_CRITICAL** | **$TOTAL_HIGH** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Final decision
          if [ $SECURITY_ERRORS -gt 0 ]; then
            echo "ðŸš¨ **BUILD FAILED** - Critical or High security findings detected" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required**: Fix security issues before deployment" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **All security scans passed** - No critical or high severity findings" >> $GITHUB_STEP_SUMMARY
          fi

  website:
    name: "ðŸŒ Website Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: info
    if: needs.info.outputs.has_content_changes == 'true' || github.event.inputs.force_build == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Website Content
        run: |
          echo "## ðŸŒ Website Content Validation" >> $GITHUB_STEP_SUMMARY

          # Check required files
          REQUIRED_FILES=("src/index.html" "src/404.html" "src/robots.txt")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ $file missing" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          done

          # Basic HTML validation
          if command -v html5validator >/dev/null 2>&1 || pip3 install html5validator --quiet; then
            if html5validator --root src/ --also-check-css; then
              echo "âœ… HTML validation passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ HTML validation warnings (non-blocking)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  cost-projection:
    name: "ðŸ“Š Cost Projection"
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: [info, infrastructure]
    if: needs.info.outputs.has_terraform_changes == 'true' || github.event.inputs.force_build == 'true'
    outputs:
      monthly_cost: ${{ steps.calculate.outputs.monthly_cost }}
      budget_status: ${{ steps.calculate.outputs.budget_status }}
      cost_report_available: ${{ steps.calculate.outputs.cost_report_available }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Calculate Cost Projection
        id: calculate
        run: |
          echo "## ðŸ“Š Cost Projection Analysis" >> $GITHUB_STEP_SUMMARY

          # Set environment-specific budget limits and usage multipliers
          case "${{ needs.info.outputs.environment }}" in
            "dev")
              BUDGET_LIMIT=50
              ENV_MULTIPLIER=0.1
              ;;
            "staging")
              BUDGET_LIMIT=75
              ENV_MULTIPLIER=0.3
              ;;
            "prod")
              BUDGET_LIMIT=200
              ENV_MULTIPLIER=1.0
              ;;
            *)
              BUDGET_LIMIT=100
              ENV_MULTIPLIER=0.5
              ;;
          esac

          echo "### ðŸŽ¯ Static cost calculation for ${{ needs.info.outputs.environment }} environment (${ENV_MULTIPLIER}x usage)" >> $GITHUB_STEP_SUMMARY

          # Static AWS pricing calculations
          S3_STORAGE_GB=$(echo "scale=2; 5 * $ENV_MULTIPLIER" | bc)
          S3_STORAGE_COST=$(echo "scale=2; $S3_STORAGE_GB * 0.023" | bc)
          S3_REQUESTS=$(echo "scale=0; 100000 * $ENV_MULTIPLIER" | bc)
          S3_REQUESTS_COST=$(echo "scale=3; $S3_REQUESTS * 0.0004 / 1000" | bc)
          
          CF_DATA_GB=$(echo "scale=2; 50 * $ENV_MULTIPLIER" | bc)
          CF_DATA_COST=$(echo "scale=2; $CF_DATA_GB * 0.085" | bc)
          CF_REQUESTS=$(echo "scale=0; 100000 * $ENV_MULTIPLIER" | bc)  
          CF_REQUESTS_COST=$(echo "scale=3; $CF_REQUESTS * 0.0075 / 10000" | bc)
          
          WAF_REQUESTS=$(echo "scale=0; 1000000 * $ENV_MULTIPLIER" | bc)
          WAF_COST=$(echo "scale=2; 1.0 + ($WAF_REQUESTS * 0.0000006)" | bc)
          
          ROUTE53_COST=0.50
          CW_METRICS=$(echo "scale=0; 100 * $ENV_MULTIPLIER" | bc)
          CW_COST=$(echo "scale=2; $CW_METRICS * 0.30 / 100" | bc)
          KMS_COST=1.00
          
          # Calculate total monthly cost
          MONTHLY_COST=$(echo "scale=2; $S3_STORAGE_COST + $S3_REQUESTS_COST + $CF_DATA_COST + $CF_REQUESTS_COST + $WAF_COST + $ROUTE53_COST + $CW_COST + $KMS_COST" | bc)
          ANNUAL_COST=$(echo "scale=2; $MONTHLY_COST * 12" | bc)
          
          # Display cost breakdown
          echo "### ðŸ’° Detailed Cost Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "- S3 Storage (${S3_STORAGE_GB}GB): \$${S3_STORAGE_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- S3 Requests (${S3_REQUESTS}): \$${S3_REQUESTS_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- CloudFront Data (${CF_DATA_GB}GB): \$${CF_DATA_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- CloudFront Requests (${CF_REQUESTS}): \$${CF_REQUESTS_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- WAF (${WAF_REQUESTS} requests): \$${WAF_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- Route53: \$${ROUTE53_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- CloudWatch (${CW_METRICS} metrics): \$${CW_COST}" >> $GITHUB_STEP_SUMMARY
          echo "- KMS: \$${KMS_COST}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculate budget utilization
          BUDGET_UTILIZATION=$(echo "$MONTHLY_COST * 100 / $BUDGET_LIMIT" | bc -l)
          BUDGET_UTILIZATION_INT=${BUDGET_UTILIZATION%.*}

          # Determine budget status
          if [ "$BUDGET_UTILIZATION_INT" -ge 100 ]; then
            BUDGET_STATUS="critical"
            BUDGET_EMOJI="ðŸ”´"
            BUDGET_MESSAGE="CRITICAL: Cost exceeds budget!"
          elif [ "$BUDGET_UTILIZATION_INT" -ge 80 ]; then
            BUDGET_STATUS="warning"
            BUDGET_EMOJI="ðŸŸ¡"
            BUDGET_MESSAGE="WARNING: Approaching budget limit"
          else
            BUDGET_STATUS="healthy"
            BUDGET_EMOJI="ðŸŸ¢"
            BUDGET_MESSAGE="HEALTHY: Within budget"
          fi

          # Display summary in GitHub Actions
          echo "### ðŸ’° Cost Projection Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Monthly Cost | \$${MONTHLY_COST} |" >> $GITHUB_STEP_SUMMARY
          echo "| Annual Cost | \$${ANNUAL_COST} |" >> $GITHUB_STEP_SUMMARY
          echo "| Budget Limit | \$${BUDGET_LIMIT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Utilization | ${BUDGET_UTILIZATION_INT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${BUDGET_EMOJI} ${BUDGET_MESSAGE} |" >> $GITHUB_STEP_SUMMARY

          # Create cost report file
          cat > cost-projection-report.md << 'COST_EOF'
# ðŸ’° AWS Cost Projection Report

**Environment:** ${{ needs.info.outputs.environment }} | **Build ID:** ${{ needs.info.outputs.build_id }}
**Generated:** $(date -u)

## ðŸ“Š Cost Summary
| **Monthly Cost** | $${MONTHLY_COST} USD |
| **Annual Projection** | $${ANNUAL_COST} USD |
| **Budget Limit** | $${BUDGET_LIMIT} USD |
| **Budget Utilization** | ${BUDGET_UTILIZATION_INT}% |

## ðŸš¦ Budget Status
${BUDGET_EMOJI} **${BUDGET_MESSAGE}**

---
*Cost projections based on AWS us-east-1 pricing and estimated usage patterns*
COST_EOF

          # Create JSON report
          cat > cost-projection.json << 'JSON_EOF'
{
  "environment": "${{ needs.info.outputs.environment }}",
  "build_id": "${{ needs.info.outputs.build_id }}",
  "timestamp": "$(date -u -Iseconds)",
  "costs": {
    "monthly_usd": ${MONTHLY_COST},
    "annual_usd": ${ANNUAL_COST}
  },
  "budget": {
    "limit_usd": ${BUDGET_LIMIT},
    "utilization_percent": ${BUDGET_UTILIZATION_INT},
    "status": "${BUDGET_STATUS}"
  }
}
JSON_EOF

          # Set outputs
          echo "monthly_cost=${MONTHLY_COST}" >> $GITHUB_OUTPUT
          echo "budget_status=${BUDGET_STATUS}" >> $GITHUB_OUTPUT
          echo "cost_report_available=true" >> $GITHUB_OUTPUT

      - name: Upload Cost Reports
        if: steps.calculate.outputs.cost_report_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cost-projection-${{ needs.info.outputs.build_id }}
          path: |
            terraform/cost-projection-report.md
            terraform/cost-projection.json
            terraform/plan-output.txt
          retention-days: 30

  artifacts:
    name: "ðŸ“¦ Create Artifacts"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [info, infrastructure, security-analysis, website, cost-projection]
    if: always() && !failure()
    outputs:
      artifacts_created: ${{ steps.create.outputs.created }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Artifacts
        id: create
        run: |
          echo "## ðŸ“¦ Creating Build Artifacts" >> $GITHUB_STEP_SUMMARY

          # Create website archive
          if [ -d "src" ]; then
            tar -czf website-${{ needs.info.outputs.build_id }}.tar.gz -C src .
            echo "âœ… Website archive created" >> $GITHUB_STEP_SUMMARY
          fi

          # Create terraform archive
          if [ -d "terraform" ]; then
            tar -czf terraform-${{ needs.info.outputs.build_id }}.tar.gz terraform/
            echo "âœ… Terraform archive created" >> $GITHUB_STEP_SUMMARY
          fi

          echo "created=true" >> $GITHUB_OUTPUT

      - name: Download Security Results
        if: needs.security-checkov.result == 'success' || needs.security-trivy.result == 'success'
        uses: actions/download-artifact@v4
        with:
          pattern: '*-results-${{ needs.info.outputs.build_id }}'
          merge-multiple: true

      - name: Download Cost Projection
        if: needs.cost-projection.result == 'success'
        uses: actions/download-artifact@v4
        with:
          pattern: 'cost-projection-${{ needs.info.outputs.build_id }}'
          merge-multiple: true

      - name: Upload Artifacts
        if: steps.create.outputs.created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ needs.info.outputs.build_id }}
          path: |
            website-*.tar.gz
            terraform-*.tar.gz
            *-security-summary.md
            checkov-results.json
            trivy-results.json
            cost-projection-report.md
            cost-projection.json
          retention-days: 7

      - name: Build Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.infrastructure.result == 'success' && 'âœ… Validated' || needs.infrastructure.result == 'skipped' && 'âž– No changes' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "| Website | ${{ needs.website.result == 'success' && 'âœ… Validated' || needs.website.result == 'skipped' && 'âž– No changes' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-analysis.result == 'success' && 'ðŸ”’ Enhanced Analysis - Passed' || needs.security-analysis.result == 'skipped' && 'âž– Skipped' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "| Cost Projection | ${{ needs.cost-projection.result == 'success' && 'ðŸ’° Projected' || needs.cost-projection.result == 'skipped' && 'âž– Skipped' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "| Artifacts | ${{ steps.create.outputs.created == 'true' && 'âœ… Created' || 'âž– None needed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check overall status
          FAILED_JOBS=""
          if [ "${{ needs.infrastructure.result }}" = "failure" ]; then FAILED_JOBS="${FAILED_JOBS}Infrastructure "; fi
          if [ "${{ needs.security-analysis.result }}" = "failure" ]; then FAILED_JOBS="${FAILED_JOBS}Security "; fi
          if [ "${{ needs.website.result }}" = "failure" ]; then FAILED_JOBS="${FAILED_JOBS}Website "; fi
          if [ "${{ needs.cost-projection.result }}" = "failure" ]; then FAILED_JOBS="${FAILED_JOBS}Cost-Projection "; fi

          if [ -z "$FAILED_JOBS" ]; then
            echo "ðŸŽ‰ **BUILD Successful** - Ready for TEST phase" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **BUILD Failed** - Failed jobs: $FAILED_JOBS" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
